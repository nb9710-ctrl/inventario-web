<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>PrinterAdmin - Gesti√≥n de Inventario</title>
    <!-- Google Fonts & Material Symbols -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0d7ff2",
                        "background-light": "#f5f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
    <style>
        /* Ocultar scroll cuando login est√° visible */
        body:has(#login-screen:not(.hidden)) {
            overflow: hidden;
        }
        
        /* Ocultar scrollbar en login screen */
        #login-screen {
            overflow: hidden;
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        
        .view-fade { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        .truncate-cell {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid currentColor;
            width: 18px;
            height: 18px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tooltips personalizados */
        .tooltip-wrapper { position: relative; display: inline-block; }
        .custom-tooltip {
            position: fixed;
            z-index: 9999;
            display: none;
            min-width: 200px;
            max-width: min(320px, calc(100vw - 40px));
            background: white;
            border: 2px solid #2563eb;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            pointer-events: none;
            animation: tooltipFadeIn 0.2s ease-out;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            line-height: 1.4;
        }
        .dark .custom-tooltip {
            background: #1e293b;
            border-color: #3b82f6;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(59, 130, 246, 0.2);
        }
        .tooltip-wrapper:hover .custom-tooltip { display: block; }
        .tooltip-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }
        .dark .tooltip-title { color: #94a3b8; }
        .tooltip-value {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 12px;
            word-wrap: break-word;
        }
        .dark .tooltip-value { color: #e2e8f0; }
        .tooltip-value:last-child { margin-bottom: 0; }
        .tooltip-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            margin-right: 6px;
            margin-bottom: 6px;
        }
        .badge-yes { background: #dcfce7; color: #166534; }
        .dark .badge-yes { background: #14532d; color: #86efac; }
        .badge-no { background: #f1f5f9; color: #64748b; }
        .dark .badge-no { background: #334155; color: #94a3b8; }
        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Barra de progreso circular */
        .circular-progress {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: conic-gradient(
                var(--progress-color) calc(var(--progress) * 1%),
                #e5e7eb calc(var(--progress) * 1%)
            );
        }
        .dark .circular-progress {
            background: conic-gradient(
                var(--progress-color) calc(var(--progress) * 1%),
                #374151 calc(var(--progress) * 1%)
            );
        }
        .circular-progress::before {
            content: '';
            position: absolute;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
        }
        .dark .circular-progress::before {
            background: #1a2632;
        }
        .circular-progress-text {
            position: relative;
            z-index: 1;
            font-size: 8px;
            font-weight: 900;
            color: #1e293b;
        }
        .dark .circular-progress-text {
            color: #e2e8f0;
        }
        
        /* Dropdown menu animation */
        #settings-menu, #modules-menu {
            animation: dropdownFadeIn 0.2s ease-out;
        }
        @keyframes dropdownFadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    <script>
        // Aplicar tema antes de que se muestre el contenido para evitar flash
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && true)) { // Por defecto oscuro
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
</head>
<body class="bg-background-light dark:bg-background-dark text-[#111418] dark:text-white font-display antialiased overflow-x-hidden">

<!-- Pantalla de Login -->
<!-- Pantalla de Login -->
<div id="login-screen" class="hidden fixed inset-0 z-[10000] flex items-center justify-start p-4 overflow-hidden" style="background-image: url('https://i.ibb.co/MxnztZpZ/Designer-2.png'); background-size: cover; background-position: center; background-repeat: no-repeat;">
    <!-- Overlay oscuro -->
    <div class="absolute inset-0 bg-black/70"></div>
    
    <div class="relative bg-[#1a1a1a]/60 backdrop-blur-md rounded-lg shadow-2xl w-full max-w-sm p-8 border border-gray-800 ml-20">
        <div class="flex flex-col items-center mb-10">
            <div class="w-20 h-20 mb-4">
                <svg viewBox="0 0 100 100" class="w-full h-full">
                    <circle cx="50" cy="50" r="45" fill="#dc2626" opacity="0.2"/>
                    <text x="50" y="63" text-anchor="middle" fill="#dc2626" font-size="40" font-weight="900" font-family="Inter, sans-serif">R</text>
                </svg>
            </div>
            <h1 class="text-3xl font-black text-white tracking-tight">RICOH</h1>
            <p class="text-xs text-gray-400 mt-2 uppercase tracking-widest font-semibold">Inventario Web</p>
        </div>
        
        <form id="login-form" class="space-y-5" novalidate>
            <div>
                <label for="login-email" class="block text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">Email</label>
                <div class="relative">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-[20px]" aria-hidden="true">person</span>
                    <input 
                        type="email" 
                        id="login-email" 
                        name="email"
                        required
                        autocomplete="email"
                        aria-required="true"
                        aria-invalid="false"
                        aria-describedby="email-error"
                        class="w-full pl-11 pr-4 py-3 rounded bg-[#0d0d0d] border border-gray-800 text-white placeholder-gray-600 focus:outline-none focus:border-red-600 transition-all"
                        placeholder="usuario@email.com">
                </div>
                <div id="email-error" class="hidden mt-1 text-xs text-red-400 animate-fade-in" role="alert"></div>
            </div>
            
            <div>
                <label for="login-password" class="block text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">Contrase√±a</label>
                <div class="relative">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-[20px]" aria-hidden="true">lock</span>
                    <input 
                        type="password" 
                        id="login-password" 
                        name="password"
                        required
                        autocomplete="current-password"
                        aria-required="true"
                        aria-invalid="false"
                        aria-describedby="password-error"
                        class="w-full pl-11 pr-12 py-3 rounded bg-[#0d0d0d] border border-gray-800 text-white placeholder-gray-600 focus:outline-none focus:border-red-600 transition-all"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    <button 
                        type="button" 
                        id="toggle-password" 
                        onclick="togglePasswordVisibility()" 
                        class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-red-600 rounded"
                        aria-label="Mostrar u ocultar contrase√±a"
                        tabindex="0">
                        <span class="material-symbols-outlined text-[20px]" id="password-icon" aria-hidden="true">visibility</span>
                    </button>
                </div>
                <div id="password-error" class="hidden mt-1 text-xs text-red-400 animate-fade-in" role="alert"></div>
            </div>
            
            <div class="flex items-center justify-between">
                <label class="flex items-center cursor-pointer group">
                    <input 
                        type="checkbox" 
                        id="remember-me" 
                        name="remember"
                        class="w-4 h-4 rounded bg-[#0d0d0d] border-gray-800 text-red-600 focus:ring-2 focus:ring-red-600 focus:ring-offset-0 cursor-pointer">
                    <span class="ml-2 text-xs text-gray-400 group-hover:text-gray-300 transition-colors">Recordar sesi√≥n</span>
                </label>
                <button 
                    type="button" 
                    id="forgot-password-btn"
                    onclick="showForgotPassword()"
                    class="text-xs text-red-500 hover:text-red-400 transition-colors focus:outline-none focus:underline"
                    tabindex="0">
                    ¬øOlvidaste tu contrase√±a?
                </button>
            </div>
            
            <button 
                type="submit" 
                id="login-btn"
                class="w-full bg-red-600 hover:bg-red-700 disabled:bg-gray-700 disabled:cursor-not-allowed text-white font-bold py-3 rounded transition-all flex items-center justify-center gap-2 uppercase tracking-wide text-sm focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-[#1a1a1a]"
                aria-label="Iniciar sesi√≥n">
                <span id="login-btn-text">Iniciar Sesi√≥n</span>
            </button>
        </form>
        
        <div id="login-error" class="hidden mt-4 p-3 bg-red-900/30 text-red-400 rounded text-sm border border-red-800 animate-fade-in" role="alert"></div>
        
        <div id="login-success" class="hidden mt-4 p-3 bg-green-900/30 text-green-400 rounded text-sm border border-green-800 animate-fade-in" role="alert">
            ‚úÖ Inicio de sesi√≥n exitoso. Cargando...
        </div>
    </div>
</div>

<!-- Modal Recuperar Contrase√±a -->
<div id="forgot-password-modal" class="hidden fixed inset-0 bg-black/80 z-[10001] flex items-center justify-center p-4">
    <div class="relative bg-[#1a1a1a] rounded-lg shadow-2xl w-full max-w-md p-8 border border-gray-800">
        <button 
            onclick="closeForgotPassword()" 
            class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors focus:outline-none focus:ring-2 focus:ring-red-600 rounded"
            aria-label="Cerrar">
            <span class="material-symbols-outlined">close</span>
        </button>
        
        <h2 class="text-2xl font-bold text-white mb-2">¬øOlvidaste tu contrase√±a?</h2>
        <p class="text-sm text-gray-400 mb-6">Ingresa tu email y te enviaremos un enlace para restablecer tu contrase√±a.</p>
        
        <form id="forgot-password-form" class="space-y-4">
            <div>
                <label for="reset-email" class="block text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">Email</label>
                <input 
                    type="email" 
                    id="reset-email" 
                    required
                    autocomplete="email"
                    aria-required="true"
                    class="w-full px-4 py-3 rounded bg-[#0d0d0d] border border-gray-800 text-white placeholder-gray-600 focus:outline-none focus:border-red-600 transition-all"
                    placeholder="usuario@email.com">
            </div>
            
            <button 
                type="submit" 
                id="reset-btn"
                class="w-full bg-red-600 hover:bg-red-700 disabled:bg-gray-700 text-white font-bold py-3 rounded transition-all uppercase tracking-wide text-sm">
                Enviar Enlace
            </button>
        </form>
        
        <div id="reset-message" class="hidden mt-4 p-3 rounded text-sm" role="alert"></div>
    </div>
</div>

<!-- Loader inicial -->
<div id="initial-loader" class="fixed inset-0 bg-white dark:bg-[#1a2632] z-[9999] flex items-center justify-center">
    <div class="flex flex-col items-center gap-4">
        <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
        <p class="text-lg font-bold text-slate-600 dark:text-slate-300">Cargando...</p>
    </div>
</div>

<div class="relative flex min-h-screen flex-col" style="visibility: hidden;" id="main-content">
    <!-- Header -->
    <header class="sticky top-0 z-50 flex items-center justify-between border-b border-solid border-slate-200 dark:border-slate-800 bg-white dark:bg-[#1a2632] px-6 py-3 lg:px-10">
        <div class="flex items-center gap-4 cursor-pointer" onclick="goHome()" title="Recargar aplicaci√≥n">
            <div class="flex size-10 items-center justify-center rounded-lg bg-primary/10 text-primary">
                <span class="material-symbols-outlined text-[28px]">print_connect</span>
            </div>
            <h2 class="text-4xl font-black leading-tight tracking-[-0.015em] text-red-600 dark:text-red-500">RICOH</h2>
        </div>
        
        <div class="flex-1"></div>
        
        <div class="flex items-center gap-3">
            <!-- 1. Men√∫ de m√≥dulos (Inventario) -->
            <div class="relative">
                <button onclick="toggleModulesMenu()" id="modules-btn" class="flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                    <span class="material-symbols-outlined" id="current-module-icon">inventory_2</span>
                    <span class="font-bold text-sm hidden md:inline" id="current-module-name">Inventario</span>
                    <span class="material-symbols-outlined text-[18px]">expand_more</span>
                </button>
                <div id="modules-menu" class="hidden absolute right-0 mt-2 w-56 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-700 py-2 z-50">
                    <button onclick="switchTabFromMenu('inventory')" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-3">
                        <span class="material-symbols-outlined text-[20px] text-primary">inventory_2</span>
                        <span class="font-semibold text-sm">Inventario</span>
                    </button>
                    <button onclick="switchTabFromMenu('retired')" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-3">
                        <span class="material-symbols-outlined text-[20px] text-red-500">delete_sweep</span>
                        <span class="font-semibold text-sm">Retiradas</span>
                    </button>
                    <button onclick="switchTabFromMenu('toner')" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-3">
                        <span class="material-symbols-outlined text-[20px] text-purple-500">local_printshop</span>
                        <span class="font-semibold text-sm">Backup T√≥ner</span>
                    </button>
                    <button onclick="switchTabFromMenu('counters')" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-3">
                        <span class="material-symbols-outlined text-[20px] text-emerald-500">calculate</span>
                        <span class="font-semibold text-sm">Contadores</span>
                    </button>
                </div>
            </div>
            
            <!-- 2. Bot√≥n Gr√°ficas -->
            <button onclick="showChartsModal()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" title="Ver Gr√°ficas">
                <span class="material-symbols-outlined text-[24px]">monitoring</span>
            </button>
            
            <!-- 3. Men√∫ de configuraci√≥n/Descargas -->
            <div class="relative">
                <button onclick="toggleSettingsMenu()" id="settings-btn" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" title="Descargas">
                    <span class="material-symbols-outlined">download</span>
                </button>
                <div id="settings-menu" class="hidden absolute right-0 mt-2 w-64 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-700 py-2 z-50">
                    <div id="settings-menu-content">
                        <!-- Contenido din√°mico seg√∫n m√≥dulo activo -->
                    </div>
                </div>
            </div>
            
            <!-- 4. Modo oscuro -->
            <button onclick="toggleDarkMode()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" title="Cambiar tema">
                <span class="material-symbols-outlined" id="dark-mode-icon">dark_mode</span>
            </button>
            
            <!-- Separador visual -->
            <div class="h-8 w-px bg-slate-300 dark:bg-slate-700 hidden md:block"></div>
            
            <!-- 5. Usuario + Bot√≥n Logout -->
            <div id="user-container" class="flex items-center gap-3" style="visibility: hidden;">
                <!-- Info del usuario -->
                <div class="hidden md:flex flex-col items-end">
                    <span id="user-email" class="text-sm font-bold text-slate-700 dark:text-slate-200"></span>
                    <span id="user-role-badge" class="px-2 py-0.5 text-xs font-bold rounded uppercase"></span>
                </div>
                
                <!-- Bot√≥n Gesti√≥n de Usuarios (solo admin) -->
                <button 
                    id="users-btn" 
                    onclick="showUsersModal()" 
                    class="hidden p-2 rounded-lg hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-all text-purple-600 dark:text-purple-400" 
                    title="Gestionar Usuarios">
                    <span class="material-symbols-outlined text-[24px]">manage_accounts</span>
                </button>
                
                <!-- Bot√≥n Cerrar Sesi√≥n - Dise√±o moderno -->
                <button 
                    id="logout-btn" 
                    onclick="handleLogout()" 
                    class="group relative flex items-center gap-2 px-4 py-2 rounded-xl
                           bg-gradient-to-r from-red-500/10 to-orange-500/10 
                           hover:from-red-500/20 hover:to-orange-500/20
                           dark:from-red-500/20 dark:to-orange-500/20 
                           dark:hover:from-red-500/30 dark:hover:to-orange-500/30
                           border border-red-500/20 dark:border-red-500/30
                           backdrop-blur-sm
                           transition-all duration-300 ease-out
                           hover:scale-105 hover:shadow-lg hover:shadow-red-500/20
                           active:scale-95
                           focus:outline-none focus:ring-2 focus:ring-red-500/50 focus:ring-offset-2 dark:focus:ring-offset-slate-900" 
                    title="Cerrar Sesi√≥n"
                    aria-label="Cerrar sesi√≥n">
                    <span class="material-symbols-outlined text-[20px] text-red-600 dark:text-red-400 group-hover:text-red-500 dark:group-hover:text-red-300 transition-colors">
                        logout
                    </span>
                    <span class="hidden lg:inline text-sm font-bold text-red-600 dark:text-red-400 group-hover:text-red-500 dark:group-hover:text-red-300 transition-colors">
                        Cerrar sesi√≥n
                    </span>
                    <!-- Efecto de brillo al hover -->
                    <span class="absolute inset-0 rounded-xl bg-gradient-to-r from-red-400/0 via-red-400/10 to-orange-400/0 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></span>
                </button>
            </div>
        </div>
    </header>

    <!-- Overlay Notificaciones -->
    <div id="toast-container" class="fixed top-20 right-5 z-[100] flex flex-col gap-2"></div>

    <!-- VISTA 1: INVENTARIO -->
    <main id="inventory-view" class="view-fade flex-1 px-4 py-8 md:px-6 lg:px-10">
        <div class="mx-auto w-full">
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 pb-8">
                <div class="flex flex-col gap-2">
                    <h1 class="text-3xl font-black leading-tight tracking-[-0.033em]">Inventario General</h1>
                    <p class="text-slate-500 dark:text-slate-400">Informaci√≥n registrada de impresoras.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="showView('form')" class="flex items-center justify-center rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold shadow-md hover:bg-blue-600 transition-all">
                        <span class="material-symbols-outlined mr-2 text-[20px]">add</span> Nueva Impresora
                    </button>
                </div>
            </div>

            <!-- Gr√°ficas de estad√≠sticas -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pb-6">
                <!-- Gr√°fica: Estado de Impresora -->
                <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#1a2632] shadow-sm p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">assessment</span>
                        Estado de Impresoras
                    </h3>
                    <div class="grid grid-cols-3 gap-3">
                        <div onclick="togglePrinterStatusFilter('Operativa')" class="cursor-pointer transition-all hover:scale-105 active:scale-95 p-4 rounded-lg bg-emerald-50 dark:bg-emerald-900/20 border-2 border-transparent hover:border-emerald-500" id="chart-operativa">
                            <div class="text-3xl font-black text-emerald-600" id="count-operativa">0</div>
                            <div class="text-xs font-semibold text-emerald-700 dark:text-emerald-400 mt-1">Operativa</div>
                        </div>
                        <div onclick="togglePrinterStatusFilter('Fuera de servicio')" class="cursor-pointer transition-all hover:scale-105 active:scale-95 p-4 rounded-lg bg-red-50 dark:bg-red-900/20 border-2 border-transparent hover:border-red-500" id="chart-fuera">
                            <div class="text-3xl font-black text-red-600" id="count-fuera">0</div>
                            <div class="text-xs font-semibold text-red-700 dark:text-red-400 mt-1">Fuera de servicio</div>
                        </div>
                        <div onclick="togglePrinterStatusFilter('Sin ubicar')" class="cursor-pointer transition-all hover:scale-105 active:scale-95 p-4 rounded-lg bg-amber-50 dark:bg-amber-900/20 border-2 border-transparent hover:border-amber-500" id="chart-sinubicar">
                            <div class="text-3xl font-black text-amber-600" id="count-sinubicar">0</div>
                            <div class="text-xs font-semibold text-amber-700 dark:text-amber-400 mt-1">Sin ubicar</div>
                        </div>
                    </div>
                </div>

                <!-- Gr√°fica: Estado de T√≥ner -->
                <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#1a2632] shadow-sm p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">local_printshop</span>
                        Estado de T√≥ner
                    </h3>
                    <div class="grid grid-cols-4 gap-3">
                        <div onclick="toggleTonerStatusFilter('0-29')" class="cursor-pointer transition-all hover:scale-105 active:scale-95 p-4 rounded-lg bg-emerald-50 dark:bg-emerald-900/20 border-2 border-transparent hover:border-emerald-500" id="chart-toner-0">
                            <div class="text-3xl font-black text-emerald-600" id="count-toner-0">0</div>
                            <div class="text-xs font-semibold text-emerald-700 dark:text-emerald-400 mt-1">0-29%</div>
                        </div>
                        <div onclick="toggleTonerStatusFilter('30-49')" class="cursor-pointer transition-all hover:scale-105 active:scale-95 p-4 rounded-lg bg-yellow-50 dark:bg-yellow-900/20 border-2 border-transparent hover:border-yellow-500" id="chart-toner-30">
                            <div class="text-3xl font-black text-yellow-600" id="count-toner-30">0</div>
                            <div class="text-xs font-semibold text-yellow-700 dark:text-yellow-400 mt-1">30-49%</div>
                        </div>
                        <div onclick="toggleTonerStatusFilter('50-79')" class="cursor-pointer transition-all hover:scale-105 active:scale-95 p-4 rounded-lg bg-orange-50 dark:bg-orange-900/20 border-2 border-transparent hover:border-orange-500" id="chart-toner-50">
                            <div class="text-3xl font-black text-orange-600" id="count-toner-50">0</div>
                            <div class="text-xs font-semibold text-orange-700 dark:text-orange-400 mt-1">50-79%</div>
                        </div>
                        <div onclick="toggleTonerStatusFilter('80-100')" class="cursor-pointer transition-all hover:scale-105 active:scale-95 p-4 rounded-lg bg-red-50 dark:bg-red-900/20 border-2 border-transparent hover:border-red-500" id="chart-toner-80">
                            <div class="text-3xl font-black text-red-600" id="count-toner-80">0</div>
                            <div class="text-xs font-semibold text-red-700 dark:text-red-400 mt-1">80-100%</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#1a2632] shadow-sm overflow-hidden">
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-left text-[11px] whitespace-nowrap">
                        <thead class="bg-slate-50 dark:bg-[#23303d] border-b border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300">
                            <tr>
                                <th class="px-2 py-3 font-bold uppercase text-[10px]" style="min-width: 110px;">Serie</th>
                                <th class="px-2 py-3 font-bold uppercase text-[10px]" style="min-width: 90px;">Modelo</th>
                                <th class="px-2 py-3 font-bold uppercase text-[10px]" style="min-width: 80px;">Ciudad</th>
                                <th class="px-2 py-3 font-bold uppercase text-[10px]" style="min-width: 90px;">Dpto</th>
                                <th class="px-2 py-3 font-bold uppercase text-[10px]" style="min-width: 140px;">Direcci√≥n</th>
                                <th class="px-2 py-3 font-bold uppercase text-[10px]" style="min-width: 80px;">√Årea</th>
                                <th class="px-2 py-3 font-bold uppercase text-[10px]" style="min-width: 90px;">Contacto</th>
                                <th class="px-2 py-3 font-bold uppercase text-[10px]" style="min-width: 110px;">Estado</th>
                                <th class="px-2 py-3 font-bold uppercase text-[10px]" style="min-width: 140px;">T√≥ner</th>
                                <th class="px-2 py-3 font-bold uppercase text-center text-[10px]" style="min-width: 60px;">Acc</th>
                            </tr>
                            <tr class="bg-white dark:bg-[#1a2632]">
                                <th class="px-3 py-2">
                                    <input type="text" id="filter-serial" oninput="filterTableByColumns()" placeholder="Filtrar..." class="w-full text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary" />
                                </th>
                                <th class="px-3 py-2">
                                    <input type="text" id="filter-model" oninput="filterTableByColumns()" placeholder="Filtrar..." class="w-full text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary" />
                                </th>
                                <th class="px-3 py-2">
                                    <input type="text" id="filter-city" oninput="filterTableByColumns()" placeholder="Filtrar..." class="w-full text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary" />
                                </th>
                                <th class="px-3 py-2">
                                    <input type="text" id="filter-dept" oninput="filterTableByColumns()" placeholder="Filtrar..." class="w-full text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary" />
                                </th>
                                <th class="px-3 py-2">
                                    <input type="text" id="filter-address" oninput="filterTableByColumns()" placeholder="Filtrar..." class="w-full text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary" />
                                </th>
                                <th class="px-3 py-2">
                                    <input type="text" id="filter-area" oninput="filterTableByColumns()" placeholder="Filtrar..." class="w-full text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary" />
                                </th>
                                <th class="px-3 py-2">
                                    <input type="text" id="filter-contact" oninput="filterTableByColumns()" placeholder="Filtrar..." class="w-full text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary" />
                                </th>
                                <th class="px-3 py-2">
                                    <select id="filter-status" onchange="filterTableByColumns()" class="w-full text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary">
                                        <option value="">Todas</option>
                                        <option value="Operativa">Operativa</option>
                                        <option value="Fuera de servicio">Fuera de servicio</option>
                                        <option value="Sin ubicar">Sin ubicar</option>
                                    </select>
                                </th>
                                <th class="px-3 py-2" style="min-width: 170px;">
                                    <select id="filter-toner" onchange="filterTableByColumns()" class="w-full text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary">
                                        <option value="">Todos</option>
                                        <option value="verde">üü¢ Buen estado (0-29%)</option>
                                        <option value="amarillo">üü° Medio (30-49%)</option>
                                        <option value="naranja">üü† Pr√≥x. cambio (50-79%)</option>
                                        <option value="rojo">üî¥ Cr√≠tico (80-100%)</option>
                                    </select>
                                </th>
                                <th class="px-3 py-2" style="min-width: 80px;">
                                    <!-- Sin filtro para acciones -->
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                    </table>
                </div>
                <div class="px-6 py-4 bg-slate-50/50 dark:bg-slate-900/20 border-t border-slate-200 dark:border-slate-800">
                    <p class="text-xs text-slate-500" id="tableStats"></p>
                </div>
            </div>
        </div>
    </main>

    <!-- VISTA 2: FORMULARIO DE REGISTRO -->
    <main id="form-view" class="view-fade flex-1 hidden px-4 py-8 md:px-10 lg:px-20 xl:px-40">
        <div class="max-w-[1200px] mx-auto w-full">
            <div class="flex items-center gap-2 mb-6">
                <button onclick="showView('inventory')" class="text-primary hover:underline flex items-center gap-1 font-medium">
                    <span class="material-symbols-outlined">arrow_back</span> Volver al Inventario
                </button>
            </div>

            <h1 class="text-3xl font-black mb-8">Formulario T√©cnico de Registro</h1>

            <form id="printerRegistrationForm" class="space-y-8 pb-20">
                <!-- Secciones de Formulario -->
                <div class="bg-white dark:bg-[#1a202c] p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                    <h3 class="text-lg font-bold mb-6 flex items-center gap-2 border-b pb-2 dark:border-slate-700 text-primary">
                        <span class="material-symbols-outlined">schedule</span> Fechas y Equipo
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Fecha Registro</span>
                            <input required name="dateReg" type="date" readonly class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 cursor-not-allowed"/>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Fecha Instalaci√≥n</span>
                            <input name="dateInst" type="text" value="Instalaci√≥n pendiente" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700 text-amber-600 dark:text-amber-400 font-semibold" onfocus="if(this.value === 'Instalaci√≥n pendiente') { this.value = ''; this.type='date'; this.classList.remove('text-amber-600', 'dark:text-amber-400', 'font-semibold'); }" onblur="if(this.value === '') { this.type='text'; this.value = 'Instalaci√≥n pendiente'; this.classList.add('text-amber-600', 'dark:text-amber-400', 'font-semibold'); }"/>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">N√∫mero de Serie</span>
                            <input required name="serial" type="text" placeholder="S/N" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700 uppercase"/>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">MAC Address</span>
                            <input required name="mac" type="text" placeholder="00:00:00..." class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700 uppercase font-mono"/>
                        </label>
                        <label class="flex flex-col md:col-span-2">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Modelo</span>
                            <input required name="model" type="text" placeholder="Ej: HP LaserJet Pro..." class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                        <label class="flex flex-col md:col-span-2">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Estado de Impresora</span>
                            <select name="status" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700">
                                <option>Operativa</option>
                                <option>Fuera de servicio</option>
                                <option>Sin ubicar</option>
                            </select>
                        </label>
                    </div>
                </div>

                <div class="bg-white dark:bg-[#1a202c] p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                    <h3 class="text-lg font-bold mb-6 flex items-center gap-2 border-b pb-2 dark:border-slate-700 text-primary">
                        <span class="material-symbols-outlined">location_on</span> Ubicaci√≥n y Direcci√≥n
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Ciudad</span>
                            <input required name="city" type="text" placeholder="Ciudad" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Departamento</span>
                            <input required name="dept" type="text" placeholder="Departamento" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">√Årea</span>
                            <input required name="area" type="text" placeholder="Ej: Contabilidad" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                        <label class="flex flex-col md:col-span-3">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Direcci√≥n del Equipo</span>
                            <input required name="address" type="text" placeholder="Calle, Piso, Oficina..." class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                    </div>
                </div>

                <div class="bg-white dark:bg-[#1a202c] p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                    <h3 class="text-lg font-bold mb-6 flex items-center gap-2 border-b pb-2 dark:border-slate-700 text-primary">
                        <span class="material-symbols-outlined">settings_ethernet</span> Par√°metros de Red
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 font-mono text-sm">
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500 font-sans">IP</span>
                            <input required name="ip" type="text" placeholder="192.168.1.50" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500 font-sans">Gateway</span>
                            <input required name="gateway" type="text" placeholder="192.168.1.1" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500 font-sans">M√°scara</span>
                            <input required name="mask" type="text" placeholder="255.255.255.0" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                    </div>
                </div>

                <div class="bg-white dark:bg-[#1a202c] p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                    <h3 class="text-lg font-bold mb-6 flex items-center gap-2 border-b pb-2 dark:border-slate-700 text-primary">
                        <span class="material-symbols-outlined">contact_page</span> Contacto y Servicios
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Nombre de Contacto</span>
                            <input required name="contact" type="text" placeholder="Responsable" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Celular</span>
                            <input required name="phone" type="text" placeholder="300 000 0000" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                        <div class="md:col-span-2 flex flex-wrap gap-8 py-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="escaner" class="rounded text-primary focus:ring-primary"/>
                                <span class="font-bold text-sm">Esc√°ner</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="slnx" class="rounded text-primary focus:ring-primary"/>
                                <span class="font-bold text-sm">Slnx</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="ndd" class="rounded text-primary focus:ring-primary"/>
                                <span class="font-bold text-sm">NDD</span>
                            </label>
                        </div>
                        <label class="flex flex-col md:col-span-2">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Nota Adicional</span>
                            <textarea name="note" placeholder="Observaciones..." class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700 h-24"></textarea>
                        </label>
                    </div>
                </div>

                <div class="bg-white dark:bg-[#1a202c] p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                    <h3 class="text-lg font-bold mb-6 flex items-center gap-2 border-b pb-2 dark:border-slate-700 text-primary">
                        <span class="material-symbols-outlined">countertops</span> Contadores
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Contador Inicial</span>
                            <input name="counterInitial" type="number" placeholder="0" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                    </div>
                </div>

                <div class="flex justify-end gap-4">
                    <button type="button" onclick="showView('inventory')" class="px-8 h-12 rounded-lg bg-slate-100 dark:bg-slate-800 font-bold transition-all hover:bg-slate-200">Cancelar</button>
                    <button type="submit" id="submitBtn" class="flex items-center justify-center gap-2 px-8 h-12 rounded-lg bg-primary text-white font-bold shadow-lg transition-all hover:bg-blue-600 disabled:opacity-70 disabled:cursor-not-allowed">
                        <span id="btnText">Guardar Registro</span>
                        <div id="btnSpinner" class="hidden spinner"></div>
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- MODAL DE DETALLES -->
    <div id="details-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-[#1a202c] rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white dark:bg-[#1a202c] border-b border-slate-200 dark:border-slate-700 p-6 flex justify-between items-center">
                <h2 class="text-2xl font-black">Detalles Completos del Equipo</h2>
                <button onclick="closeDetailsModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
            <div id="details-content" class="p-6">
                <!-- Contenido din√°mico -->
            </div>
        </div>
    </div>

    <!-- MODAL DE HISTORIAL -->
    <div id="history-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-[#1a202c] rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="sticky top-0 bg-white dark:bg-[#1a202c] border-b border-slate-200 dark:border-slate-700 p-6 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-black">Historial de Tareas</h2>
                    <p class="text-sm text-slate-500 mt-1">Serial: <span id="history-serial" class="font-mono font-bold text-primary"></span></p>
                </div>
                <button onclick="closeHistoryModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div id="history-content" class="space-y-4">
                    <!-- Contenido din√°mico -->
                </div>
            </div>
            <div class="border-t border-slate-200 dark:border-slate-700 p-6 bg-slate-50 dark:bg-slate-900/50">
                <form id="add-note-form" class="space-y-3">
                    <textarea id="new-note" placeholder="Escribe una nueva nota o tarea..." class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700 h-20 resize-none" required></textarea>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="closeHistoryModal()" class="px-4 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 font-bold text-sm transition-all hover:bg-slate-200">Cancelar</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-primary text-white font-bold text-sm transition-all hover:bg-blue-600">
                            <span class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-[16px]">add</span>
                                Agregar Nota
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL DE RMA -->
    <div id="rma-modal" class="fixed inset-0 bg-black/50 z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-[#1a202c] rounded-xl shadow-2xl w-full max-w-md">
            <div class="bg-white dark:bg-[#1a202c] border-b border-slate-200 dark:border-slate-700 p-6 flex justify-between items-center">
                <h2 class="text-xl font-black">Retiro Definitivo</h2>
                <button onclick="closeRMAModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
            <form id="rma-form" class="p-6 space-y-4">
                <div>
                    <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                        Por favor introduce n√∫mero de RMA:
                    </label>
                    <input type="text" id="rma-input" placeholder="Ej: RMA-2024-001" class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700 font-mono" required />
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeRMAModal()" class="px-6 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 font-bold text-sm transition-all hover:bg-slate-200">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-red-500 text-white font-bold text-sm transition-all hover:bg-red-600 flex items-center gap-2">
                        <span class="material-symbols-outlined text-[16px]">check_circle</span>
                        Confirmar Retiro
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- VISTA 3: RETIRADAS -->
    <main id="retired-view" class="view-fade flex-1 hidden px-4 py-8 md:px-6 lg:px-10">
        <div class="mx-auto w-full">
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 pb-8">
                <div class="flex flex-col gap-2">
                    <h1 class="text-3xl font-black leading-tight tracking-[-0.033em]">Equipos Retirados</h1>
                    <p class="text-slate-500 dark:text-slate-400">Registro de equipos dados de baja.</p>
                </div>
            </div>

            <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#1a2632] shadow-sm overflow-hidden">
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-left text-[11px] whitespace-nowrap">
                        <thead class="bg-slate-50 dark:bg-[#23303d] border-b border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300">
                            <tr>
                                <th class="px-3 py-4 font-bold uppercase">Serial</th>
                                <th class="px-3 py-4 font-bold uppercase">Modelo</th>
                                <th class="px-3 py-4 font-bold uppercase">Ubicaci√≥n</th>
                                <th class="px-3 py-4 font-bold uppercase">Fecha Retiro</th>
                                <th class="px-3 py-4 font-bold uppercase">Contacto</th>
                                <th class="px-3 py-4 font-bold uppercase">RMA</th>
                                <th class="px-3 py-4 font-bold uppercase text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="retiredTableBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                    </table>
                </div>
                <div class="px-6 py-4 bg-slate-50/50 dark:bg-slate-900/20 border-t border-slate-200 dark:border-slate-800">
                    <p class="text-xs text-slate-500" id="retiredStats"></p>
                </div>
            </div>
        </div>
    </main>

    <!-- VISTA 4: BACKUP DE T√ìNER -->
    <main id="toner-view" class="view-fade flex-1 hidden px-4 py-8 md:px-6 lg:px-10">
        <div class="mx-auto w-full">
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 pb-8">
                <div class="flex flex-col gap-2">
                    <h1 class="text-3xl font-black leading-tight tracking-[-0.033em]">Backup de T√≥ner</h1>
                    <p class="text-slate-500 dark:text-slate-400">Inventario de consumibles y t√≥ners.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="showAddTonerModal()" class="flex items-center justify-center rounded-lg h-10 px-4 bg-purple-500 text-white text-sm font-bold shadow-md hover:bg-purple-600 transition-all">
                        <span class="material-symbols-outlined mr-2 text-[20px]">add</span> Agregar T√≥ner
                    </button>
                </div>
            </div>

            <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#1a2632] shadow-sm overflow-hidden">
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-left text-[11px] whitespace-nowrap">
                        <thead class="bg-slate-50 dark:bg-[#23303d] border-b border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300">
                            <tr>
                                <th class="px-3 py-4 font-bold uppercase">Elemento</th>
                                <th class="px-3 py-4 font-bold uppercase">Modelo</th>
                                <th class="px-3 py-4 font-bold uppercase">Mod. Impresora</th>
                                <th class="px-3 py-4 font-bold uppercase">Color</th>
                                <th class="px-3 py-4 font-bold uppercase">Ubicaci√≥n</th>
                                <th class="px-3 py-4 font-bold uppercase">Fecha/Registro</th>
                                <th class="px-3 py-4 font-bold uppercase">Estado</th>
                                <th class="px-3 py-4 font-bold uppercase">Observaci√≥n</th>
                                <th class="px-3 py-4 font-bold uppercase text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tonerTableBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                    </table>
                </div>
                <div class="px-6 py-4 bg-slate-50/50 dark:bg-slate-900/20 border-t border-slate-200 dark:border-slate-800">
                    <p class="text-xs text-slate-500" id="tonerStats"></p>
                </div>
            </div>
        </div>
    </main>

    <!-- VISTA 5: CONTADORES -->
    <main id="counters-view" class="view-fade flex-1 hidden px-4 py-8 md:px-6 lg:px-10">
        <div class="mx-auto w-full">
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 pb-8">
                <div class="flex flex-col gap-2">
                    <h1 class="text-3xl font-black leading-tight tracking-[-0.033em]">Contadores de Impresi√≥n</h1>
                    <p class="text-slate-500 dark:text-slate-400">Registro de contadores por equipo.</p>
                </div>
            </div>

            <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#1a2632] shadow-sm overflow-hidden">
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-left text-[11px] whitespace-nowrap">
                        <thead class="bg-slate-50 dark:bg-[#23303d] border-b border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300">
                            <tr>
                                <th class="px-3 py-4 font-bold uppercase">Serie</th>
                                <th class="px-3 py-4 font-bold uppercase">Modelo</th>
                                <th class="px-3 py-4 font-bold uppercase">B/N</th>
                                <th class="px-3 py-4 font-bold uppercase">Color</th>
                                <th class="px-3 py-4 font-bold uppercase">Total</th>
                                <th class="px-3 py-4 font-bold uppercase">Ubicaci√≥n</th>
                                <th class="px-3 py-4 font-bold uppercase text-center">Acciones</th>
                            </tr>
                            <tr class="bg-white dark:bg-[#1a2632]">
                                <th class="px-3 py-2">
                                    <input type="text" id="filter-counter-serial" oninput="filterCountersTable()" placeholder="Filtrar..." class="w-full text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary font-mono" />
                                </th>
                                <th class="px-3 py-2"></th>
                                <th class="px-3 py-2"></th>
                                <th class="px-3 py-2"></th>
                                <th class="px-3 py-2"></th>
                                <th class="px-3 py-2"></th>
                                <th class="px-3 py-2"></th>
                            </tr>
                        </thead>
                        <tbody id="countersTableBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                    </table>
                </div>
                <div class="px-6 py-4 bg-slate-50/50 dark:bg-slate-900/20 border-t border-slate-200 dark:border-slate-800">
                    <p class="text-xs text-slate-500" id="countersStats"></p>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL DE RMA -->
    <div id="rma-modal" class="fixed inset-0 bg-black/50 z-[70] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-[#1a202c] rounded-xl shadow-2xl w-full max-w-md">
            <div class="bg-white dark:bg-[#1a202c] border-b border-slate-200 dark:border-slate-700 p-6 flex justify-between items-center">
                <h2 class="text-xl font-black">Retiro Definitivo</h2>
                <button onclick="closeRMAModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
            <form id="rma-form" class="p-6 space-y-4">
                <div>
                    <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                        Por favor introduce n√∫mero de RMA:
                    </label>
                    <input type="text" id="rma-input" placeholder="Ej: RMA-2024-001" class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700 font-mono" required />
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeRMAModal()" class="px-6 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 font-bold text-sm transition-all hover:bg-slate-200">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-red-500 text-white font-bold text-sm transition-all hover:bg-red-600 flex items-center gap-2">
                        <span class="material-symbols-outlined text-[16px]">check_circle</span>
                        Confirmar Retiro
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL AGREGAR T√ìNER -->
    <div id="add-toner-modal" class="fixed inset-0 bg-black/50 z-[70] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-[#1a202c] rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white dark:bg-[#1a202c] border-b border-slate-200 dark:border-slate-700 p-6 flex justify-between items-center">
                <h2 class="text-xl font-black">Agregar T√≥ner</h2>
                <button onclick="closeAddTonerModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
            <form id="add-toner-form" class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                            Elemento
                        </label>
                        <input type="text" id="toner-elemento" placeholder="Ej: T√≥ner, Tambor, Fusor..." class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" required />
                    </div>
                    <div>
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                            Modelo
                        </label>
                        <input type="text" id="toner-modelo" placeholder="Ej: TK-5230K" class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" required />
                    </div>
                    <div>
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                            Modelo Impresora
                        </label>
                        <input type="text" id="toner-mod-impresora" placeholder="Ej: Kyocera M5521" class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" required />
                    </div>
                    <div>
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                            Color
                        </label>
                        <input type="text" id="toner-color" placeholder="Ej: Negro, Cyan, Magenta..." class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" required />
                    </div>
                    <div>
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                            Ubicaci√≥n
                        </label>
                        <input type="text" id="toner-ubicacion" placeholder="Almac√©n, Oficina..." class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" required />
                    </div>
                    <div>
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                            Fecha
                        </label>
                        <input type="date" id="toner-fecha" class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" required />
                    </div>
                    <div>
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                            Estado
                        </label>
                        <select id="toner-estado" class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" required>
                            <option value="">Seleccionar...</option>
                            <option value="Disponible">Disponible</option>
                            <option value="Usado">Usado</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                            Observaci√≥n
                        </label>
                        <textarea id="toner-observacion" placeholder="Notas adicionales..." class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700 h-20 resize-none"></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeAddTonerModal()" class="px-6 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 font-bold text-sm transition-all hover:bg-slate-200">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-purple-500 text-white font-bold text-sm transition-all hover:bg-purple-600 flex items-center gap-2">
                        <span class="material-symbols-outlined text-[16px]">add_circle</span>
                        Agregar T√≥ner
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL ASIGNAR T√ìNER A IMPRESORA -->
    <div id="assign-toner-modal" class="fixed inset-0 bg-black/50 z-[80] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-[#1a202c] rounded-xl shadow-2xl w-full max-w-md">
            <div class="bg-white dark:bg-[#1a202c] border-b border-slate-200 dark:border-slate-700 p-6 flex justify-between items-center">
                <h2 class="text-xl font-black">Asignar T√≥ner</h2>
                <button onclick="closeAssignTonerModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
            <form id="assign-toner-form" class="p-6 space-y-4">
                <div>
                    <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                        N√∫mero de serie de la impresora:
                    </label>
                    <input type="text" id="assign-printer-serial" placeholder="N√∫mero de serie..." class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700 font-mono uppercase" required />
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                            Contador B/N:
                        </label>
                        <input type="number" id="assign-counter-bn" placeholder="0" class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" min="0" required />
                    </div>
                    <div>
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                            Contador Color:
                        </label>
                        <input type="number" id="assign-counter-color" placeholder="0" class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" min="0" />
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeAssignTonerModal()" class="px-6 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 font-bold text-sm transition-all hover:bg-slate-200">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-purple-500 text-white font-bold text-sm transition-all hover:bg-purple-600 flex items-center gap-2">
                        <span class="material-symbols-outlined text-[16px]">check_circle</span>
                        Asignar T√≥ner
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL CAMBIO DE T√ìNER -->
    <div id="change-toner-modal" class="fixed inset-0 bg-black/50 z-[80] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-[#1a202c] rounded-xl shadow-2xl w-full max-w-md">
            <div class="bg-white dark:bg-[#1a202c] border-b border-slate-200 dark:border-slate-700 p-6 flex justify-between items-center">
                <h2 class="text-xl font-black">Cambio de T√≥ner</h2>
                <button onclick="closeChangeTonerModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
            <form id="change-toner-form" class="p-6 space-y-4">
                <div class="bg-primary/10 dark:bg-primary/20 p-4 rounded-lg border border-primary/30">
                    <div class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-1">Equipo seleccionado:</div>
                    <div class="text-lg font-black text-primary" id="change-toner-serial">-</div>
                    <div class="text-xs text-slate-500" id="change-toner-model">-</div>
                </div>
                <div>
                    <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                        Contador actual al momento del cambio:
                    </label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-slate-500 block mb-1">B/N</label>
                            <input type="number" id="change-counter-bn" placeholder="0" class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" min="0" required />
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 block mb-1">Color</label>
                            <input type="number" id="change-counter-color" placeholder="0" class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" min="0" />
                        </div>
                    </div>
                </div>
                <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-300 dark:border-amber-700 p-3 rounded-lg">
                    <div class="flex items-start gap-2">
                        <span class="material-symbols-outlined text-amber-600 text-[20px]">info</span>
                        <p class="text-xs text-amber-700 dark:text-amber-400">
                            El contador se ajustar√° autom√°ticamente al siguiente m√∫ltiplo del rendimiento del t√≥ner y se guardar√° el registro.
                        </p>
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeChangeTonerModal()" class="px-6 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 font-bold text-sm transition-all hover:bg-slate-200">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-primary text-white font-bold text-sm transition-all hover:bg-blue-600 flex items-center gap-2">
                        <span class="material-symbols-outlined text-[16px]">refresh</span>
                        Confirmar Cambio
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Sistema de inventario con Firebase
    // IMPORTANTE: Los datos se cargan desde Firebase al iniciar sesi√≥n
    // localStorage se usa solo como cach√© temporal

    let printers = JSON.parse(localStorage.getItem('printers_cache')) || [];
    let retired = JSON.parse(localStorage.getItem('retired_cache')) || [];
    let toners = JSON.parse(localStorage.getItem('toners_cache')) || [];
    let counters = JSON.parse(localStorage.getItem('counters_cache')) || [];
    let history = JSON.parse(localStorage.getItem('history_cache')) || {}; // {serial: [{date, note}, ...]}
    let currentTab = 'inventory';
    let currentHistorySerial = null;

    // Tabla de rendimientos de t√≥ner por modelo
    const tonerYields = {
        'IM C3500': { type: 'Color', black: 31000, color: 19000 },
        'IM C4500': { type: 'Color', black: 31000, color: 18000 },
        'MP C3004EX': { type: 'Color', black: 29500, color: 18000 },
        'MPC3003SP': { type: 'Color', black: 29500, color: 18000 },
        'MPC4503SP': { type: 'Color', black: 31000, color: 18000 },
        'MPC4504': { type: 'Color', black: 31000, color: 18000 },
        'MPC306': { type: 'Color', black: 17000, color: 10000 },
        'IM C2000': { type: 'Color', black: 15000, color: 9500 },
        'MPC2004': { type: 'Color', black: 15000, color: 9500 },
        'IM 430': { type: 'Monocromo', black: 17400, color: 0 },
        'IM 430F': { type: 'Monocromo', black: 17400, color: 0 },
        'MP 305': { type: 'Monocromo', black: 11000, color: 0 },
        'MP 401SPF': { type: 'Monocromo', black: 10000, color: 0 },
        'MP 402SPF': { type: 'Monocromo', black: 10000, color: 0 },
        'MP 501SPF': { type: 'Monocromo', black: 25000, color: 0 },
        'P 502': { type: 'Monocromo', black: 17400, color: 0 },
        'SP 4510DN': { type: 'Monocromo', black: 10000, color: 0 },
        'SP5200S': { type: 'Monocromo', black: 25000, color: 0 }
    };

    // Funci√≥n auxiliar para obtener el nombre del d√≠a de la semana en espa√±ol
    function getDayName(date) {
        const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
        return days[date.getDay()];
    }

    // Funci√≥n auxiliar para formatear fecha con d√≠a de la semana
    function formatDateWithDay(dateString) {
        if (!dateString || dateString === 'Instalaci√≥n pendiente') return 'Fecha no disponible';
        const date = new Date(dateString + 'T00:00:00');
        const dayName = getDayName(date);
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        return `${dayName}, ${day}/${month}/${year}`;
    }

    // Funci√≥n para calcular el estado del t√≥ner basado en contadores
    // F√≥rmulas:
    // 1) T√≥ners usados = Contador global / Rendimiento (parte entera)
    // 2) Porcentaje actual = (Contador/Rendimiento - ENTERO(Contador/Rendimiento)) √ó 100
    // 3) P√°ginas restantes = Rendimiento - ((Contador/Rendimiento - ENTERO(Contador/Rendimiento)) √ó Rendimiento)
    function calculateTonerStatus(serial, model) {
        // Buscar el √∫ltimo registro de contadores para este serial
        const counterRecords = counters.filter(c => c.serial && c.serial.toUpperCase() === serial.toUpperCase());

        if (counterRecords.length === 0) {
            return {
                percentage: '0.0',
                changes: 0,
                remaining: 0,
                currentCopies: 0,
                display: 'Sin datos',
                color: 'slate',
                lastChangeDate: 'Fecha no disponible',
                black: {
                    percentage: '0.0',
                    changes: 0,
                    remaining: 0,
                    currentCopies: 0,
                    color: 'slate'
                },
                colorToner: {
                    percentage: '0.0',
                    changes: 0,
                    remaining: 0,
                    currentCopies: 0,
                    color: 'slate',
                    hasColor: false
                }
            };
        }

        // Obtener rendimiento del t√≥ner para este modelo
        const yield = tonerYields[model];
        if (!yield) {
            return {
                percentage: '0.0',
                changes: 0,
                remaining: 0,
                currentCopies: 0,
                display: 'Modelo no registrado',
                color: 'slate',
                lastChangeDate: 'Fecha no disponible',
                black: {
                    percentage: '0.0',
                    changes: 0,
                    remaining: 0,
                    currentCopies: 0,
                    color: 'slate'
                },
                colorToner: {
                    percentage: '0.0',
                    changes: 0,
                    remaining: 0,
                    currentCopies: 0,
                    color: 'slate',
                    hasColor: false
                }
            };
        }

        // Tomar el √∫ltimo registro (m√°s reciente)
        const latest = counterRecords[counterRecords.length - 1];
        const counterBlack = parseFloat(latest.bn) || 0;
        const counterColor = parseFloat(latest.color) || 0;

        // C√ÅLCULOS PARA T√ìNER NEGRO
        let tonerChangesBlack = 0;
        let percentageBlack = 0;
        let remainingBlack = 0;
        
        if (yield.black > 0 && counterBlack > 0) {
            // 1) T√≥ners usados = ENTERO(Contador / Rendimiento)
            tonerChangesBlack = Math.floor(counterBlack / yield.black);
            
            // 2) Porcentaje actual = (Contador/Rendimiento - ENTERO(Contador/Rendimiento)) √ó 100
            const fractionBlack = (counterBlack / yield.black) - Math.floor(counterBlack / yield.black);
            percentageBlack = fractionBlack * 100;
            
            // 3) P√°ginas restantes = Rendimiento - (fracci√≥n √ó Rendimiento)
            remainingBlack = yield.black - (fractionBlack * yield.black);
        }

        // C√ÅLCULOS PARA T√ìNER COLOR (si aplica)
        let tonerChangesColor = 0;
        let percentageColor = 0;
        let remainingColor = 0;
        
        if (yield.color > 0 && counterColor > 0) {
            // 1) T√≥ners usados = ENTERO(Contador / Rendimiento)
            tonerChangesColor = Math.floor(counterColor / yield.color);
            
            // 2) Porcentaje actual = (Contador/Rendimiento - ENTERO(Contador/Rendimiento)) √ó 100
            const fractionColor = (counterColor / yield.color) - Math.floor(counterColor / yield.color);
            percentageColor = fractionColor * 100;
            
            // 3) P√°ginas restantes = Rendimiento - (fracci√≥n √ó Rendimiento)
            remainingColor = yield.color - (fractionColor * yield.color);
        }

        // Determinar el t√≥ner cr√≠tico (el que tiene mayor porcentaje)
        let criticalPercentage = Math.max(percentageBlack, percentageColor);
        let criticalChanges = Math.max(tonerChangesBlack, tonerChangesColor);
        let currentCopies = Math.max(counterBlack, counterColor);
        
        // Para p√°ginas restantes, tomar el m√≠nimo entre negro y color (el que se agotar√° primero)
        let remainingMin;
        if (yield.color > 0 && counterColor > 0) {
            remainingMin = Math.min(remainingBlack, remainingColor);
        } else {
            remainingMin = remainingBlack;
        }

        // Calcular fecha estimada del √∫ltimo cambio de t√≥ner
        let lastChangeDateFormatted = 'Sin cambios registrados';
        
        if (criticalChanges > 0) {
            try {
                // Buscar la impresora para obtener su fecha de instalaci√≥n
                const printer = typeof printers !== 'undefined' ? printers.find(p => p && p.serial && p.serial.toUpperCase() === serial.toUpperCase()) : null;
                
                let baseDate = null;
                let daysToCalculate = 0;
                
                // Intentar usar fecha de instalaci√≥n si est√° disponible
                if (printer && printer.dateInst && printer.dateInst !== 'Instalaci√≥n pendiente') {
                    const installDate = new Date(printer.dateInst + 'T00:00:00');
                    if (!isNaN(installDate.getTime())) {
                        // Calcular desde la fecha de instalaci√≥n
                        baseDate = installDate;
                        const copiesAtLastChange = criticalChanges * (yield.color > 0 && counterColor > 0 ? Math.max(yield.black, yield.color) : yield.black);
                        const avgCopiesPerDay = 50;
                        daysToCalculate = Math.floor(copiesAtLastChange / avgCopiesPerDay);
                    }
                }
                
                // Si no hay fecha de instalaci√≥n, calcular hacia atr√°s desde hoy
                if (!baseDate) {
                    const today = new Date();
                    const copiesSinceLastChange = criticalPercentage * (yield.color > 0 && counterColor > 0 ? Math.max(yield.black, yield.color) : yield.black) / 100;
                    const avgCopiesPerDay = 50;
                    const daysSinceLastChange = Math.floor(copiesSinceLastChange / avgCopiesPerDay);
                    
                    baseDate = new Date(today);
                    daysToCalculate = -daysSinceLastChange; // Negativo para ir hacia atr√°s
                }
                
                // Calcular la fecha final
                const lastChangeDate = new Date(baseDate);
                lastChangeDate.setDate(lastChangeDate.getDate() + daysToCalculate);
                
                // Validar que la fecha calculada sea v√°lida
                if (!isNaN(lastChangeDate.getTime())) {
                    lastChangeDateFormatted = formatDateWithDay(lastChangeDate.toISOString().split('T')[0]);
                }
            } catch (error) {
                console.error('Error calculando fecha de cambio de t√≥ner:', error);
                lastChangeDateFormatted = 'Error al calcular';
            }
        }

        return {
            percentage: criticalPercentage.toFixed(1),
            changes: criticalChanges,
            remaining: Math.max(0, Math.floor(remainingMin)),
            currentCopies: Math.floor(currentCopies),
            display: `${criticalPercentage.toFixed(1)}%`,
            color: criticalPercentage >= 80 ? 'red' : criticalPercentage >= 50 ? 'orange' : criticalPercentage >= 30 ? 'yellow' : 'emerald',
            lastChangeDate: lastChangeDateFormatted,
            // Datos separados para B/N y Color
            black: {
                percentage: percentageBlack.toFixed(1),
                changes: tonerChangesBlack,
                remaining: Math.max(0, Math.floor(remainingBlack)),
                currentCopies: Math.floor(counterBlack),
                color: percentageBlack >= 80 ? 'red' : percentageBlack >= 50 ? 'orange' : percentageBlack >= 30 ? 'yellow' : 'emerald'
            },
            colorToner: {
                percentage: percentageColor.toFixed(1),
                changes: tonerChangesColor,
                remaining: Math.max(0, Math.floor(remainingColor)),
                currentCopies: Math.floor(counterColor),
                color: percentageColor >= 80 ? 'red' : percentageColor >= 50 ? 'orange' : percentageColor >= 30 ? 'yellow' : 'emerald',
                hasColor: yield.color > 0 && counterColor > 0
            }
        };
    }

    // Funci√≥n para cambiar entre pesta√±as
    function switchTab(tab) {
        currentTab = tab;
        
        // Ocultar todas las vistas
        document.getElementById('inventory-view').classList.add('hidden');
        document.getElementById('form-view').classList.add('hidden');
        document.getElementById('retired-view').classList.add('hidden');
        document.getElementById('toner-view').classList.add('hidden');
        document.getElementById('counters-view').classList.add('hidden');
        
        // Mostrar la vista correspondiente
        if (tab === 'inventory') {
            document.getElementById('inventory-view').classList.remove('hidden');
            renderTable(printers);
        } else if (tab === 'retired') {
            document.getElementById('retired-view').classList.remove('hidden');
            renderRetiredTable(retired);
        } else if (tab === 'toner') {
            document.getElementById('toner-view').classList.remove('hidden');
            renderTonerTable(toners);
        } else if (tab === 'counters') {
            document.getElementById('counters-view').classList.remove('hidden');
            renderCountersTable(counters);
        }
        
        window.scrollTo(0, 0);
    }

    function showView(view) {
        document.getElementById('inventory-view').classList.toggle('hidden', view !== 'inventory');
        document.getElementById('form-view').classList.toggle('hidden', view !== 'form');
        document.getElementById('retired-view').classList.add('hidden');
        document.getElementById('toner-view').classList.add('hidden');
        document.getElementById('counters-view').classList.add('hidden');
        
        if (view === 'inventory') {
            renderTable(printers);
            currentTab = 'inventory';
            // Actualizar el bot√≥n del men√∫
            document.getElementById('current-module-icon').innerText = 'inventory_2';
            document.getElementById('current-module-name').innerText = 'Inventario';
        }
        
        // Establecer fecha de registro actual cuando se muestra el formulario
        if (view === 'form') {
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="dateReg"]').value = today;
        }
        
        window.scrollTo(0, 0);
    }

    // Funci√≥n para actualizar el estado de una impresora desde la tabla
    function updatePrinterStatus(serial, newStatus) {
        const index = printers.findIndex(p => p.serial === serial);
        if (index === -1) {
            showToast('Impresora no encontrada', 'error');
            return;
        }
        printers[index].status = newStatus;
        localStorage.setItem('printers_cache', JSON.stringify(printers));
        showToast(`Estado actualizado a: ${newStatus}`, 'success');
        // Re-renderizar la tabla para actualizar los colores
        renderTable(printers);
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        data.forEach((p, idx) => {
            // Determinar color seg√∫n el estado
            let statusColor = 'text-slate-400 bg-slate-50 dark:bg-slate-800/20';
            if (p.status === 'Operativa') {
                statusColor = 'text-emerald-600 bg-emerald-50 dark:bg-emerald-900/20';
            } else if (p.status === 'Fuera de servicio') {
                statusColor = 'text-red-600 bg-red-50 dark:bg-red-900/20';
            } else if (p.status === 'Sin ubicar') {
                statusColor = 'text-amber-600 bg-amber-50 dark:bg-amber-900/20';
            }
            
            // Calcular estado del t√≥ner usando datos de contadores
            const tonerStatus = calculateTonerStatus(p.serial, p.model);
            const tonerPercentage = parseFloat(tonerStatus.percentage) || 0;
            let tonerColor = 'text-emerald-500 bg-emerald-50 dark:bg-emerald-900/20';
            if (tonerPercentage >= 80) tonerColor = 'text-red-500 bg-red-50 dark:bg-red-900/20';
            else if (tonerPercentage >= 50) tonerColor = 'text-orange-500 bg-orange-50 dark:bg-orange-900/20';
            else if (tonerPercentage >= 30) tonerColor = 'text-yellow-500 bg-yellow-50 dark:bg-yellow-900/20';
            
            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800/40 transition-colors border-b dark:border-slate-800";
            tr.innerHTML = `
                <td class="px-2 py-2">
                    <div class="flex items-center gap-1">
                        <div class="tooltip-wrapper">
                            <button onclick="showDetails('${p.serial}')" class="font-mono font-bold text-primary hover:underline cursor-pointer">${p.serial}</button>
                            <div class="custom-tooltip" id="tooltip-serial-${idx}">
                                <div class="tooltip-title">IP</div>
                                <div class="tooltip-value font-mono">${p.ip || 'No asignada'}</div>
                                <div class="tooltip-title">Gateway</div>
                                <div class="tooltip-value font-mono">${p.gateway || 'No configurado'}</div>
                                <div class="tooltip-title">M√°scara</div>
                                <div class="tooltip-value font-mono">${p.mask || 'No configurada'}</div>
                                <div class="tooltip-title">Servicios</div>
                                <div class="tooltip-value">
                                    <span class="tooltip-badge ${p.escaner ? 'badge-yes' : 'badge-no'}">ESC√ÅNER: ${p.escaner ? 'S√ç' : 'NO'}</span>
                                    <span class="tooltip-badge ${p.slnx ? 'badge-yes' : 'badge-no'}">SLNX: ${p.slnx ? 'S√ç' : 'NO'}</span>
                                    <span class="tooltip-badge ${p.ndd ? 'badge-yes' : 'badge-no'}">NDD: ${p.ndd ? 'S√ç' : 'NO'}</span>
                                </div>
                                <div class="tooltip-title">Nota</div>
                                <div class="tooltip-value italic" style="font-size: 12px; color: #64748b;">${p.note || 'Sin notas'}</div>
                            </div>
                        </div>
                        ${p.dateInst === 'Instalaci√≥n pendiente' ? 
                            `<div class="tooltip-wrapper">
                                <span class="material-symbols-outlined text-[16px] text-amber-500 animate-pulse cursor-help">schedule</span>
                                <div class="custom-tooltip" style="min-width: 200px;">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="material-symbols-outlined text-amber-500">warning</span>
                                        <span class="font-bold text-amber-600 dark:text-amber-400">Instalaci√≥n Pendiente</span>
                                    </div>
                                    <p class="text-xs text-slate-600 dark:text-slate-400">Esta impresora a√∫n no ha sido instalada.</p>
                                </div>
                            </div>` : 
                            ''}
                    </div>
                </td>
                <td class="px-2 py-2">
                    <div class="font-bold text-slate-700 dark:text-slate-300 text-[11px]">${p.model}</div>
                </td>
                <td class="px-2 py-2 text-[11px]">${p.city}</td>
                <td class="px-2 py-2 text-[11px]">${p.dept}</td>
                <td class="px-2 py-2">
                    <div class="truncate-cell text-[11px]" title="${p.address}" style="max-width: 140px;">${p.address}</div>
                </td>
                <td class="px-2 py-2 text-[11px]">${p.area}</td>
                <td class="px-2 py-2">
                    <div class="tooltip-wrapper">
                        <div class="font-bold cursor-default">${p.contact}</div>
                        <div class="custom-tooltip" id="tooltip-contact-${idx}">
                            <div class="tooltip-title">Celular</div>
                            <div class="tooltip-value font-mono text-lg">${p.phone || 'No registrado'}</div>
                        </div>
                    </div>
                </td>
                <td class="px-3 py-4">
                    <select onchange="updatePrinterStatus('${p.serial}', this.value)" class="text-[10px] font-bold uppercase px-2 py-1 rounded border-0 ${statusColor} cursor-pointer focus:ring-2 focus:ring-primary">
                        <option value="Operativa" ${p.status === 'Operativa' ? 'selected' : ''}>Operativa</option>
                        <option value="Fuera de servicio" ${p.status === 'Fuera de servicio' ? 'selected' : ''}>Fuera de servicio</option>
                        <option value="Sin ubicar" ${p.status === 'Sin ubicar' ? 'selected' : ''}>Sin ubicar</option>
                    </select>
                </td>
                <td class="px-2 py-2">
                    <div class="tooltip-wrapper">
                        <div class="flex items-center gap-1">
                            ${tonerStatus.colorToner.hasColor ? `
                                <!-- Gr√°fica B/N -->
                                <div class="flex flex-col items-center gap-1">
                                    <div class="circular-progress cursor-pointer hover:scale-110 transition-transform active:scale-95" onclick="showChangeTonerModal('${p.serial}')" style="--progress: ${tonerStatus.black.percentage}; --progress-color: ${parseFloat(tonerStatus.black.percentage) >= 80 ? '#ef4444' : parseFloat(tonerStatus.black.percentage) >= 50 ? '#f97316' : parseFloat(tonerStatus.black.percentage) >= 30 ? '#eab308' : '#10b981'}">
                                        <span class="circular-progress-text">${tonerStatus.black.percentage}%</span>
                                    </div>
                                    <span class="text-[8px] font-bold text-slate-400">B/N</span>
                                </div>
                                <!-- Gr√°fica Color -->
                                <div class="flex flex-col items-center gap-1">
                                    <div class="circular-progress cursor-pointer hover:scale-110 transition-transform active:scale-95" onclick="showChangeTonerModal('${p.serial}')" style="--progress: ${tonerStatus.colorToner.percentage}; --progress-color: ${parseFloat(tonerStatus.colorToner.percentage) >= 80 ? '#ef4444' : parseFloat(tonerStatus.colorToner.percentage) >= 50 ? '#f97316' : parseFloat(tonerStatus.colorToner.percentage) >= 30 ? '#eab308' : '#10b981'}">
                                        <span class="circular-progress-text">${tonerStatus.colorToner.percentage}%</span>
                                    </div>
                                    <span class="text-[8px] font-bold text-primary">Color</span>
                                </div>
                            ` : `
                                <!-- Solo gr√°fica B/N para impresoras monocromo -->
                                <div class="circular-progress cursor-pointer hover:scale-110 transition-transform active:scale-95" onclick="showChangeTonerModal('${p.serial}')" style="--progress: ${tonerPercentage}; --progress-color: ${tonerPercentage >= 80 ? '#ef4444' : tonerPercentage >= 50 ? '#f97316' : tonerPercentage >= 30 ? '#eab308' : '#10b981'}">
                                    <span class="circular-progress-text">${tonerPercentage.toFixed(1)}%</span>
                                </div>
                            `}
                            <div class="flex flex-col">
                                <span class="text-[9px] text-slate-400 font-semibold">${tonerStatus.currentCopies.toLocaleString()} copias</span>
                                <span class="text-[8px] text-slate-300 font-medium">Restantes: ${tonerStatus.remaining.toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="custom-tooltip" style="min-width: 250px;">
                            <div class="tooltip-title">Estado del T√≥ner</div>
                            <div class="tooltip-value">
                                ${tonerStatus.colorToner.hasColor ? `
                                    <!-- Informaci√≥n B/N -->
                                    <div class="mb-3 pb-3 border-b border-slate-200 dark:border-slate-700">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="material-symbols-outlined text-slate-600">print</span>
                                            <span class="font-bold text-lg">B/N: ${tonerStatus.black.percentage}%</span>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <div>
                                                <span class="text-slate-500">Copias actuales:</span>
                                                <div class="font-bold">${tonerStatus.black.currentCopies.toLocaleString()}</div>
                                            </div>
                                            <div>
                                                <span class="text-slate-500">Restantes:</span>
                                                <div class="font-bold text-${tonerStatus.black.color}-600">${tonerStatus.black.remaining.toLocaleString()}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Informaci√≥n Color -->
                                    <div>
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="material-symbols-outlined text-primary">palette</span>
                                            <span class="font-bold text-lg">Color: ${tonerStatus.colorToner.percentage}%</span>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <div>
                                                <span class="text-slate-500">Copias actuales:</span>
                                                <div class="font-bold">${tonerStatus.colorToner.currentCopies.toLocaleString()}</div>
                                            </div>
                                            <div>
                                                <span class="text-slate-500">Restantes:</span>
                                                <div class="font-bold text-${tonerStatus.colorToner.color}-600">${tonerStatus.colorToner.remaining.toLocaleString()}</div>
                                            </div>
                                        </div>
                                        ${tonerStatus.changes > 0 ? `
                                        <div class="col-span-2 pt-2 mt-2 border-t border-slate-200">
                                            <span class="text-slate-500">√öltimo cambio:</span>
                                            <div class="font-bold text-xs">${tonerStatus.lastChangeDate}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                ` : `
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="material-symbols-outlined text-${tonerStatus.color}-500">print</span>
                                        <span class="font-bold text-lg">${tonerPercentage.toFixed(1)}%</span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-xs">
                                        <div>
                                            <span class="text-slate-500">Copias actuales:</span>
                                            <div class="font-bold">${tonerStatus.currentCopies.toLocaleString()}</div>
                                        </div>
                                        <div>
                                            <span class="text-slate-500">Copias restantes:</span>
                                            <div class="font-bold text-${tonerStatus.color}-600">${tonerStatus.remaining.toLocaleString()}</div>
                                        </div>
                                        <div class="col-span-2">
                                            <span class="text-slate-500">Cambios de t√≥ner:</span>
                                            <div class="font-bold">${tonerStatus.changes} ${tonerStatus.changes === 1 ? 'vez' : 'veces'}</div>
                                        </div>
                                        ${tonerStatus.changes > 0 ? `
                                        <div class="col-span-2 pt-1 border-t border-slate-200">
                                            <span class="text-slate-500">√öltimo cambio:</span>
                                            <div class="font-bold text-xs">${tonerStatus.lastChangeDate}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </td>
                <td class="px-2 py-2 text-center">
                    <button onclick="showHistory('${p.serial}')" class="text-slate-300 hover:text-blue-500 transition-colors" title="Ver/Agregar Historial">
                        <span class="material-symbols-outlined text-[16px]">note_add</span>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        document.getElementById('tableStats').innerText = `Total Equipos: ${data.length}`;
        
        // Actualizar gr√°ficas de estad√≠sticas
        updateChartStats();
        
        // Configurar posicionamiento de tooltips
        setTimeout(() => {
            document.querySelectorAll('.tooltip-wrapper').forEach(wrapper => {
                const tooltip = wrapper.querySelector('.custom-tooltip');
                if (tooltip) {
                    wrapper.addEventListener('mouseenter', function(e) {
                        // Mostrar el tooltip temporalmente para obtener sus dimensiones
                        tooltip.style.display = 'block';
                        tooltip.style.visibility = 'hidden';
                        
                        const rect = this.getBoundingClientRect();
                        const tooltipRect = tooltip.getBoundingClientRect();
                        
                        // Posicionar el tooltip a la derecha del elemento
                        let left = rect.right + 10;
                        let top = rect.top;
                        
                        // Ajustar si se sale por la derecha
                        if (left + tooltipRect.width > window.innerWidth - 10) {
                            left = rect.left - tooltipRect.width - 10;
                        }
                        
                        // Si a√∫n se sale por la izquierda, centrarlo sobre el elemento
                        if (left < 10) {
                            left = Math.max(10, rect.left + (rect.width / 2) - (tooltipRect.width / 2));
                        }
                        
                        // Ajustar si se sale por abajo
                        if (top + tooltipRect.height > window.innerHeight - 10) {
                            top = window.innerHeight - tooltipRect.height - 10;
                        }
                        
                        // Ajustar si se sale por arriba
                        if (top < 10) {
                            top = 10;
                        }
                        
                        // Asegurar que no se salga por la derecha despu√©s de todos los ajustes
                        if (left + tooltipRect.width > window.innerWidth - 10) {
                            left = window.innerWidth - tooltipRect.width - 10;
                        }
                        
                        tooltip.style.left = left + 'px';
                        tooltip.style.top = top + 'px';
                        tooltip.style.visibility = 'visible';
                    });
                    
                    // Agregar evento para ocultar el tooltip
                    wrapper.addEventListener('mouseleave', function(e) {
                        tooltip.style.display = 'none';
                    });
                }
            });
        }, 100);
    }

    // Variable global para guardar el √≠ndice del equipo que se est√° editando
    let currentEditingIndex = null;

    // Funci√≥n para mostrar detalles completos (EDITABLE)
    function showDetails(serial) {
        const index = printers.findIndex(p => p.serial === serial);
        if (index === -1) {
            showToast('Impresora no encontrada', 'error');
            return;
        }
        currentEditingIndex = index;
        const p = printers[index];
        const tonerStatus = calculateTonerStatus(p.serial, p.model);
        const tonerPercentage = parseFloat(tonerStatus.percentage);
        
        const detailsContent = document.getElementById('details-content');
        detailsContent.innerHTML = `
            <form id="edit-details-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Fechas -->
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Fecha de Registro</label>
                        <input type="date" value="${p.dateReg || ''}" readonly class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 cursor-not-allowed text-slate-400 dark:text-slate-500" />
                    </div>
                    <div class="${p.dateInst === 'Instalaci√≥n pendiente' ? 'bg-amber-50 dark:bg-amber-900/20 border-amber-300 dark:border-amber-700' : 'bg-slate-50 dark:bg-slate-800/50'} p-4 rounded-lg border ${p.dateInst === 'Instalaci√≥n pendiente' ? 'border-amber-300 dark:border-amber-700' : 'border-slate-200 dark:border-slate-700'}">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Fecha de Instalaci√≥n</label>
                        ${p.dateInst === 'Instalaci√≥n pendiente' ? 
                            `<input type="date" name="dateInst" class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary" />` :
                            `<input type="date" name="dateInst" value="${p.dateInst || ''}" readonly class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 cursor-not-allowed text-slate-400 dark:text-slate-500" />`
                        }
                        ${p.dateInst === 'Instalaci√≥n pendiente' ? 
                            `<p class="text-xs text-amber-600 dark:text-amber-400 mt-1 font-semibold">${p.dateInst}</p>` : ''}
                    </div>
                    
                    <!-- Identificaci√≥n -->
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">N√∫mero de Serie</label>
                        <input type="text" value="${p.serial || ''}" readonly class="text-sm font-mono font-bold w-full bg-transparent border-none p-0 focus:ring-0 cursor-not-allowed uppercase text-slate-400 dark:text-slate-500" />
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">MAC</label>
                        <input type="text" value="${p.mac || ''}" readonly class="text-sm font-mono font-bold w-full bg-transparent border-none p-0 focus:ring-0 cursor-not-allowed uppercase text-slate-400 dark:text-slate-500" />
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Modelo</label>
                        <input type="text" value="${p.model || ''}" readonly class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 cursor-not-allowed text-slate-400 dark:text-slate-500" />
                    </div>
                    
                    <!-- Ubicaci√≥n -->
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Ciudad</label>
                        <input type="text" name="city" value="${p.city || ''}" class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary" />
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Departamento</label>
                        <input type="text" name="dept" value="${p.dept || ''}" class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary" />
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700 md:col-span-2 lg:col-span-1">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Direcci√≥n del Equipo</label>
                        <input type="text" name="address" value="${p.address || ''}" class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary" />
                    </div>
                    
                    <!-- Red -->
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">IP</label>
                        <input type="text" name="ip" value="${p.ip || ''}" class="text-sm font-mono font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary" />
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Gateway</label>
                        <input type="text" name="gateway" value="${p.gateway || ''}" class="text-sm font-mono font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary" />
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">M√°scara</label>
                        <input type="text" name="mask" value="${p.mask || ''}" class="text-sm font-mono font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary" />
                    </div>
                    
                    <!-- Contacto -->
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">√Årea</label>
                        <input type="text" name="area" value="${p.area || ''}" class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary" />
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Contacto</label>
                        <input type="text" name="contact" value="${p.contact || ''}" class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary" />
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Celular</label>
                        <input type="text" name="phone" value="${p.phone || ''}" class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary" />
                    </div>
                    
                    <!-- Estado -->
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Estado de Impresora</label>
                        <select name="status" class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary">
                            <option ${p.status === 'Operativa' ? 'selected' : ''}>Operativa</option>
                            <option ${p.status === 'Fuera de servicio' ? 'selected' : ''}>Fuera de servicio</option>
                            <option ${p.status === 'Sin ubicar' ? 'selected' : ''}>Sin ubicar</option>
                            </select>
                    </div>
                    
                    <!-- Servicios -->
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-2">Esc√°ner</label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="escaner" ${p.escaner ? 'checked' : ''} class="rounded text-primary focus:ring-primary" />
                            <span class="text-sm font-bold">Disponible</span>
                        </label>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-2">SLNX</label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="slnx" ${p.slnx ? 'checked' : ''} class="rounded text-primary focus:ring-primary" />
                            <span class="text-sm font-bold">Disponible</span>
                        </label>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-2">NDD</label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="ndd" ${p.ndd ? 'checked' : ''} class="rounded text-primary focus:ring-primary" />
                            <span class="text-sm font-bold">Disponible</span>
                        </label>
                    </div>
                    
                    <!-- Contador Inicial -->
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Contador Inicial</label>
                        <input type="number" value="${p.counterInitial || 0}" readonly class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 cursor-not-allowed text-slate-400 dark:text-slate-500" />
                    </div>
                    <div class="bg-gradient-to-br from-primary/10 to-primary/5 dark:from-primary/20 dark:to-primary/10 p-4 rounded-lg border-2 border-primary/30">
                        <label class="text-xs font-bold uppercase text-primary block mb-1">Estado del T√≥ner</label>
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-3xl font-black text-primary">${tonerPercentage.toFixed(1)}%</div>
                            <span class="material-symbols-outlined text-4xl text-primary/30">local_printshop</span>
                        </div>
                        <div class="space-y-1 text-xs text-slate-600 dark:text-slate-400">
                            <div class="flex justify-between">
                                <span>Copias actuales:</span>
                                <span class="font-bold">${tonerStatus.currentCopies.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Copias restantes:</span>
                                <span class="font-bold text-${tonerStatus.color}-600">${tonerStatus.remaining.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Cambios de t√≥ner:</span>
                                <span class="font-bold">${tonerStatus.changes} ${tonerStatus.changes === 1 ? 'vez' : 'veces'}</span>
                            </div>
                            ${tonerStatus.changes > 0 ? `
                            <div class="flex justify-between pt-2 mt-2 border-t border-primary/20">
                                <span>√öltimo cambio:</span>
                                <span class="font-bold text-primary">${tonerStatus.lastChangeDate}</span>
                            </div>
                            ` : ''}
                        </div>
                        <div class="mt-3 h-3 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden shadow-inner">
                            <div class="h-full ${tonerPercentage >= 80 ? 'bg-red-500' : tonerPercentage >= 50 ? 'bg-orange-500' : tonerPercentage >= 30 ? 'bg-yellow-500' : 'bg-emerald-500'} transition-all duration-500" style="width: ${Math.min(tonerPercentage, 100)}%"></div>
                        </div>
                    </div>
                    
                    <!-- Nota (editable) -->
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700 md:col-span-2 lg:col-span-3">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Nota</label>
                        <textarea name="note" class="text-sm w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary resize-none" rows="2" placeholder="Observaciones...">${p.note || ''}</textarea>
                    </div>
                </div>
                
                <!-- Botones de acci√≥n -->
                <div class="flex justify-between pt-4 border-t border-slate-200 dark:border-slate-700">
                    <div class="flex gap-3">
                        <button type="button" onclick="deletePrinterFromDetails(${index})" class="px-6 py-2 rounded-lg bg-slate-600 text-white font-bold text-sm transition-all hover:bg-slate-700 flex items-center gap-2">
                            <span class="material-symbols-outlined text-[16px]">delete</span>
                            Eliminar
                        </button>
                        <button type="button" onclick="retirePrinter(${index})" class="px-6 py-2 rounded-lg bg-red-500 text-white font-bold text-sm transition-all hover:bg-red-600 flex items-center gap-2">
                            <span class="material-symbols-outlined text-[16px]">delete_forever</span>
                            Retirar
                        </button>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" onclick="closeDetailsModal()" class="px-6 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 font-bold text-sm transition-all hover:bg-slate-200">
                            Cancelar
                        </button>
                        <button type="submit" class="px-6 py-2 rounded-lg bg-primary text-white font-bold text-sm transition-all hover:bg-blue-600 flex items-center gap-2">
                            <span class="material-symbols-outlined text-[16px]">save</span>
                            Guardar Cambios
                        </button>
                    </div>
                </div>
            </form>
        `;
        
        // Agregar evento al formulario
        document.getElementById('edit-details-form').addEventListener('submit', saveDetailsChanges);
        
        document.getElementById('details-modal').classList.remove('hidden');
    }

    function closeDetailsModal() {
        document.getElementById('details-modal').classList.add('hidden');
        currentEditingIndex = null;
    }

    // Funci√≥n para guardar los cambios del formulario de detalles
    function saveDetailsChanges(e) {
        e.preventDefault();
        
        if (currentEditingIndex === null) return;
        
        const form = e.target;
        const formData = new FormData(form);
        
        // Actualizar solo los campos editables
        const newDateInst = formData.get('dateInst');
        // Solo actualizar dateInst si era "Instalaci√≥n pendiente" y ahora hay una fecha
        if (printers[currentEditingIndex].dateInst === 'Instalaci√≥n pendiente' && newDateInst) {
            printers[currentEditingIndex].dateInst = newDateInst;
        } else if (printers[currentEditingIndex].dateInst !== 'Instalaci√≥n pendiente') {
            // Si ya tiene una fecha, no se puede cambiar
            // No hacer nada, mantener la fecha existente
        } else if (!newDateInst) {
            // Si sigue sin fecha, mantener "Instalaci√≥n pendiente"
            printers[currentEditingIndex].dateInst = 'Instalaci√≥n pendiente';
        }
        printers[currentEditingIndex].city = formData.get('city') || '';
        printers[currentEditingIndex].dept = formData.get('dept') || '';
        printers[currentEditingIndex].address = formData.get('address') || '';
        printers[currentEditingIndex].ip = formData.get('ip') || '';
        printers[currentEditingIndex].gateway = formData.get('gateway') || '';
        printers[currentEditingIndex].mask = formData.get('mask') || '';
        printers[currentEditingIndex].area = formData.get('area') || '';
        printers[currentEditingIndex].contact = formData.get('contact') || '';
        printers[currentEditingIndex].phone = formData.get('phone') || '';
        printers[currentEditingIndex].status = formData.get('status') || '';
        printers[currentEditingIndex].escaner = form.querySelector('input[name="escaner"]').checked;
        printers[currentEditingIndex].slnx = form.querySelector('input[name="slnx"]').checked;
        printers[currentEditingIndex].ndd = form.querySelector('input[name="ndd"]').checked;
        printers[currentEditingIndex].note = formData.get('note') || '';
        
        // Guardar en localStorage
        localStorage.setItem('printers_cache', JSON.stringify(printers));
        
        // Actualizar la tabla
        renderTable(printers);
        
        // Cerrar modal y mostrar mensaje
        closeDetailsModal();
        showToast('Cambios guardados correctamente', 'success');
    }

    // Renderizar tabla de equipos retirados
    function renderRetiredTable(data) {
        const tbody = document.getElementById('retiredTableBody');
        tbody.innerHTML = '';
        
        if (data.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                        <span class="material-symbols-outlined text-6xl mb-4 block">inventory_2</span>
                        No hay equipos retirados registrados
                    </td>
                </tr>
            `;
            document.getElementById('retiredStats').innerText = 'Total: 0';
            return;
        }
        
        data.forEach((item, idx) => {
            const hasRMA = item.rma && item.rma !== '';
            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800/40 transition-colors border-b dark:border-slate-800";
            tr.innerHTML = `
                <td class="px-3 py-4 font-mono font-bold">${item.serial || '-'}</td>
                <td class="px-3 py-4">${item.model || '-'}</td>
                <td class="px-3 py-4">${item.location || '-'}</td>
                <td class="px-3 py-4">
                    ${item.dateRetired ? `<span class="text-xs font-semibold">${item.dateRetired}</span>` : '<span class="text-xs text-slate-400 italic">Pendiente</span>'}
                </td>
                <td class="px-3 py-4">${item.contact || '-'}</td>
                <td class="px-3 py-4">
                    ${item.rma ? `<span class="font-mono font-bold text-primary">${item.rma}</span>` : '<span class="text-xs text-slate-400 italic">Pendiente</span>'}
                </td>
                <td class="px-3 py-4 text-center">
                    ${!hasRMA ? `
                        <button onclick="showRMAModal(${idx})" class="text-amber-500 hover:text-amber-600 transition-colors mr-2" title="Completar retiro con RMA">
                            <span class="material-symbols-outlined text-[18px]">assignment_turned_in</span>
                        </button>
                    ` : ''}
                    <button onclick="deleteRetired(${idx})" class="text-slate-300 hover:text-red-500 transition-colors" title="Eliminar registro">
                        <span class="material-symbols-outlined text-[18px]">delete</span>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        document.getElementById('retiredStats').innerText = `Total: ${data.length}`;
    }

    // Renderizar tabla de t√≥ner
    function renderTonerTable(data) {
        const tbody = document.getElementById('tonerTableBody');
        tbody.innerHTML = '';
        
        if (data.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="px-6 py-12 text-center text-gray-500">
                        <span class="material-symbols-outlined text-6xl mb-4 block">local_printshop</span>
                        No hay t√≥ners registrados
                    </td>
                </tr>
            `;
            document.getElementById('tonerStats').innerText = 'Total: 0';
            return;
        }
        
        data.forEach((item, idx) => {
            const statusColor = item.status === 'Disponible' ? 'text-emerald-500 bg-emerald-50' : 
                               item.status === 'En Uso' ? 'text-blue-500 bg-blue-50' : 
                               'text-slate-400 bg-slate-50';
            
            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800/40 transition-colors border-b dark:border-slate-800";
            tr.innerHTML = `
                <td class="px-3 py-4">${item.element || '-'}</td>
                <td class="px-3 py-4 font-bold">${item.model || '-'}</td>
                <td class="px-3 py-4">${item.printerModel || '-'}</td>
                <td class="px-3 py-4">
                    <span class="px-2 py-1 rounded text-[10px] font-bold" style="background: ${item.color === 'Negro' ? '#333' : item.color === 'Cian' ? '#00bcd4' : item.color === 'Magenta' ? '#e91e63' : '#ffeb3b'}; color: ${item.color === 'Negro' || item.color === 'Cian' || item.color === 'Magenta' ? 'white' : 'black'}">${item.color || '-'}</span>
                </td>
                <td class="px-3 py-4">${item.location || '-'}</td>
                <td class="px-3 py-4">${item.dateReg || '-'}</td>
                <td class="px-3 py-4">
                    <div class="flex flex-col gap-1">
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 rounded-full text-[10px] font-black uppercase ${statusColor}">${item.status || '-'}</span>
                            ${item.status === 'Disponible' ? `
                                <button onclick="showAssignTonerModal(${idx})" class="text-purple-500 hover:text-purple-700 transition-colors" title="Asignar a impresora">
                                    <span class="material-symbols-outlined text-[16px]">arrow_forward</span>
                                </button>
                            ` : ''}
                        </div>
                        ${item.status === 'Usado' && item.assignedTo ? `
                            <div class="text-[9px] text-slate-500">
                                <div class="font-mono font-semibold" title="Asignado a">S/N: ${item.assignedTo}</div>
                                <div class="text-slate-400 italic" title="Fecha de asignaci√≥n">üìÖ ${item.assignedDate || '-'}</div>
                            </div>
                        ` : ''}
                    </div>
                </td>
                <td class="px-3 py-4">
                    <div class="truncate-cell" style="max-width: 150px;" title="${item.observation || ''}">${item.observation || '-'}</div>
                </td>
                <td class="px-3 py-4 text-center">
                    <button onclick="deleteToner(${idx})" class="text-slate-300 hover:text-red-500 transition-colors">
                        <span class="material-symbols-outlined text-[18px]">delete</span>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        document.getElementById('tonerStats').innerText = `Total: ${data.length}`;
    }

    // Renderizar tabla de contadores con edici√≥n inline
    function renderCountersTable(data) {
        const tbody = document.getElementById('countersTableBody');
        tbody.innerHTML = '';
        
        if (data.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                        <span class="material-symbols-outlined text-6xl mb-4 block">calculate</span>
                        No hay contadores registrados
                    </td>
                </tr>
            `;
            document.getElementById('countersStats').innerText = 'Total: 0';
            return;
        }
        
        data.forEach((item, idx) => {
            const total = (parseFloat(item.bn) || 0) + (parseFloat(item.color) || 0);
            
            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800/40 transition-colors border-b dark:border-slate-800";
            tr.innerHTML = `
                <td class="px-3 py-4 font-mono font-bold">${item.serial || '-'}</td>
                <td class="px-3 py-4">${item.model || '-'}</td>
                <td class="px-3 py-4">
                    <input type="number" 
                           value="${item.bn || 0}" 
                           onchange="updateCounterField(${idx}, 'bn', this.value)"
                           class="w-full font-bold text-slate-700 dark:text-slate-300 bg-transparent border border-slate-300 dark:border-slate-600 rounded px-2 py-1 focus:ring-2 focus:ring-primary focus:border-transparent" />
                </td>
                <td class="px-3 py-4">
                    <input type="number" 
                           value="${item.color || 0}" 
                           onchange="updateCounterField(${idx}, 'color', this.value)"
                           class="w-full font-bold text-primary bg-transparent border border-slate-300 dark:border-slate-600 rounded px-2 py-1 focus:ring-2 focus:ring-primary focus:border-transparent" />
                </td>
                <td class="px-3 py-4 font-bold text-emerald-600 dark:text-emerald-400">${total.toLocaleString()}</td>
                <td class="px-3 py-4">
                    <input type="text" 
                           value="${item.location || ''}" 
                           onchange="updateCounterField(${idx}, 'location', this.value)"
                           class="w-full bg-transparent border border-slate-300 dark:border-slate-600 rounded px-2 py-1 focus:ring-2 focus:ring-primary focus:border-transparent" />
                </td>
                <td class="px-3 py-4 text-center">
                    <button onclick="deleteCounter(${idx})" class="text-slate-300 hover:text-red-500 transition-colors">
                        <span class="material-symbols-outlined text-[18px]">delete</span>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        document.getElementById('countersStats').innerText = `Total: ${data.length}`;
    }

    // Filtrar tabla de contadores por serie
    function filterCountersTable() {
        const serialFilter = document.getElementById('filter-counter-serial').value.toLowerCase();
        const filteredCounters = counters.filter(c => {
            const serial = (c.serial || '').toLowerCase();
            return serial.includes(serialFilter);
        });
        renderCountersTable(filteredCounters);
    }

    // Actualizar campo individual de contador
    function updateCounterField(index, field, value) {
        if (index < 0 || index >= counters.length) return;
        
        // Actualizar el valor
        if (field === 'bn' || field === 'color') {
            counters[index][field] = parseFloat(value) || 0;
        } else {
            counters[index][field] = value;
        }
        
        // Guardar en localStorage
        localStorage.setItem('counters_cache', JSON.stringify(counters));
        
        // Re-renderizar la tabla
        renderCountersTable(counters);
    }

    // Funciones para eliminar registros
    function deleteRetired(index) {
        if (confirm("¬øEliminar este registro?")) {
            retired.splice(index, 1);
            localStorage.setItem('retired_cache', JSON.stringify(retired));
            renderRetiredTable(retired);
        }
    }

    function deleteToner(index) {
        if (!window.canDelete || !window.canDelete()) {
            showToast("üîí Solo administradores pueden eliminar registros", "error");
            return;
        }
        if (confirm("¬øEliminar este registro?")) {
            toners.splice(index, 1);
            localStorage.setItem('toners_cache', JSON.stringify(toners));
            renderTonerTable(toners);
        }
    }

    function deleteCounter(index) {
        if (!window.canDelete || !window.canDelete()) {
            showToast("üîí Solo administradores pueden eliminar registros", "error");
            return;
        }
        if (confirm("¬øEliminar este registro?")) {
            counters.splice(index, 1);
            localStorage.setItem('counters_cache', JSON.stringify(counters));
            renderCountersTable(counters);
        }
    }

    // Funciones para el historial de tareas
    function showHistory(serial) {
        currentHistorySerial = serial;
        document.getElementById('history-serial').textContent = serial;
        document.getElementById('history-modal').classList.remove('hidden');
        renderHistory(serial);
    }

    function closeHistoryModal() {
        document.getElementById('history-modal').classList.add('hidden');
        document.getElementById('new-note').value = '';
        currentHistorySerial = null;
    }

    function renderHistory(serial) {
        const historyContent = document.getElementById('history-content');
        const notes = history[serial] || [];
        
        if (notes.length === 0) {
            historyContent.innerHTML = `
                <div class="text-center py-12 text-slate-400">
                    <span class="material-symbols-outlined text-5xl mb-3 opacity-30">history</span>
                    <p class="font-medium">No hay registros de tareas</p>
                    <p class="text-xs mt-1">Agrega la primera nota abajo</p>
                </div>
            `;
        } else {
            historyContent.innerHTML = notes.map((note, idx) => `
                <div class="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-4 border border-slate-200 dark:border-slate-700 hover:border-primary/30 transition-colors">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary text-[18px]">event_note</span>
                            <span class="text-xs font-bold text-slate-500">${note.date}</span>
                        </div>
                        <button onclick="deleteHistoryNote('${serial}', ${idx})" class="text-slate-300 hover:text-red-500 transition-colors">
                            <span class="material-symbols-outlined text-[16px]">close</span>
                        </button>
                    </div>
                    <p class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed whitespace-pre-wrap">${note.note}</p>
                </div>
            `).reverse().join('');
        }
    }

    function deleteHistoryNote(serial, index) {
        if (confirm("¬øEliminar esta nota?")) {
            history[serial].splice(index, 1);
            if (history[serial].length === 0) {
                delete history[serial];
            }
            localStorage.setItem('history_cache', JSON.stringify(history));
            renderHistory(serial);
        }
    }

    // Manejo del formulario de agregar nota
    document.getElementById('add-note-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const noteText = document.getElementById('new-note').value.trim();
        if (noteText && currentHistorySerial) {
            const newNote = {
                date: new Date().toLocaleString('es-CO', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }),
                note: noteText
            };
            
            if (!history[currentHistorySerial]) {
                history[currentHistorySerial] = [];
            }
            history[currentHistorySerial].push(newNote);
            localStorage.setItem('history_cache', JSON.stringify(history));
            
            document.getElementById('new-note').value = '';
            renderHistory(currentHistorySerial);
        }
    });

    function filterTableByColumns() {
        applyAllFilters();
    }

    // Variables para rastrear filtros activos de gr√°ficas
    let activePrinterStatusFilter = null;
    let activeTonerStatusFilter = null;

    // Actualizar estad√≠sticas de las gr√°ficas
    function updateChartStats() {
        // Contar estados de impresora
        let countOperativa = 0;
        let countFuera = 0;
        let countSinUbicar = 0;
        
        // Contar estados de t√≥ner
        let countToner0 = 0;
        let countToner30 = 0;
        let countToner50 = 0;
        let countToner80 = 0;
        
        printers.forEach(p => {
            // Contar por estado de impresora
            if (p.status === 'Operativa') countOperativa++;
            else if (p.status === 'Fuera de servicio') countFuera++;
            else if (p.status === 'Sin ubicar') countSinUbicar++;
            
            // Contar por estado de t√≥ner
            const tonerStatus = calculateTonerStatus(p.serial, p.model);
            const tonerPercentage = parseFloat(tonerStatus.percentage);
            
            if (tonerPercentage >= 0 && tonerPercentage < 30) countToner0++;
            else if (tonerPercentage >= 30 && tonerPercentage < 50) countToner30++;
            else if (tonerPercentage >= 50 && tonerPercentage < 80) countToner50++;
            else if (tonerPercentage >= 80 && tonerPercentage <= 100) countToner80++;
        });
        
        // Actualizar UI
        document.getElementById('count-operativa').innerText = countOperativa;
        document.getElementById('count-fuera').innerText = countFuera;
        document.getElementById('count-sinubicar').innerText = countSinUbicar;
        
        document.getElementById('count-toner-0').innerText = countToner0;
        document.getElementById('count-toner-30').innerText = countToner30;
        document.getElementById('count-toner-50').innerText = countToner50;
        document.getElementById('count-toner-80').innerText = countToner80;
    }

    // Toggle filtro por estado de impresora desde gr√°fica
    function togglePrinterStatusFilter(status) {
        const chartElement = document.getElementById('chart-' + (status === 'Operativa' ? 'operativa' : status === 'Fuera de servicio' ? 'fuera' : 'sinubicar'));
        
        // Si ya est√° activo, desactivar
        if (activePrinterStatusFilter === status) {
            activePrinterStatusFilter = null;
            chartElement.classList.remove('ring-4', 'ring-primary', 'border-primary');
            chartElement.classList.add('border-transparent');
            
            // Aplicar otros filtros activos
            applyAllFilters();
        } else {
            // Desactivar filtro anterior si existe
            if (activePrinterStatusFilter) {
                const prevChart = document.getElementById('chart-' + (activePrinterStatusFilter === 'Operativa' ? 'operativa' : activePrinterStatusFilter === 'Fuera de servicio' ? 'fuera' : 'sinubicar'));
                prevChart.classList.remove('ring-4', 'ring-primary', 'border-primary');
                prevChart.classList.add('border-transparent');
            }
            
            // Activar nuevo filtro
            activePrinterStatusFilter = status;
            chartElement.classList.add('ring-4', 'ring-primary', 'border-primary');
            chartElement.classList.remove('border-transparent');
            
            applyAllFilters();
        }
    }

    // Toggle filtro por estado de t√≥ner desde gr√°fica
    function toggleTonerStatusFilter(range) {
        const chartElement = document.getElementById('chart-toner-' + range.split('-')[0]);
        
        // Si ya est√° activo, desactivar
        if (activeTonerStatusFilter === range) {
            activeTonerStatusFilter = null;
            chartElement.classList.remove('ring-4', 'ring-primary', 'border-primary');
            chartElement.classList.add('border-transparent');
            
            // Aplicar otros filtros activos
            applyAllFilters();
        } else {
            // Desactivar filtro anterior si existe
            if (activeTonerStatusFilter) {
                const prevChart = document.getElementById('chart-toner-' + activeTonerStatusFilter.split('-')[0]);
                prevChart.classList.remove('ring-4', 'ring-primary', 'border-primary');
                prevChart.classList.add('border-transparent');
            }
            
            // Activar nuevo filtro
            activeTonerStatusFilter = range;
            chartElement.classList.add('ring-4', 'ring-primary', 'border-primary');
            chartElement.classList.remove('border-transparent');
            
            applyAllFilters();
        }
    }

    // Aplicar todos los filtros activos (inputs + gr√°ficas)
    function applyAllFilters() {
        const filterSerial = document.getElementById('filter-serial').value.toLowerCase();
        const filterModel = document.getElementById('filter-model').value.toLowerCase();
        const filterCity = document.getElementById('filter-city').value.toLowerCase();
        const filterDept = document.getElementById('filter-dept').value.toLowerCase();
        const filterAddress = document.getElementById('filter-address').value.toLowerCase();
        const filterArea = document.getElementById('filter-area').value.toLowerCase();
        const filterContact = document.getElementById('filter-contact').value.toLowerCase();
        const filterStatus = document.getElementById('filter-status').value;
        const filterToner = document.getElementById('filter-toner').value;
        
        const filtered = printers.filter(p => {
            const tonerStatus = calculateTonerStatus(p.serial, p.model);
            const tonerPercentage = parseFloat(tonerStatus.percentage);
            
            const matchSerial = !filterSerial || (p.serial || '').toLowerCase().includes(filterSerial);
            const matchModel = !filterModel || (p.model || '').toLowerCase().includes(filterModel);
            const matchCity = !filterCity || (p.city || '').toLowerCase().includes(filterCity);
            const matchDept = !filterDept || (p.dept || '').toLowerCase().includes(filterDept);
            const matchAddress = !filterAddress || (p.address || '').toLowerCase().includes(filterAddress);
            const matchArea = !filterArea || (p.area || '').toLowerCase().includes(filterArea);
            const matchContact = !filterContact || (p.contact || '').toLowerCase().includes(filterContact);
            const matchStatus = !filterStatus || p.status === filterStatus;
            
            // Filtrar por rango de porcentaje de t√≥ner (inputs)
            let matchToner = true;
            if (filterToner) {
                if (filterToner === 'verde') {
                    matchToner = tonerPercentage >= 0 && tonerPercentage < 30;
                } else if (filterToner === 'amarillo') {
                    matchToner = tonerPercentage >= 30 && tonerPercentage < 50;
                } else if (filterToner === 'naranja') {
                    matchToner = tonerPercentage >= 50 && tonerPercentage < 80;
                } else if (filterToner === 'rojo') {
                    matchToner = tonerPercentage >= 80 && tonerPercentage <= 100;
                }
            }
            
            // Filtrar por estado de impresora desde gr√°fica
            const matchChartStatus = !activePrinterStatusFilter || p.status === activePrinterStatusFilter;
            
            // Filtrar por estado de t√≥ner desde gr√°fica
            let matchChartToner = true;
            if (activeTonerStatusFilter) {
                const [min, max] = activeTonerStatusFilter.split('-').map(Number);
                matchChartToner = tonerPercentage >= min && tonerPercentage <= max;
            }
            
            return matchSerial && matchModel && matchCity && matchDept && matchAddress && 
                   matchArea && matchContact && matchStatus && matchToner && 
                   matchChartStatus && matchChartToner;
        });
        
        renderTable(filtered);
    }

    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-emerald-500' : 'bg-red-500';
        toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-xl text-sm font-bold flex items-center gap-2 transform translate-x-10 opacity-0 transition-all duration-300`;
        toast.innerHTML = `<span class="material-symbols-outlined">${type === 'success' ? 'check_circle' : 'error'}</span> ${message}`;
        
        container.appendChild(toast);
        setTimeout(() => { toast.classList.remove('translate-x-10', 'opacity-0'); }, 10);
        setTimeout(() => {
            toast.classList.add('translate-x-10', 'opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }

    document.getElementById('printerRegistrationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const btn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnSpinner = document.getElementById('btnSpinner');
        
        const fd = new FormData(this);
        
        // Objeto con los datos en el formato correcto para Apps Script
        const data = {
            dateReg: fd.get('dateReg') || '',           // Fecha de registro
            dateInst: fd.get('dateInst') || 'Instalaci√≥n pendiente',         // Fecha de instalacion
            serial: fd.get('serial') || '',             // Numero de serie
            mac: fd.get('mac') || '',                   // MAC
            model: fd.get('model') || '',               // Modelo
            city: fd.get('city') || '',                 // Cuidad
            dept: fd.get('dept') || '',                 // Departamento
            ip: fd.get('ip') || '',                     // IP
            gateway: fd.get('gateway') || '',           // Getway
            mask: fd.get('mask') || '',                 // Mascara
            address: fd.get('address') || '',           // Direccion del equipo
            area: fd.get('area') || '',                 // Area
            contact: fd.get('contact') || '',           // Contacto
            phone: fd.get('phone') || '',               // Celular
            status: fd.get('status') || '',             // Estado de impresora
            escaner: fd.get('escaner') === 'on' ? 'S√ç' : 'NO',  // Escaner (Checkbox)
            slnx: fd.get('slnx') === 'on' ? 'S√ç' : 'NO',        // Slnx (Checkbox)
            ndd: fd.get('ndd') === 'on' ? 'S√ç' : 'NO',          // NDD (Checkbox)
            note: fd.get('note') || '',                 // Nota
            countInit: fd.get('counterInitial') || 0    // Contador Inicial
        };
        
        // Guardar localmente con formato booleano para la tabla
        const localData = {
            dateReg: fd.get('dateReg') || '',
            dateInst: fd.get('dateInst') || 'Instalaci√≥n pendiente',
            serial: fd.get('serial') || '',
            mac: fd.get('mac') || '',
            model: fd.get('model') || '',
            city: fd.get('city') || '',
            dept: fd.get('dept') || '',
            ip: fd.get('ip') || '',
            gateway: fd.get('gateway') || '',
            mask: fd.get('mask') || '',
            address: fd.get('address') || '',
            area: fd.get('area') || '',
            contact: fd.get('contact') || '',
            phone: fd.get('phone') || '',
            status: fd.get('status') || '',
            escaner: fd.get('escaner') === 'on',
            slnx: fd.get('slnx') === 'on',
            ndd: fd.get('ndd') === 'on',
            note: fd.get('note') || '',
            counterInitial: fd.get('counterInitial') || 0
        };

        // Bloquear UI
        btn.disabled = true;
        btnText.innerText = "Guardando...";
        btnSpinner.classList.remove('hidden');

        try {
            // Validar campo requerido
            if (!localData.serial || !localData.model) {
                throw new Error("N√∫mero de serie y modelo son obligatorios");
            }

            // Guardar localmente
            printers.unshift(localData);
            localStorage.setItem('printers_cache', JSON.stringify(printers));
            
            // Guardar en Firebase (si est√° disponible)
            if (window.firebaseEnabled && typeof window.firebaseCrearImpresora === 'function') {
                try {
                    await window.firebaseCrearImpresora(localData);
                    showToast("‚úÖ Registro guardado en Firebase y localmente", "success");
                } catch (firebaseError) {
                    console.error("‚ö†Ô∏è Error completo de Firebase:", firebaseError);
                    showToast("‚úÖ Guardado localmente. Error en Firebase: " + firebaseError.message, "success");
                }
            } else {
                console.log("Firebase no disponible, guardado solo local");
                showToast("‚úÖ Registro guardado exitosamente (local)", "success");
            }
            
            renderTable(printers);
            this.reset();
            showView('inventory');

        } catch (error) {
            console.error("‚ùå Error completo al guardar:", error);
            showToast("‚ùå Error al guardar el registro: " + error.message, "error");
        } finally {
            btn.disabled = false;
            btnText.innerText = "Guardar Registro";
            btnSpinner.classList.add('hidden');
        }
    });

    function deletePrinter(index) {
        if (!window.canDelete || !window.canDelete()) {
            showToast("üîí Solo administradores pueden eliminar registros", "error");
            return;
        }
        if (confirm("¬øEliminar este registro?")) {
            printers.splice(index, 1);
            localStorage.setItem('printers_cache', JSON.stringify(printers));
            renderTable(printers);
        }
    }

    function deletePrinterFromDetails(index) {
        if (!window.canDelete || !window.canDelete()) {
            showToast("üîí Solo administradores pueden eliminar registros", "error");
            return;
        }
        if (confirm("¬øEliminar este equipo del inventario? Esta acci√≥n solo lo eliminar√° de la vista local.")) {
            printers.splice(index, 1);
            localStorage.setItem('printers_cache', JSON.stringify(printers));
            closeDetailsModal();
            renderTable(printers);
            showToast('Equipo eliminado del inventario', 'success');
        }
    }

    function toggleDarkMode() {
        document.documentElement.classList.toggle('dark');
        const isDark = document.documentElement.classList.contains('dark');
        document.getElementById('dark-mode-icon').innerText = isDark ? 'light_mode' : 'dark_mode';
        // Guardar preferencia en localStorage
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    // Funci√≥n para ir al inicio (refrescar y volver a Inventario)
    function goHome() {
        location.reload();
    }

    // Variables globales para las gr√°ficas
    let chartInstances = {};

    // Funci√≥n para mostrar el modal de gr√°ficas
    function showChartsModal() {
        const modal = document.getElementById('charts-modal');
        modal.classList.remove('hidden');
        
        // Generar las gr√°ficas
        setTimeout(() => {
            generateCharts();
        }, 100);
    }

    // Funci√≥n para cerrar el modal de gr√°ficas
    function closeChartsModal() {
        const modal = document.getElementById('charts-modal');
        modal.classList.add('hidden');
        
        // Destruir las gr√°ficas para liberar memoria
        Object.values(chartInstances).forEach(chart => {
            if (chart) chart.destroy();
        });
        chartInstances = {};
    }

    // Funci√≥n para generar todas las gr√°ficas
    function generateCharts() {
        // Registrar el plugin de datalabels globalmente
        Chart.register(ChartDataLabels);
        
        const isDark = document.documentElement.classList.contains('dark');
        const textColor = isDark ? '#e2e8f0' : '#1e293b';
        const gridColor = isDark ? '#334155' : '#e2e8f0';
        
        // 1. Estado de Impresoras
        const statusCounts = {
            'Operativa': printers.filter(p => p.status === 'Operativa').length,
            'Fuera de servicio': printers.filter(p => p.status === 'Fuera de servicio').length,
            'Sin ubicar': printers.filter(p => p.status === 'Sin ubicar').length
        };
        
        if (chartInstances['printerStatus']) chartInstances['printerStatus'].destroy();
        chartInstances['printerStatus'] = new Chart(document.getElementById('chart-printer-status'), {
            type: 'bar',
            data: {
                labels: Object.keys(statusCounts),
                datasets: [{
                    label: 'Cantidad',
                    data: Object.values(statusCounts),
                    backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 30
                    }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: textColor,
                        font: { weight: 'bold', size: 12 },
                        formatter: (value) => value
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: textColor, stepSize: 1 },
                        grid: { color: gridColor }
                    },
                    x: {
                        ticks: { color: textColor },
                        grid: { display: false }
                    }
                }
            }
        });
        
        // 2. Distribuci√≥n por √Årea
        const areaCounts = {};
        printers.forEach(p => {
            areaCounts[p.area] = (areaCounts[p.area] || 0) + 1;
        });
        
        if (chartInstances['byArea']) chartInstances['byArea'].destroy();
        chartInstances['byArea'] = new Chart(document.getElementById('chart-by-area'), {
            type: 'bar',
            data: {
                labels: Object.keys(areaCounts),
                datasets: [{
                    label: 'Cantidad',
                    data: Object.values(areaCounts),
                    backgroundColor: '#0d7ff2',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 30
                    }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: textColor,
                        font: { weight: 'bold', size: 12 },
                        formatter: (value) => value
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: textColor, stepSize: 1 },
                        grid: { color: gridColor }
                    },
                    x: {
                        ticks: { color: textColor },
                        grid: { display: false }
                    }
                }
            }
        });
        
        // 3. Distribuci√≥n por Departamento
        const deptCounts = {};
        printers.forEach(p => {
            deptCounts[p.dept] = (deptCounts[p.dept] || 0) + 1;
        });
        
        if (chartInstances['byDept']) chartInstances['byDept'].destroy();
        chartInstances['byDept'] = new Chart(document.getElementById('chart-by-dept'), {
            type: 'bar',
            data: {
                labels: Object.keys(deptCounts),
                datasets: [{
                    label: 'Cantidad',
                    data: Object.values(deptCounts),
                    backgroundColor: '#8b5cf6',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 30
                    }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: textColor,
                        font: { weight: 'bold', size: 12 },
                        formatter: (value) => value
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: textColor, stepSize: 1 },
                        grid: { color: gridColor }
                    },
                    x: {
                        ticks: { color: textColor },
                        grid: { display: false }
                    }
                }
            }
        });
        
        // 4. Estado de Esc√°ner
        const scannerCounts = {
            'Con Esc√°ner': printers.filter(p => p.escaner === true || p.escaner === 'true').length,
            'Sin Esc√°ner': printers.filter(p => !p.escaner || p.escaner === 'false' || p.escaner === false).length
        };
        
        if (chartInstances['scanner']) chartInstances['scanner'].destroy();
        chartInstances['scanner'] = new Chart(document.getElementById('chart-scanner-status'), {
            type: 'bar',
            data: {
                labels: Object.keys(scannerCounts),
                datasets: [{
                    label: 'Cantidad',
                    data: Object.values(scannerCounts),
                    backgroundColor: ['#10b981', '#94a3b8'],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 30
                    }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: textColor,
                        font: { weight: 'bold', size: 12 },
                        formatter: (value) => value
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: textColor, stepSize: 1 },
                        grid: { color: gridColor }
                    },
                    x: {
                        ticks: { color: textColor },
                        grid: { display: false }
                    }
                }
            }
        });
        
        // 5. Estado de SLNX
        const slnxCounts = {
            'Con SLNX': printers.filter(p => p.slnx === true || p.slnx === 'true').length,
            'Sin SLNX': printers.filter(p => !p.slnx || p.slnx === 'false' || p.slnx === false).length
        };
        
        if (chartInstances['slnx']) chartInstances['slnx'].destroy();
        chartInstances['slnx'] = new Chart(document.getElementById('chart-slnx-status'), {
            type: 'bar',
            data: {
                labels: Object.keys(slnxCounts),
                datasets: [{
                    label: 'Cantidad',
                    data: Object.values(slnxCounts),
                    backgroundColor: ['#3b82f6', '#94a3b8'],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 30
                    }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: textColor,
                        font: { weight: 'bold', size: 12 },
                        formatter: (value) => value
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: textColor, stepSize: 1 },
                        grid: { color: gridColor }
                    },
                    x: {
                        ticks: { color: textColor },
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // Funci√≥n para hacer scroll a las estad√≠sticas
    function scrollToStatistics() {
        const statsSection = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-7');
        if (statsSection) {
            statsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    // Funci√≥n para toggle del men√∫ de configuraci√≥n
    function toggleSettingsMenu() {
        const menu = document.getElementById('settings-menu');
        const isHidden = menu.classList.contains('hidden');
        
        if (isHidden) {
            // Actualizar contenido seg√∫n el m√≥dulo activo antes de mostrar
            updateSettingsMenuContent();
        }
        
        menu.classList.toggle('hidden');
        // Cerrar el men√∫ de m√≥dulos si est√° abierto
        document.getElementById('modules-menu').classList.add('hidden');
    }

    // Funci√≥n para actualizar el contenido del men√∫ seg√∫n el m√≥dulo activo
    function updateSettingsMenuContent() {
        const menuContent = document.getElementById('settings-menu-content');
        
        if (currentTab === 'retired') {
            // Solo Exportar CSV para Retiradas
            menuContent.innerHTML = `
                <button onclick="exportModuleToCSV()" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-3">
                    <span class="material-symbols-outlined text-[20px] text-primary">download</span>
                    <span class="font-semibold text-sm">Exportar CSV</span>
                </button>
                <div class="border-t border-slate-200 dark:border-slate-700 my-2"></div>
                <button onclick="window.firebaseCargarDatos()" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-3">
                    <span class="material-symbols-outlined text-[20px] text-green-500">cloud_download</span>
                    <span class="font-semibold text-sm">üì• Cargar desde Firebase</span>
                </button>
                <button onclick="window.firebaseSincronizarTodo()" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-3">
                    <span class="material-symbols-outlined text-[20px] text-blue-500">cloud_upload</span>
                    <span class="font-semibold text-sm">üì§ Subir a Firebase</span>
                </button>
            `;
        } else {
            // Exportar CSV, Exportar CSV en blanco, Importar CSV para otros m√≥dulos
            menuContent.innerHTML = `
                <button onclick="exportModuleToCSV()" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-3">
                    <span class="material-symbols-outlined text-[20px] text-primary">download</span>
                    <span class="font-semibold text-sm">Exportar CSV</span>
                </button>
                <button onclick="exportModuleBlankCSV()" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-3">
                    <span class="material-symbols-outlined text-[20px] text-emerald-500">description</span>
                    <span class="font-semibold text-sm">Exportar CSV en blanco</span>
                </button>
                <div class="border-t border-slate-200 dark:border-slate-700 my-2"></div>
                <label class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-3 cursor-pointer">
                    <span class="material-symbols-outlined text-[20px] text-amber-500">upload_file</span>
                    <span class="font-semibold text-sm">Importar CSV</span>
                    <input type="file" id="csv-import-${currentTab}" accept=".csv" class="hidden" onchange="importModuleCSV(event)">
                </label>
                <div class="border-t border-slate-200 dark:border-slate-700 my-2"></div>
                <button onclick="window.firebaseCargarDatos()" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-3">
                    <span class="material-symbols-outlined text-[20px] text-green-500">cloud_download</span>
                    <span class="font-semibold text-sm">üì• Cargar desde Firebase</span>
                </button>
                <button onclick="window.firebaseSincronizarTodo()" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-3">
                    <span class="material-symbols-outlined text-[20px] text-blue-500">cloud_upload</span>
                    <span class="font-semibold text-sm">üì§ Subir a Firebase</span>
                </button>
                <div class="px-4 py-2 text-xs text-slate-500 dark:text-slate-400">
                    <p class="font-semibold mb-1">Formato soportado:</p>
                    <p>‚Ä¢ Separador: coma (,) o punto y coma (;)</p>
                </div>
            `;
        }
    }

    // Funci√≥n para toggle del men√∫ de m√≥dulos
    function toggleModulesMenu() {
        const menu = document.getElementById('modules-menu');
        menu.classList.toggle('hidden');
        // Cerrar el men√∫ de configuraci√≥n si est√° abierto
        document.getElementById('settings-menu').classList.add('hidden');
    }

    // Funci√≥n para cambiar de pesta√±a desde el men√∫
    function switchTabFromMenu(tab) {
        switchTab(tab);
        // Cerrar el men√∫ despu√©s de seleccionar
        document.getElementById('modules-menu').classList.add('hidden');
        
        // Actualizar el bot√≥n del men√∫ con el m√≥dulo actual
        const moduleData = {
            'inventory': { icon: 'inventory_2', name: 'Inventario' },
            'retired': { icon: 'delete_sweep', name: 'Retiradas' },
            'toner': { icon: 'local_printshop', name: 'Backup T√≥ner' },
            'counters': { icon: 'calculate', name: 'Contadores' }
        };
        
        document.getElementById('current-module-icon').innerText = moduleData[tab].icon;
        document.getElementById('current-module-name').innerText = moduleData[tab].name;
    }

    // Cerrar los men√∫s si se hace clic fuera
    document.addEventListener('click', function(event) {
        const settingsMenu = document.getElementById('settings-menu');
        const settingsBtn = document.getElementById('settings-btn');
        const modulesMenu = document.getElementById('modules-menu');
        const modulesBtn = document.getElementById('modules-btn');
        const chartsModal = document.getElementById('charts-modal');
        
        // Cerrar men√∫ de configuraci√≥n
        if (settingsMenu && settingsBtn && !settingsMenu.contains(event.target) && !settingsBtn.contains(event.target)) {
            settingsMenu.classList.add('hidden');
        }
        
        // Cerrar men√∫ de m√≥dulos
        if (modulesMenu && modulesBtn && !modulesMenu.contains(event.target) && !modulesBtn.contains(event.target)) {
            modulesMenu.classList.add('hidden');
        }
        
        // Cerrar modal de gr√°ficas al hacer clic fuera
        if (chartsModal && event.target === chartsModal) {
            closeChartsModal();
        }
    });

    // Funciones de exportaci√≥n/importaci√≥n gen√©ricas para todos los m√≥dulos
    function exportModuleToCSV() {
        let headers, rows, filename, data;
        
        switch(currentTab) {
            case 'inventory':
                headers = ["Fecha Reg", "Fecha Inst", "S/N", "MAC", "Modelo", "Ciudad", "Depto", "IP", "Gateway", "Mask", "Direccion", "Area", "Contacto", "Celular", "Estado", "Escaner", "Slnx", "NDD", "Nota", "Contador Inicial"];
                rows = printers.map(p => [
                    p.dateReg, p.dateInst, p.serial, p.mac, p.model, p.city, p.dept, p.ip, p.gateway, p.mask, p.address, p.area, p.contact, p.phone, p.status, p.escaner ? "SI":"NO", p.slnx ? "SI":"NO", p.ndd ? "SI":"NO", p.note, p.counterInitial
                ]);
                filename = `inventario_${new Date().toISOString().split('T')[0]}.csv`;
                break;
                
            case 'retired':
                headers = ["Serial", "Modelo", "Ubicaci√≥n", "Fecha Retiro", "Contacto", "RMA"];
                rows = retired.map(r => [
                    r.serial, r.model, r.location, r.dateRetired || '', r.contact, r.rma || ''
                ]);
                filename = `retiradas_${new Date().toISOString().split('T')[0]}.csv`;
                break;
                
            case 'toner':
                headers = ["Elemento", "Modelo", "Mod.Impresora", "Color", "Ubicaci√≥n", "Fecha", "Estado", "Serial Asignado", "Fecha Asignaci√≥n", "Observaci√≥n"];
                rows = toners.map(t => [
                    t.element, t.model, t.printerModel, t.color, t.location, t.dateReg, t.status, t.assignedTo || '', t.assignedDate || '', t.observation || ''
                ]);
                filename = `backup_toner_${new Date().toISOString().split('T')[0]}.csv`;
                break;
                
            case 'counters':
                headers = ["Serie", "Modelo", "B/N", "Color", "Total", "Ubicaci√≥n"];
                rows = counters.map(c => {
                    const total = (parseFloat(c.bn) || 0) + (parseFloat(c.color) || 0);
                    return [c.serial, c.model, c.bn || 0, c.color || 0, total, c.location || ''];
                });
                filename = `contadores_${new Date().toISOString().split('T')[0]}.csv`;
                break;
                
            default:
                showToast("M√≥dulo no reconocido", "error");
                return;
        }
        
        // Agregar BOM UTF-8 para que Excel lea correctamente los acentos
        const BOM = '\uFEFF';
        const csvContent = [headers, ...rows].map(e => e.map(cell => {
            // Escapar comillas y comas en los valores
            const cellStr = String(cell || '');
            if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                return '"' + cellStr.replace(/"/g, '""') + '"';
            }
            return cellStr;
        }).join(",")).join("\n");
        
        let content = "data:text/csv;charset=utf-8," + encodeURIComponent(BOM + csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", content);
        link.setAttribute("download", filename);
        link.click();
        
        document.getElementById('settings-menu').classList.add('hidden');
        showToast("CSV exportado correctamente", "success");
    }

    function exportModuleBlankCSV() {
        let headers, filename;
        
        switch(currentTab) {
            case 'inventory':
                headers = ["Fecha Reg", "Fecha Inst", "S/N", "MAC", "Modelo", "Ciudad", "Depto", "IP", "Gateway", "Mask", "Direccion", "Area", "Contacto", "Celular", "Estado", "Escaner", "Slnx", "NDD", "Nota", "Contador Inicial"];
                filename = `plantilla_inventario_${new Date().toISOString().split('T')[0]}.csv`;
                break;
                
            case 'toner':
                headers = ["Elemento", "Modelo", "Mod.Impresora", "Color", "Ubicaci√≥n", "Fecha", "Estado", "Observaci√≥n"];
                filename = `plantilla_toner_${new Date().toISOString().split('T')[0]}.csv`;
                break;
                
            case 'counters':
                headers = ["Serie", "Modelo", "B/N", "Color", "Ubicaci√≥n"];
                filename = `plantilla_contadores_${new Date().toISOString().split('T')[0]}.csv`;
                break;
                
            default:
                showToast("M√≥dulo no reconocido", "error");
                return;
        }
        
        // Agregar BOM UTF-8 para Excel
        const BOM = '\uFEFF';
        let content = "data:text/csv;charset=utf-8," + encodeURIComponent(BOM + headers.join(",") + "\n");
        const link = document.createElement("a");
        link.setAttribute("href", content);
        link.setAttribute("download", filename);
        link.click();
        
        document.getElementById('settings-menu').classList.add('hidden');
        showToast("Plantilla CSV descargada correctamente", "success");
    }

    // Los datos CSV se guardan √∫nicamente de forma local

    function importModuleCSV(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                let text = e.target.result;
                // Eliminar BOM si existe
                if (text.charCodeAt(0) === 0xFEFF) {
                    text = text.slice(1);
                }
                
                // Detectar el separador (coma o punto y coma)
                const firstLine = text.split('\n')[0];
                const separator = firstLine.includes(';') ? ';' : ',';
                
                // Parsear CSV
                const lines = text.split('\n').filter(line => line.trim() !== '');
                const headers = lines[0].split(separator).map(h => h.trim());
                
                let newData = [];
                let moduleData, storageKey, renderFunction;
                
                // Procesar seg√∫n el m√≥dulo activo
                switch(currentTab) {
                    case 'inventory':
                        // Validar headers de inventario
                        const requiredInventoryHeaders = ["S/N", "Modelo", "Ciudad"];
                        if (!requiredInventoryHeaders.every(h => headers.some(header => header.includes(h)))) {
                            showToast("El archivo CSV no tiene el formato correcto para Inventario", "error");
                            return;
                        }
                        
                        // Procesar filas
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(separator).map(v => v.trim());
                            if (values.length < 5) continue;
                            
                            const printer = {
                                dateReg: values[0] || '',
                                dateInst: values[1] || 'Instalaci√≥n pendiente',
                                serial: values[2] || '',
                                mac: values[3] || '',
                                model: values[4] || '',
                                city: values[5] || '',
                                dept: values[6] || '',
                                ip: values[7] || '',
                                gateway: values[8] || '',
                                mask: values[9] || '',
                                address: values[10] || '',
                                area: values[11] || '',
                                contact: values[12] || '',
                                phone: values[13] || '',
                                status: values[14] || 'Operativa',
                                escaner: values[15] === 'SI' || values[15] === 'S√ç' || values[15] === 'si' || values[15] === 's√≠',
                                slnx: values[16] === 'SI' || values[16] === 'S√ç' || values[16] === 'si' || values[16] === 's√≠',
                                ndd: values[17] === 'SI' || values[17] === 'S√ç' || values[17] === 'si' || values[17] === 's√≠',
                                note: values[18] || '',
                                counterInitial: values[19] || 0
                            };
                            newData.push(printer);
                        }
                        
                        moduleData = printers;
                        storageKey = 'printers_cache';
                        renderFunction = renderTable;
                        break;
                        
                    case 'toner':
                        // Validar headers de t√≥ner
                        const requiredTonerHeaders = ["Elemento", "Modelo", "Color"];
                        if (!requiredTonerHeaders.every(h => headers.some(header => header.includes(h)))) {
                            showToast("El archivo CSV no tiene el formato correcto para Backup de T√≥ner", "error");
                            return;
                        }
                        
                        // Procesar filas
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(separator).map(v => v.trim());
                            if (values.length < 6) continue;
                            
                            const toner = {
                                element: values[0] || '',
                                model: values[1] || '',
                                printerModel: values[2] || '',
                                color: values[3] || '',
                                location: values[4] || '',
                                dateReg: values[5] || new Date().toLocaleDateString('es-ES'),
                                status: values[6] || 'Disponible',
                                observation: values[7] || ''
                            };
                            newData.push(toner);
                        }
                        
                        moduleData = toners;
                        storageKey = 'toners_cache';
                        renderFunction = renderTonerTable;
                        break;
                        
                    case 'counters':
                        // Validar headers de contadores
                        const requiredCountersHeaders = ["Serie", "Modelo"];
                        if (!requiredCountersHeaders.every(h => headers.some(header => header.includes(h)))) {
                            showToast("El archivo CSV no tiene el formato correcto para Contadores", "error");
                            return;
                        }
                        
                        // Procesar filas
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(separator).map(v => v.trim());
                            if (values.length < 2) continue;
                            
                            const counter = {
                                serial: values[0] || '',
                                model: values[1] || '',
                                bn: values[2] || 0,
                                color: values[3] || 0,
                                location: values[4] || ''
                            };
                            newData.push(counter);
                        }
                        
                        moduleData = counters;
                        storageKey = 'counters_cache';
                        renderFunction = renderCountersTable;
                        break;
                        
                    default:
                        showToast("M√≥dulo no soportado para importaci√≥n", "error");
                        return;
                }
                
                if (newData.length === 0) {
                    showToast("No se encontraron registros v√°lidos en el CSV", "error");
                    return;
                }
                
                // Preguntar si desea reemplazar o agregar
                const replace = confirm(`Se encontraron ${newData.length} registros.\\n\\n¬øDesea REEMPLAZAR los datos actuales?\\n\\nS√≠ = Reemplazar todo\\nNo = Agregar a los datos existentes`);
                
                let finalData;
                if (replace) {
                    finalData = newData;
                } else {
                    finalData = [...moduleData, ...newData];
                }
                
                // Actualizar seg√∫n el m√≥dulo
                if (currentTab === 'inventory') {
                    printers = finalData;
                } else if (currentTab === 'toner') {
                    toners = finalData;
                } else if (currentTab === 'counters') {
                    counters = finalData;
                }
                
                localStorage.setItem(storageKey, JSON.stringify(finalData));
                renderFunction(finalData);
                
                // Cerrar men√∫
                document.getElementById('settings-menu').classList.add('hidden');
                
                showToast(`${newData.length} registros importados correctamente`, "success");
                
                // Guardar en Firebase (async sin bloquear UI)
                if (window.firebaseEnabled) {
                    setTimeout(async () => {
                        try {
                            let savedCount = 0;
                            let errorCount = 0;
                            
                            for (const item of newData) {
                                try {
                                    if (currentTab === 'inventory') {
                                        await window.firebaseCrearImpresora(item);
                                    } else if (currentTab === 'toner') {
                                        await window.firebaseCrearToner(item);
                                    } else if (currentTab === 'counters') {
                                        await window.firebaseAgregarContador(item.serial, item);
                                    }
                                    savedCount++;
                                } catch (error) {
                                    // Si ya existe, no es error cr√≠tico
                                    if (!error.message.includes('ya existe')) {
                                        errorCount++;
                                        console.warn(`Error al guardar en Firebase:`, error.message);
                                    } else {
                                        savedCount++; // Contar como guardado si ya exist√≠a
                                    }
                                }
                            }
                            
                            if (savedCount > 0) {
                                showToast(`üî• ${savedCount} registros sincronizados con Firebase`, "success");
                            }
                            if (errorCount > 0) {
                                showToast(`‚ö†Ô∏è ${errorCount} registros no se pudieron sincronizar`, "error");
                            }
                        } catch (error) {
                            console.error('Error en sincronizaci√≥n masiva:', error);
                        }
                    }, 100);
                }
                
            } catch (error) {
                console.error('Error al importar CSV:', error);
                showToast("Error al procesar el archivo CSV", "error");
            }
            
            // Limpiar input
            event.target.value = '';
        };
        
        // Leer el archivo como UTF-8
        reader.readAsText(file, 'UTF-8');
    }

    // FUNCIONES DE RETIRO
    let currentRetiredIndex = null;

    async function retirePrinter(index) {
        if (!confirm('¬øEst√°s seguro de retirar esta impresora del inventario?')) {
            return;
        }

        const printer = printers[index];
        
        // Crear objeto de retiro con campos vac√≠os para RMA y fecha
        const retiredPrinter = {
            serial: printer.serial,
            model: printer.model,
            location: `${printer.address || ''} ${printer.city || ''} ${printer.dept || ''}`.trim() || 'Sin ubicaci√≥n',
            contact: printer.contact || '-',
            rma: '',
            dateRetired: ''
        };

        // Agregar a retirados
        retired.push(retiredPrinter);
        
        // Eliminar del inventario
        printers.splice(index, 1);
        
        // Guardar en localStorage
        localStorage.setItem('printers_cache', JSON.stringify(printers));
        localStorage.setItem('retired_cache', JSON.stringify(retired));
        
        // Guardar en Firebase
        if (window.firebaseEnabled && typeof window.firebaseRegistrarRetiro === 'function') {
            try {
                await window.firebaseRegistrarRetiro(retiredPrinter);
                console.log('‚úÖ Retiro registrado en Firebase');
            } catch (error) {
                console.warn('‚ö†Ô∏è Error al registrar retiro en Firebase:', error.message);
            }
        }
        
        // Cerrar modal y actualizar
        closeDetailsModal();
        renderTable(printers);
        
        // Mostrar mensaje y cambiar a vista de retiradas
        showToast('‚úÖ Impresora retirada del inventario', 'success');
        switchTab('retired');
    }

    function showRMAModal(index) {
        currentRetiredIndex = index;
        document.getElementById('rma-input').value = '';
        const modal = document.getElementById('rma-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeRMAModal() {
        currentRetiredIndex = null;
        const modal = document.getElementById('rma-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // Manejar env√≠o del formulario RMA
    document.getElementById('rma-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (currentRetiredIndex === null) return;
        
        const rmaNumber = document.getElementById('rma-input').value.trim();
        
        if (!rmaNumber) {
            showToast('Por favor introduce un n√∫mero de RMA v√°lido', 'error');
            return;
        }
        
        // Actualizar el registro retirado con RMA y fecha actual
        retired[currentRetiredIndex].rma = rmaNumber;
        retired[currentRetiredIndex].dateRetired = new Date().toLocaleDateString('es-ES');
        
        // Guardar en localStorage
        localStorage.setItem('retired_cache', JSON.stringify(retired));
        
        // Actualizar tabla
        renderRetiredTable(retired);
        
        // Cerrar modal y mostrar mensaje
        closeRMAModal();
        showToast('Retiro completado con √©xito', 'success');
    });

    // Funciones para el modal de agregar t√≥ner
    function showAddTonerModal() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('toner-fecha').value = today;
        const modal = document.getElementById('add-toner-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeAddTonerModal() {
        const modal = document.getElementById('add-toner-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.getElementById('add-toner-form').reset();
    }

    // Manejar env√≠o del formulario de agregar t√≥ner
    document.getElementById('add-toner-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const newToner = {
            element: document.getElementById('toner-elemento').value,
            model: document.getElementById('toner-modelo').value,
            printerModel: document.getElementById('toner-mod-impresora').value,
            color: document.getElementById('toner-color').value,
            location: document.getElementById('toner-ubicacion').value,
            dateReg: document.getElementById('toner-fecha').value,
            status: document.getElementById('toner-estado').value,
            observation: document.getElementById('toner-observacion').value
        };
        
        toners.push(newToner);
        localStorage.setItem('toners_cache', JSON.stringify(toners));
        
        // Guardar en Firebase
        if (window.firebaseEnabled && typeof window.firebaseCrearToner === 'function') {
            try {
                await window.firebaseCrearToner(newToner);
                console.log('‚úÖ T√≥ner guardado en Firebase');
            } catch (error) {
                console.warn('‚ö†Ô∏è Error al guardar t√≥ner en Firebase:', error.message);
            }
        }
        
        renderTonerTable(toners);
        closeAddTonerModal();
        showToast('‚úÖ T√≥ner agregado correctamente', 'success');
    });

    // Variables y funciones para el modal de asignar t√≥ner
    let currentTonerIndex = null;
    let currentChangingPrinterIndex = null;

    function showAssignTonerModal(index) {
        currentTonerIndex = index;
        document.getElementById('assign-printer-serial').value = '';
        document.getElementById('assign-counter-bn').value = '';
        document.getElementById('assign-counter-color').value = '';
        const modal = document.getElementById('assign-toner-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeAssignTonerModal() {
        currentTonerIndex = null;
        const modal = document.getElementById('assign-toner-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // Manejar env√≠o del formulario de asignar t√≥ner
    document.getElementById('assign-toner-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (currentTonerIndex === null) return;
        
        const printerSerial = document.getElementById('assign-printer-serial').value.trim().toUpperCase();
        const counterBN = parseFloat(document.getElementById('assign-counter-bn').value) || 0;
        const counterColor = parseFloat(document.getElementById('assign-counter-color').value) || 0;
        
        if (!printerSerial) {
            showToast('Por favor introduce un n√∫mero de serie v√°lido', 'error');
            return;
        }
        
        // Validar que el serial exista en el m√≥dulo de Inventario
        const printerExists = printers.find(p => p.serial.toUpperCase() === printerSerial);
        if (!printerExists) {
            showToast('El n√∫mero de serie no est√° registrado en el inventario', 'error');
            return;
        }
        
        // Obtener el modelo de la impresora y su rendimiento
        const model = printerExists.model;
        const yield = tonerYields[model];
        
        if (!yield) {
            showToast('El modelo de impresora no tiene rendimiento de t√≥ner configurado', 'error');
            return;
        }
        
        // Buscar o crear el contador para esta impresora
        let counterIndex = counters.findIndex(c => c.serial.toUpperCase() === printerSerial);
        
        if (counterIndex === -1) {
            // Crear nuevo registro de contador si no existe
            const newCounter = {
                serial: printerSerial,
                model: model,
                bn: counterBN,
                color: counterColor,
                location: printerExists.city || ''
            };
            counters.push(newCounter);
            counterIndex = counters.length - 1;
            
            // Guardar en Firebase
            if (window.firebaseEnabled && typeof window.firebaseAgregarContador === 'function') {
                try {
                    await window.firebaseAgregarContador(printerSerial, newCounter);
                    console.log('‚úÖ Contador creado en Firebase');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error al crear contador en Firebase:', error.message);
                }
            }
        } else {
            // Actualizar contador existente
            counters[counterIndex].bn = counterBN;
            counters[counterIndex].color = counterColor;
        }
        
        // Guardar los cambios en el contador
        localStorage.setItem('counters_cache', JSON.stringify(counters));
        
        // Actualizar el t√≥ner con el serial y cambiar estado a "Usado"
        toners[currentTonerIndex].status = 'Usado';
        toners[currentTonerIndex].assignedTo = printerSerial;
        toners[currentTonerIndex].assignedDate = new Date().toLocaleDateString('es-ES');
        
        // Guardar en localStorage
        localStorage.setItem('toners_cache', JSON.stringify(toners));
        
        // Actualizar tablas
        renderTonerTable(toners);
        renderCountersTable(counters);
        renderTable(printers);
        
        // Cerrar modal y mostrar mensaje
        closeAssignTonerModal();
        showToast(`T√≥ner asignado a impresora ${printerSerial}. Contador actualizado: B/N=${counterBN.toLocaleString()}, Color=${counterColor.toLocaleString()}`, 'success');
    });

    // Funciones para el modal de cambio de t√≥ner
    function showChangeTonerModal(serial) {
        const printerIndex = printers.findIndex(p => p.serial === serial);
        if (printerIndex === -1) {
            showToast('Impresora no encontrada', 'error');
            return;
        }
        currentChangingPrinterIndex = printerIndex;
        const printer = printers[printerIndex];
        
        // Mostrar informaci√≥n del equipo
        document.getElementById('change-toner-serial').textContent = printer.serial;
        document.getElementById('change-toner-model').textContent = printer.model;
        
        // Obtener √∫ltimo contador registrado
        const counterRecords = counters.filter(c => c.serial && c.serial.toUpperCase() === printer.serial.toUpperCase());
        if (counterRecords.length > 0) {
            const latest = counterRecords[counterRecords.length - 1];
            document.getElementById('change-counter-bn').value = latest.bn || 0;
            document.getElementById('change-counter-color').value = latest.color || 0;
        } else {
            document.getElementById('change-counter-bn').value = '';
            document.getElementById('change-counter-color').value = '';
        }
        
        const modal = document.getElementById('change-toner-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeChangeTonerModal() {
        currentChangingPrinterIndex = null;
        const modal = document.getElementById('change-toner-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // Manejar env√≠o del formulario de cambio de t√≥ner
    document.getElementById('change-toner-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (currentChangingPrinterIndex === null) return;
        
        const printer = printers[currentChangingPrinterIndex];
        const counterBN = parseFloat(document.getElementById('change-counter-bn').value) || 0;
        const counterColor = parseFloat(document.getElementById('change-counter-color').value) || 0;
        
        // Obtener el modelo y su rendimiento
        const model = printer.model;
        const yield = tonerYields[model];
        
        if (!yield) {
            showToast('El modelo de impresora no tiene rendimiento de t√≥ner configurado', 'error');
            return;
        }
        
        // Calcular el nuevo contador (ajustar al siguiente m√∫ltiplo del rendimiento)
        let newCounterBN = counterBN;
        let newCounterColor = counterColor;
        
        if (yield.black > 0 && counterBN > 0) {
            const tonerChanges = Math.floor(counterBN / yield.black);
            newCounterBN = (tonerChanges + 1) * yield.black;
        }
        
        if (yield.color > 0 && counterColor > 0) {
            const tonerChanges = Math.floor(counterColor / yield.color);
            newCounterColor = (tonerChanges + 1) * yield.color;
        }
        
        // Buscar o crear el contador para esta impresora
        let counterIndex = counters.findIndex(c => c.serial && c.serial.toUpperCase() === printer.serial.toUpperCase());
        
        if (counterIndex === -1) {
            // Crear nuevo registro de contador
            const newCounter = {
                serial: printer.serial,
                model: model,
                bn: newCounterBN,
                color: newCounterColor,
                location: printer.city || ''
            };
            counters.push(newCounter);
            counterIndex = counters.length - 1;
            
            // Guardar en Firebase
            if (window.firebaseEnabled && typeof window.firebaseAgregarContador === 'function') {
                try {
                    await window.firebaseAgregarContador(printer.serial, newCounter);
                    console.log('‚úÖ Contador creado en Firebase (cambio de t√≥ner)');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error al crear contador en Firebase:', error.message);
                }
            }
        } else {
            // Actualizar contador existente con el nuevo valor ajustado
            counters[counterIndex].bn = newCounterBN;
            counters[counterIndex].color = newCounterColor;
        }
        
        // Guardar los cambios en el contador
        localStorage.setItem('counters_cache', JSON.stringify(counters));
        
        // Actualizar tablas
        renderCountersTable(counters);
        renderTable(printers);
        
        // Cerrar modal y mostrar mensaje
        closeChangeTonerModal();
        showToast(`T√≥ner cambiado. Contador ajustado: B/N=${newCounterBN.toLocaleString()}, Color=${newCounterColor.toLocaleString()}. Porcentaje restablecido al 0%`, 'success');
    });

    // Funci√≥n para ocultar el loader (con respaldo)
    function hideLoader() {
        try {
            const loader = document.getElementById('initial-loader');
            const mainContent = document.getElementById('main-content');
            
            if (loader && mainContent) {
                loader.style.opacity = '0';
                loader.style.transition = 'opacity 0.3s ease-out';
                
                setTimeout(() => {
                    loader.style.display = 'none';
                    mainContent.style.opacity = '1';
                    mainContent.style.transition = 'opacity 0.3s ease-in';
                }, 300);
            }
        } catch (e) {
            console.error('Error al ocultar loader:', e);
        }
    }

    // Intentar ocultar loader de m√∫ltiples formas
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(hideLoader, 100);
        });
    } else {
        setTimeout(hideLoader, 100);
    }

    // Respaldo adicional por si falla todo lo anterior
    setTimeout(hideLoader, 1000);

    window.onload = () => {
        // Verificar tema guardado y actualizar icono
        const savedTheme = localStorage.getItem('theme');
        const isDark = savedTheme === 'dark' || (!savedTheme && true); // Por defecto oscuro
        
        if (isDark) {
            document.documentElement.classList.add('dark');
            document.getElementById('dark-mode-icon').innerText = 'light_mode';
        } else {
            document.documentElement.classList.remove('dark');
            document.getElementById('dark-mode-icon').innerText = 'dark_mode';
        }
        
        renderTable(printers);
        // Establecer fecha de registro actual al cargar
        const today = new Date().toISOString().split('T')[0];
        document.querySelector('input[name="dateReg"]').value = today;
    };
</script>

<!-- Modal de Gesti√≥n de Usuarios -->
<div id="users-modal" class="hidden fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700">
            <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-[32px] text-primary">manage_accounts</span>
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Gesti√≥n de Usuarios</h2>
            </div>
            <button onclick="closeUsersModal()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                <span class="material-symbols-outlined text-[28px]">close</span>
            </button>
        </div>
        
        <!-- Contenido -->
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Formulario crear usuario -->
            <div class="bg-slate-50 dark:bg-slate-900 rounded-xl p-6 mb-6">
                <h3 class="text-lg font-bold mb-4 text-slate-700 dark:text-slate-200">Crear Nuevo Usuario</h3>
                <form id="create-user-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Email</label>
                        <input type="email" id="new-user-email" required
                            class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white focus:ring-2 focus:ring-primary"
                            placeholder="usuario@ricoh.com">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Contrase√±a</label>
                        <input type="password" id="new-user-password" required minlength="6"
                            class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white focus:ring-2 focus:ring-primary"
                            placeholder="M√≠nimo 6 caracteres">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Rol</label>
                        <select id="new-user-role" required
                            class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white focus:ring-2 focus:ring-primary">
                            <option value="admin">Administrador</option>
                            <option value="usuario">Usuario</option>
                        </select>
                    </div>
                    <div class="md:col-span-3">
                        <button type="submit" id="create-user-btn"
                            class="w-full bg-primary hover:bg-blue-600 text-white font-bold py-2.5 rounded-lg transition flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined text-[20px]">person_add</span>
                            <span>Crear Usuario</span>
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Lista de usuarios -->
            <div class="bg-slate-50 dark:bg-slate-900 rounded-xl p-6">
                <h3 class="text-lg font-bold mb-4 text-slate-700 dark:text-slate-200">Usuarios Registrados</h3>
                <div id="users-list" class="space-y-3">
                    <div class="text-center py-8 text-slate-500">
                        <div class="spinner mx-auto mb-2"></div>
                        <p>Cargando usuarios...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Gr√°ficas -->
<div id="charts-modal" class="hidden fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-7xl max-h-[90vh] overflow-hidden flex flex-col">
        <!-- Header del modal -->
        <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700">
            <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-[32px] text-primary">monitoring</span>
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Gr√°ficas del Inventario</h2>
            </div>
            <button onclick="closeChartsModal()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                <span class="material-symbols-outlined text-[28px]">close</span>
            </button>
        </div>
        
        <!-- Contenido del modal -->
        <div class="flex-1 overflow-y-auto p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Gr√°fica: Estado de Impresoras -->
                <div class="bg-slate-50 dark:bg-slate-900 rounded-xl p-6">
                    <h3 class="text-lg font-bold mb-4 text-slate-700 dark:text-slate-200">Estado de Impresoras</h3>
                    <div style="height: 250px;">
                        <canvas id="chart-printer-status"></canvas>
                    </div>
                </div>
                
                <!-- Gr√°fica: Distribuci√≥n por √Årea -->
                <div class="bg-slate-50 dark:bg-slate-900 rounded-xl p-6">
                    <h3 class="text-lg font-bold mb-4 text-slate-700 dark:text-slate-200">Distribuci√≥n por √Årea</h3>
                    <div style="height: 250px;">
                        <canvas id="chart-by-area"></canvas>
                    </div>
                </div>
                
                <!-- Gr√°fica: Distribuci√≥n por Departamento -->
                <div class="bg-slate-50 dark:bg-slate-900 rounded-xl p-6">
                    <h3 class="text-lg font-bold mb-4 text-slate-700 dark:text-slate-200">Distribuci√≥n por Departamento</h3>
                    <div style="height: 250px;">
                        <canvas id="chart-by-dept"></canvas>
                    </div>
                </div>
                
                <!-- Gr√°fica: Estado de Esc√°ner -->
                <div class="bg-slate-50 dark:bg-slate-900 rounded-xl p-6">
                    <h3 class="text-lg font-bold mb-4 text-slate-700 dark:text-slate-200">Estado de Esc√°ner</h3>
                    <div style="height: 250px;">
                        <canvas id="chart-scanner-status"></canvas>
                    </div>
                </div>
                
                <!-- Gr√°fica: Estado de SLNX -->
                <div class="bg-slate-50 dark:bg-slate-900 rounded-xl p-6">
                    <h3 class="text-lg font-bold mb-4 text-slate-700 dark:text-slate-200">Estado de SLNX</h3>
                    <div style="height: 250px;">
                        <canvas id="chart-slnx-status"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Firebase Integration Module -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc,
    runTransaction, serverTimestamp, query, where, orderBy, getDocs, collectionGroup, onSnapshot
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import {
    getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, 
    sendPasswordResetEmail, setPersistence, browserLocalPersistence, browserSessionPersistence
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  // Configuraci√≥n de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCGQqu8MSGOJET7ic_6jmXOlSeIkNUH4wA",
    authDomain: "inventario-web-3dc4d.firebaseapp.com",
    projectId: "inventario-web-3dc4d",
    storageBucket: "inventario-web-3dc4d.firebasestorage.app",
    messagingSenderId: "307333187205",
    appId: "1:307333187205:web:3df9a6e9270267848b8bec",
    measurementId: "G-Y32KKXHYNC"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Variables globales
  window.firebaseEnabled = true;
  window.firebaseDB = db;
  window.firebaseAuth = auth;
  window.currentUser = null;
  window.currentUserRole = null;
  window.authReady = false;
  window.isCheckingAuth = true;

  console.log("‚úÖ Firebase inicializado correctamente");
  
  // Mostrar loader mientras se verifica la autenticaci√≥n
  const initialLoader = document.getElementById('initial-loader');
  const loginScreen = document.getElementById('login-screen');
  if (initialLoader) initialLoader.classList.remove('hidden');
  if (loginScreen) loginScreen.classList.add('hidden');

  // ---------------------------
  //  AUTENTICACI√ìN Y ROLES
  // ---------------------------
  
  // Listener de autenticaci√≥n
  onAuthStateChanged(auth, async (user) => {
    const loader = document.getElementById('initial-loader');
    const loginScreen = document.getElementById('login-screen');
    
    window.isCheckingAuth = false;
    
    if (user) {
      console.log("‚úÖ Usuario autenticado:", user.email);
      window.currentUser = user;
      
      // Obtener rol del usuario desde Firestore
      try {
        console.log("üîç Buscando rol del usuario con UID:", user.uid);
        const userDoc = await getDoc(doc(db, "Usuarios", user.uid));
        
        if (userDoc.exists()) {
          window.currentUserRole = userDoc.data().role;
          console.log("üë§ Rol encontrado:", window.currentUserRole);
          
          // Esperar a que el DOM est√© listo
          const waitForDOM = () => {
            return new Promise((resolve) => {
              if (document.getElementById('login-screen')) {
                resolve();
              } else {
                setTimeout(() => waitForDOM().then(resolve), 50);
              }
            });
          };
          
          await waitForDOM();
          
          // Preparar elementos
          const loader = document.getElementById('initial-loader');
          const loginScreen = document.getElementById('login-screen');
          const mainContent = document.getElementById('main-content');
          const userEmail = document.getElementById('user-email');
          const userRoleBadge = document.getElementById('user-role-badge');
          const userContainer = document.getElementById('user-container');
          const usersBtn = document.getElementById('users-btn');
          
          // Configurar info de usuario ANTES de mostrar la interfaz
          if (userEmail) userEmail.textContent = user.email.split('@')[0];
          if (userRoleBadge) {
            userRoleBadge.textContent = window.currentUserRole.toUpperCase();
            userRoleBadge.className = window.currentUserRole === 'admin' 
              ? 'px-2 py-0.5 text-xs font-bold rounded uppercase bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300'
              : 'px-2 py-0.5 text-xs font-bold rounded uppercase bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300';
          }
          
          // Mostrar contenedor de usuario
          if (userContainer) {
            userContainer.style.visibility = 'visible';
          }
          
          // Mostrar bot√≥n de gesti√≥n de usuarios solo para admins
          if (window.currentUserRole === 'admin' && usersBtn) {
            usersBtn.classList.remove('hidden');
          }
          
          // Aplicar restricciones seg√∫n rol
          if (typeof applyRoleRestrictions === 'function') {
            applyRoleRestrictions();
          }
          
          // Cargar datos iniciales
          if (typeof renderTable === 'function' && typeof printers !== 'undefined') {
            renderTable(printers);
          }
          const today = new Date().toISOString().split('T')[0];
          const dateInput = document.querySelector('input[name="dateReg"]');
          if (dateInput) dateInput.value = today;
          
          // Cargar datos desde Firebase autom√°ticamente
          console.log("üîÑ Cargando datos desde Firebase...");
          try {
            await window.firebaseCargarDatos();
            console.log("‚úÖ Datos sincronizados desde Firebase");
          } catch (error) {
            console.warn("‚ö†Ô∏è Error al cargar datos desde Firebase:", error);
            // Si falla, usar los datos del localStorage
            console.log("üì¶ Usando datos del cach√© local");
          }
          
          // Marcar como listo y mostrar interfaz completa
          window.authReady = true;
          
          // AHORA S√ç mostrar la interfaz completa (despu√©s de configurar todo)
          if (loader) loader.classList.add('hidden');
          if (loginScreen) loginScreen.classList.add('hidden');
          if (mainContent) {
            mainContent.style.visibility = 'visible';
            mainContent.style.opacity = '1';
          }
          
          console.log("‚úÖ Interfaz completa mostrada");
        } else {
          // Usuario sin rol asignado
          console.error("‚ùå Usuario sin documento en Firestore");
          if (typeof showToast === 'function') {
            showToast("‚ùå Usuario sin permisos asignados. Contacta al administrador.", "error");
          } else {
            alert("Usuario sin permisos asignados. Contacta al administrador.");
          }
          await signOut(auth);
        }
      } catch (error) {
        console.error("‚ùå Error al obtener rol:", error);
        if (typeof showToast === 'function') {
          showToast("‚ùå Error al cargar permisos: " + error.message, "error");
        } else {
          alert("Error al cargar permisos: " + error.message);
        }
        await signOut(auth);
      }
    } else {
      // No autenticado - mostrar login
      console.log("‚ùå Usuario no autenticado");
      window.currentUser = null;
      window.currentUserRole = null;
      window.authReady = true;
      
      // Si estamos cerrando sesi√≥n, no mostrar nada (la p√°gina se recargar√°)
      if (window.isLoggingOut) {
        console.log("üîÑ Cerrando sesi√≥n, recargando p√°gina...");
        return;
      }
      
      const loader = document.getElementById('initial-loader');
      const loginScreen = document.getElementById('login-screen');
      const mainContent = document.getElementById('main-content');
      const userContainer = document.getElementById('user-container');
      
      // IMPORTANTE: Ocultar loader y mostrar login
      if (loader) loader.classList.add('hidden');
      if (loginScreen) loginScreen.classList.remove('hidden');
      if (mainContent) {
        mainContent.style.visibility = 'hidden';
        mainContent.style.opacity = '0';
      }
      if (userContainer) {
        userContainer.style.visibility = 'hidden';
      }
      
      console.log("üîë Mostrando pantalla de login");
    }
  });
  
  // Validaci√≥n de email en tiempo real
  window.validateEmail = function(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  };
  
  // Sanitizar input para prevenir XSS
  window.sanitizeInput = function(input) {
    const div = document.createElement('div');
    div.textContent = input;
    return div.innerHTML;
  };
  
  // Mostrar error en campo
  window.showFieldError = function(fieldId, message) {
    const errorDiv = document.getElementById(fieldId + '-error');
    const inputField = document.getElementById(fieldId);
    
    if (errorDiv && inputField) {
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      inputField.setAttribute('aria-invalid', 'true');
      inputField.classList.add('border-red-600');
    }
  };
  
  // Ocultar error en campo
  window.hideFieldError = function(fieldId) {
    const errorDiv = document.getElementById(fieldId + '-error');
    const inputField = document.getElementById(fieldId);
    
    if (errorDiv && inputField) {
      errorDiv.classList.add('hidden');
      inputField.setAttribute('aria-invalid', 'false');
      inputField.classList.remove('border-red-600');
    }
  };
  
  // Funci√≥n de Login
  window.handleLogin = async function(e) {
    e.preventDefault();
    
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    const rememberMe = document.getElementById('remember-me').checked;
    const btn = document.getElementById('login-btn');
    const btnText = document.getElementById('login-btn-text');
    const errorDiv = document.getElementById('login-error');
    const successDiv = document.getElementById('login-success');
    
    // Limpiar mensajes previos
    errorDiv.classList.add('hidden');
    successDiv.classList.add('hidden');
    hideFieldError('login-email');
    hideFieldError('login-password');
    
    // Validar email
    if (!email) {
      showFieldError('login-email', 'El email es obligatorio');
      return;
    }
    
    if (!validateEmail(email)) {
      showFieldError('login-email', 'Formato de email inv√°lido');
      return;
    }
    
    // Validar contrase√±a
    if (!password) {
      showFieldError('login-password', 'La contrase√±a es obligatoria');
      return;
    }
    
    if (password.length < 6) {
      showFieldError('login-password', 'La contrase√±a debe tener al menos 6 caracteres');
      return;
    }
    
    console.log("üîë Intentando login con:", email);
    
    // Deshabilitar bot√≥n y mostrar loading
    btn.disabled = true;
    btnText.innerHTML = '<div class="spinner inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div>Iniciando sesi√≥n...';
    
    try {
      // Configurar persistencia seg√∫n "Recordar sesi√≥n"
      const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
      await setPersistence(auth, persistence);
      
      console.log("üì° Enviando credenciales a Firebase Auth...");
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      console.log("‚úÖ Autenticaci√≥n exitosa, UID:", userCredential.user.uid);
      
      // Mostrar mensaje de √©xito
      successDiv.classList.remove('hidden');
      
      // onAuthStateChanged manejar√° el resto autom√°ticamente
    } catch (error) {
      console.error("‚ùå Error de login:", error.code, error.message);
      let errorMsg = "Error al iniciar sesi√≥n";
      
      if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
        errorMsg = "‚ùå Email o contrase√±a incorrectos";
      } else if (error.code === 'auth/user-not-found') {
        errorMsg = "‚ùå Usuario no encontrado";
      } else if (error.code === 'auth/user-disabled') {
        errorMsg = "‚ùå Cuenta deshabilitada. Contacta al administrador.";
      } else if (error.code === 'auth/too-many-requests') {
        errorMsg = "üîí Demasiados intentos fallidos. Tu cuenta ha sido bloqueada temporalmente. Intenta m√°s tarde o restablece tu contrase√±a.";
      } else if (error.code === 'auth/network-request-failed') {
        errorMsg = "üåê Error de conexi√≥n. Verifica tu internet.";
      } else if (error.code === 'auth/invalid-email') {
        errorMsg = "‚ùå Formato de email inv√°lido";
      } else {
        errorMsg = "‚ùå Error: " + error.message;
      }
      
      errorDiv.textContent = errorMsg;
      errorDiv.classList.remove('hidden');
      btn.disabled = false;
      btnText.textContent = 'Iniciar Sesi√≥n';
    }
  };
  
  // Funci√≥n para mostrar modal de recuperaci√≥n de contrase√±a
  window.showForgotPassword = function() {
    document.getElementById('forgot-password-modal').classList.remove('hidden');
    document.getElementById('reset-email').focus();
  };
  
  // Funci√≥n para cerrar modal de recuperaci√≥n de contrase√±a
  window.closeForgotPassword = function() {
    document.getElementById('forgot-password-modal').classList.add('hidden');
    document.getElementById('reset-email').value = '';
    document.getElementById('reset-message').classList.add('hidden');
  };
  
  // Funci√≥n para enviar email de recuperaci√≥n
  window.handleForgotPassword = async function(e) {
    e.preventDefault();
    
    const email = document.getElementById('reset-email').value.trim();
    const btn = document.getElementById('reset-btn');
    const messageDiv = document.getElementById('reset-message');
    
    if (!email) {
      messageDiv.textContent = 'Por favor ingresa tu email';
      messageDiv.className = 'mt-4 p-3 rounded text-sm bg-red-900/30 text-red-400 border border-red-800';
      messageDiv.classList.remove('hidden');
      return;
    }
    
    if (!validateEmail(email)) {
      messageDiv.textContent = 'Formato de email inv√°lido';
      messageDiv.className = 'mt-4 p-3 rounded text-sm bg-red-900/30 text-red-400 border border-red-800';
      messageDiv.classList.remove('hidden');
      return;
    }
    
    btn.disabled = true;
    btn.textContent = 'Enviando...';
    
    try {
      await sendPasswordResetEmail(auth, email);
      
      messageDiv.textContent = '‚úÖ Email enviado. Revisa tu bandeja de entrada y sigue las instrucciones.';
      messageDiv.className = 'mt-4 p-3 rounded text-sm bg-green-900/30 text-green-400 border border-green-800';
      messageDiv.classList.remove('hidden');
      
      setTimeout(() => {
        closeForgotPassword();
      }, 3000);
    } catch (error) {
      console.error('Error al enviar email de recuperaci√≥n:', error);
      let errorMsg = 'Error al enviar el email';
      
      if (error.code === 'auth/user-not-found') {
        errorMsg = 'No existe una cuenta con este email';
      } else if (error.code === 'auth/invalid-email') {
        errorMsg = 'Formato de email inv√°lido';
      } else if (error.code === 'auth/too-many-requests') {
        errorMsg = 'Demasiados intentos. Intenta m√°s tarde.';
      }
      
      messageDiv.textContent = '‚ùå ' + errorMsg;
      messageDiv.className = 'mt-4 p-3 rounded text-sm bg-red-900/30 text-red-400 border border-red-800';
      messageDiv.classList.remove('hidden');
      
      btn.disabled = false;
      btn.textContent = 'Enviar Enlace';
    }
  };
  
  // Funci√≥n para alternar visibilidad de contrase√±a
  // Funci√≥n para alternar visibilidad de contrase√±a
  window.togglePasswordVisibility = function() {
    const passwordInput = document.getElementById('login-password');
    const passwordIcon = document.getElementById('password-icon');
    
    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      passwordIcon.textContent = 'visibility_off';
    } else {
      passwordInput.type = 'password';
      passwordIcon.textContent = 'visibility';
    }
  };
  
  // Funci√≥n de Logout
  window.handleLogout = async function() {
    try {
      // Marcar que estamos cerrando sesi√≥n
      window.isLoggingOut = true;
      
      // Limpiar el formulario de login
      const emailInput = document.getElementById('login-email');
      const passwordInput = document.getElementById('login-password');
      if (emailInput) emailInput.value = '';
      if (passwordInput) passwordInput.value = '';
      
      // Cerrar sesi√≥n y recargar inmediatamente
      await signOut(auth);
      
      // Recargar la p√°gina inmediatamente sin mostrar toast
      window.location.reload();
      
    } catch (error) {
      console.error("Error al cerrar sesi√≥n:", error);
      window.isLoggingOut = false;
      showToast("‚ùå Error al cerrar sesi√≥n", "error");
    }
  };
  
  // Aplicar restricciones seg√∫n rol
  function applyRoleRestrictions() {
    if (window.currentUserRole === 'usuario') {
      // Usuarios normales: solo lectura en m√≥dulo de Retirados
      // Ocultar botones de eliminar en todas las vistas
      console.log("üîí Aplicando restricciones de usuario est√°ndar");
      
      // Se mantendr√°n las restricciones en las funciones de eliminar
    } else {
      console.log("üîì Permisos completos de administrador");
    }
  }
  
  // Verificar si el usuario puede eliminar
  window.canDelete = function() {
    return window.currentUserRole === 'admin';
  };
  
  // Verificar si el usuario puede editar
  window.canEdit = function() {
    return true; // Todos pueden editar por ahora
  };
  
  // ---------------------------
  //  GESTI√ìN DE USUARIOS
  // ---------------------------
  
  // Mostrar modal de usuarios
  window.showUsersModal = async function() {
    if (window.currentUserRole !== 'admin') {
      showToast("üîí Solo administradores pueden gestionar usuarios", "error");
      return;
    }
    document.getElementById('users-modal').classList.remove('hidden');
    await loadUsersList();
  };
  
  // Cerrar modal
  window.closeUsersModal = function() {
    document.getElementById('users-modal').classList.add('hidden');
  };
  
  // Cargar lista de usuarios
  async function loadUsersList() {
    const container = document.getElementById('users-list');
    container.innerHTML = '<div class="text-center py-8 text-slate-500"><div class="spinner mx-auto mb-2"></div><p>Cargando usuarios...</p></div>';
    
    try {
      const usersSnapshot = await getDocs(collection(db, "Usuarios"));
      
      if (usersSnapshot.empty) {
        container.innerHTML = '<div class="text-center py-8 text-slate-500">No hay usuarios registrados</div>';
        return;
      }
      
      container.innerHTML = '';
      
      usersSnapshot.forEach((doc) => {
        const user = doc.data();
        const isCurrentUser = user.email === window.currentUser.email;
        
        const userCard = document.createElement('div');
        userCard.className = 'flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700';
        userCard.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="flex size-10 items-center justify-center rounded-lg ${user.role === 'admin' ? 'bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300' : 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300'}">
              <span class="material-symbols-outlined text-[20px]">${user.role === 'admin' ? 'admin_panel_settings' : 'person'}</span>
            </div>
            <div>
              <div class="font-bold text-slate-800 dark:text-white">${user.email}</div>
              <div class="text-xs text-slate-500 dark:text-slate-400 uppercase font-semibold">${user.role}</div>
            </div>
            ${isCurrentUser ? '<span class="ml-2 px-2 py-0.5 text-xs bg-primary/10 text-primary rounded font-semibold">T√ö</span>' : ''}
          </div>
          <div class="flex items-center gap-2">
            ${!isCurrentUser ? `
              <button onclick="deleteUser('${doc.id}', '${user.email}')" 
                class="p-2 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition-colors text-red-600 dark:text-red-400" 
                title="Eliminar usuario">
                <span class="material-symbols-outlined text-[20px]">delete</span>
              </button>
            ` : ''}
          </div>
        `;
        container.appendChild(userCard);
      });
      
    } catch (error) {
      console.error("Error al cargar usuarios:", error);
      container.innerHTML = '<div class="text-center py-8 text-red-500">Error al cargar usuarios</div>';
    }
  }
  
  // Crear nuevo usuario
  window.createNewUser = async function(e) {
    e.preventDefault();
    
    const email = document.getElementById('new-user-email').value;
    const password = document.getElementById('new-user-password').value;
    const role = document.getElementById('new-user-role').value;
    const btn = document.getElementById('create-user-btn');
    
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div><span>Creando...</span>';
    
    try {
      // Guardar usuario actual
      const currentUserEmail = window.currentUser.email;
      
      // Crear usuario en Auth
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const newUser = userCredential.user;
      
      // Guardar rol en Firestore
      await setDoc(doc(db, "Usuarios", newUser.uid), {
        email: email,
        role: role,
        createdAt: new Date().toISOString(),
        createdBy: currentUserEmail
      });
      
      // Cerrar sesi√≥n del usuario reci√©n creado y volver al admin
      await signOut(auth);
      
      // Reiniciar sesi√≥n del admin
      setTimeout(() => {
        showToast(`‚úÖ Usuario ${email} creado exitosamente`, "success");
        document.getElementById('create-user-form').reset();
        
        // Nota: El usuario admin necesitar√° volver a iniciar sesi√≥n
        window.location.reload();
      }, 500);
      
    } catch (error) {
      console.error("Error al crear usuario:", error);
      let errorMsg = "Error al crear usuario";
      
      if (error.code === 'auth/email-already-in-use') {
        errorMsg = "Este email ya est√° registrado";
      } else if (error.code === 'auth/weak-password') {
        errorMsg = "La contrase√±a debe tener al menos 6 caracteres";
      } else if (error.code === 'auth/invalid-email') {
        errorMsg = "Email inv√°lido";
      }
      
      showToast(`‚ùå ${errorMsg}`, "error");
      btn.disabled = false;
      btn.innerHTML = '<span class="material-symbols-outlined text-[20px]">person_add</span><span>Crear Usuario</span>';
    }
  };
  
  // Eliminar usuario
  window.deleteUser = async function(uid, email) {
    if (!confirm(`¬øEliminar el usuario ${email}?\n\nNOTA: Debes eliminar manualmente este usuario desde Firebase Console > Authentication`)) {
      return;
    }
    
    try {
      // Eliminar de Firestore
      await deleteDoc(doc(db, "Usuarios", uid));
      
      showToast(`‚ö†Ô∏è Usuario ${email} eliminado de Firestore. Elim√≠nalo tambi√©n de Authentication en Firebase Console.`, "success");
      
      // Recargar lista
      await loadUsersList();
      
    } catch (error) {
      console.error("Error al eliminar usuario:", error);
      showToast("‚ùå Error al eliminar usuario", "error");
    }
  };
  
  // Conectar el formulario de login y validaci√≥n en tiempo real
  document.addEventListener('DOMContentLoaded', () => {
    const loginForm = document.getElementById('login-form');
    if (loginForm) {
      loginForm.addEventListener('submit', window.handleLogin);
    }
    
    // Validaci√≥n en tiempo real del email
    const emailInput = document.getElementById('login-email');
    if (emailInput) {
      emailInput.addEventListener('blur', function() {
        const email = this.value.trim();
        if (email && !validateEmail(email)) {
          showFieldError('login-email', 'Formato de email inv√°lido');
        } else if (email) {
          hideFieldError('login-email');
        }
      });
      
      emailInput.addEventListener('input', function() {
        if (this.value.trim()) {
          hideFieldError('login-email');
        }
      });
    }
    
    // Validaci√≥n en tiempo real de la contrase√±a
    const passwordInput = document.getElementById('login-password');
    if (passwordInput) {
      passwordInput.addEventListener('input', function() {
        if (this.value) {
          hideFieldError('login-password');
        }
      });
    }
    
    // Formulario de recuperaci√≥n de contrase√±a
    const forgotPasswordForm = document.getElementById('forgot-password-form');
    if (forgotPasswordForm) {
      forgotPasswordForm.addEventListener('submit', window.handleForgotPassword);
    }
    
    const createUserForm = document.getElementById('create-user-form');
    if (createUserForm) {
      createUserForm.addEventListener('submit', window.createNewUser);
    }
    
    // Cerrar modal con ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('forgot-password-modal');
        if (modal && !modal.classList.contains('hidden')) {
          closeForgotPassword();
        }
      }
    });
  });

  // ---------------------------
  //  UTILIDADES
  // ---------------------------
  const fmtDate = (d) => {
    const pad = (n) => String(n).padStart(2, '0');
    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
  };

  // ---------------------------
  //  IMPRESORAS (CRUD con unicidad)
  // ---------------------------
  window.firebaseCrearImpresora = async function(data) {
    // Aceptar tanto 'numero_serie' como 'serial'
    const serial = String(data.numero_serie || data.serial || '').trim();
    
    if (!serial) {
      throw new Error('N√∫mero de serie es requerido');
    }

    await runTransaction(db, async (tx) => {
      const serialRef = doc(db, "unique_serials", serial);
      const impRef = doc(db, "impresoras", serial);

      const lock = await tx.get(serialRef);
      const existeImp = await tx.get(impRef);

      if (lock.exists() || existeImp.exists()) {
        throw new Error(`El n√∫mero de serie ${serial} ya existe en Firebase.`);
      }

      // Crea marcador de unicidad
      tx.set(serialRef, { createdAt: serverTimestamp() });

      // Prepara payload
      const payload = {
        fecha_registro: data.dateReg ?? fmtDate(new Date()),
        fecha_instalacion: data.dateInst ?? null,
        numero_serie: serial,
        mac: data.mac ?? "",
        modelo: data.model ?? "",
        ciudad: data.city ?? "",
        departamento: data.dept ?? "",
        ip: data.ip ?? "",
        gateway: data.gateway ?? "",
        mascara: data.mask ?? "",
        direccion: data.address ?? "",
        area: data.area ?? "",
        contacto: data.contact ?? "",
        telefono: data.phone ?? "",
        estado: data.status ?? "Operativa",
        escaner: Boolean(data.escaner),
        slnx: Boolean(data.slnx),
        ndd: Boolean(data.ndd),
        contador_inicial: Number(data.counterInitial ?? 0),
        nota: data.note ?? "",
        fecha_creacion: serverTimestamp(),
        fecha_actualizacion: serverTimestamp()
      };

      tx.set(impRef, payload);
    });

    console.log(`‚úÖ Impresora ${serial} creada en Firebase`);
    return serial;
  };

  window.firebaseActualizarImpresora = async function(numero_serie, patch) {
    const impRef = doc(db, "impresoras", numero_serie);
    await updateDoc(impRef, {
      ...patch,
      fecha_actualizacion: serverTimestamp()
    });
    console.log(`‚úÖ Impresora ${numero_serie} actualizada en Firebase`);
  };

  window.firebaseObtenerImpresoras = async function() {
    const q = query(
      collection(db, "impresoras"),
      orderBy("fecha_creacion", "desc")
    );
    const snap = await getDocs(q);
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  };

  // ---------------------------
  //  CONTADORES (subcolecci√≥n)
  // ---------------------------
  window.firebaseAgregarContador = async function(numero_serie, data) {
    const ref = collection(db, "impresoras", numero_serie, "contadores");
    await addDoc(ref, {
      numero_serie,
      modelo: data.model ?? "",
      contador_bn: Number(data.bn ?? 0),
      contador_color: Number(data.color ?? 0),
      ubicacion: data.location ?? "",
      fecha_registro: serverTimestamp(),
      fecha_actualizacion: serverTimestamp()
    });
    console.log(`‚úÖ Contador agregado para ${numero_serie}`);
  };

  window.firebaseObtenerContadores = async function(numero_serie) {
    const snap = await getDocs(collection(db, "impresoras", numero_serie, "contadores"));
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  };
  
  // Obtener TODOS los contadores de TODAS las impresoras
  window.firebaseObtenerTodosContadores = async function() {
    try {
      const impresoras = await getDocs(collection(db, "impresoras"));
      const todosContadores = [];
      
      for (const impDoc of impresoras.docs) {
        const contadoresSnap = await getDocs(
          query(
            collection(db, "impresoras", impDoc.id, "contadores"),
            orderBy("fecha_registro", "desc")
          )
        );
        
        contadoresSnap.docs.forEach(contadorDoc => {
          todosContadores.push({
            id: contadorDoc.id,
            ...contadorDoc.data()
          });
        });
      }
      
      return todosContadores;
    } catch (error) {
      console.error("Error al obtener todos los contadores:", error);
      return [];
    }
  };

  // ---------------------------
  //  TONERS
  // ---------------------------
  window.firebaseCrearToner = async function(data) {
    const docRef = await addDoc(collection(db, "toners"), {
      elemento: data.element ?? "",
      modelo: data.model ?? "",
      modelo_impresora: data.printerModel ?? "",
      color: data.color ?? "Negro",
      ubicacion: data.location ?? "",
      fecha_registro: data.dateReg ?? fmtDate(new Date()),
      estado: data.status ?? "Disponible",
      asignado_a: data.assignedTo ?? null,
      fecha_asignacion: data.assignedDate ?? null,
      observacion: data.observation ?? "",
      fecha_creacion: serverTimestamp()
    });
    console.log(`‚úÖ T√≥ner ${docRef.id} creado en Firebase`);
    return docRef.id;
  };

  window.firebaseAsignarToner = async function(tonerId, numero_serie) {
    const tRef = doc(db, "toners", tonerId);
    await updateDoc(tRef, {
      estado: "Usado",
      asignado_a: numero_serie,
      fecha_asignacion: fmtDate(new Date())
    });
    console.log(`‚úÖ T√≥ner ${tonerId} asignado a ${numero_serie}`);
  };

  window.firebaseObtenerToners = async function() {
    const q = query(
      collection(db, "toners"),
      orderBy("fecha_creacion", "desc")
    );
    const snap = await getDocs(q);
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  };

  // ---------------------------
  //  RETIRADOS
  // ---------------------------
  window.firebaseRegistrarRetiro = async function(data) {
    await addDoc(collection(db, "retirados"), {
      numero_serie: data.serial,
      modelo: data.model ?? "",
      ubicacion: data.location ?? "",
      contacto: data.contact ?? "",
      rma: data.rma ?? null,
      fecha_retiro: data.dateRetired ?? null,
      motivo: data.motivo ?? "",
      fecha_creacion: serverTimestamp()
    });
    console.log(`‚úÖ Retiro registrado para ${data.serial}`);
  };

  window.firebaseObtenerRetirados = async function() {
    const q = query(
      collection(db, "retirados"),
      orderBy("fecha_creacion", "desc")
    );
    const snap = await getDocs(q);
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  };

  // ---------------------------
  //  HISTORIAL TAREAS (subcolecci√≥n)
  // ---------------------------
  window.firebaseAgregarTarea = async function(numero_serie, data) {
    const ref = collection(db, "impresoras", numero_serie, "historial_tareas");
    await addDoc(ref, {
      numero_serie,
      fecha: serverTimestamp(),
      nota: data.note ?? "",
      usuario: data.usuario ?? null,
      tipo_tarea: data.tipo_tarea ?? "Nota general"
    });
    console.log(`‚úÖ Tarea agregada para ${numero_serie}`);
  };

  window.firebaseObtenerTareas = async function(numero_serie) {
    const q = query(
      collectionGroup(db, "historial_tareas"),
      where("numero_serie", "==", numero_serie),
      orderBy("fecha", "desc")
    );
    const snap = await getDocs(q);
    return snap.docs.map(d => d.data());
  };

  // ---------------------------
  //  SINCRONIZACI√ìN INICIAL
  // ---------------------------
  window.firebaseSincronizarTodo = async function() {
    try {
      console.log("üîÑ Sincronizando datos con Firebase...");
      
      // Sincronizar impresoras
      if (window.printers && window.printers.length > 0) {
        for (const printer of window.printers) {
          if (printer.serial) {
            try {
              await window.firebaseCrearImpresora({
                numero_serie: printer.serial,
                dateReg: printer.dateReg,
                dateInst: printer.dateInst,
                mac: printer.mac,
                model: printer.model,
                city: printer.city,
                dept: printer.dept,
                ip: printer.ip,
                gateway: printer.gateway,
                mask: printer.mask,
                address: printer.address,
                area: printer.area,
                contact: printer.contact,
                phone: printer.phone,
                status: printer.status,
                escaner: printer.escaner,
                slnx: printer.slnx,
                ndd: printer.ndd,
                counterInitial: printer.counterInitial,
                note: printer.note
              });
            } catch (error) {
              // Si ya existe, ignorar
              if (!error.message.includes("ya existe")) {
                console.warn(`‚ö†Ô∏è Error al sincronizar impresora ${printer.serial}:`, error.message);
              }
            }
          }
        }
      }

      // Sincronizar toners
      if (window.toners && window.toners.length > 0) {
        for (const toner of window.toners) {
          try {
            await window.firebaseCrearToner(toner);
          } catch (error) {
            console.warn("‚ö†Ô∏è Error al sincronizar t√≥ner:", error.message);
          }
        }
      }

      // Sincronizar retirados
      if (window.retired && window.retired.length > 0) {
        for (const retired of window.retired) {
          try {
            await window.firebaseRegistrarRetiro(retired);
          } catch (error) {
            console.warn("‚ö†Ô∏è Error al sincronizar retiro:", error.message);
          }
        }
      }

      console.log("‚úÖ Sincronizaci√≥n completada");
      showToast("‚úÖ Datos sincronizados con Firebase", "success");
    } catch (error) {
      console.error("‚ùå Error en sincronizaci√≥n:", error);
      showToast("‚ö†Ô∏è Error al sincronizar algunos datos", "error");
    }
  };

  // ---------------------------
  //  CARGAR DATOS DESDE FIREBASE
  // ---------------------------
  window.firebaseCargarDatos = async function() {
    try {
      console.log("üì• Cargando datos desde Firebase...");
      
      // Inicializar arrays vac√≠os por si no hay datos
      window.printers = window.printers || [];
      window.toners = window.toners || [];
      window.retired = window.retired || [];
      window.counters = window.counters || [];
      
      // Cargar impresoras
      const impresoras = await window.firebaseObtenerImpresoras();
      if (impresoras && impresoras.length > 0) {
        window.printers = impresoras.map(imp => ({
          dateReg: imp.fecha_registro,
          dateInst: imp.fecha_instalacion,
          serial: imp.numero_serie,
          mac: imp.mac,
          model: imp.modelo,
          city: imp.ciudad,
          dept: imp.departamento,
          ip: imp.ip,
          gateway: imp.gateway,
          mask: imp.mascara,
          address: imp.direccion,
          area: imp.area,
          contact: imp.contacto,
          phone: imp.telefono,
          status: imp.estado,
          escaner: imp.escaner,
          slnx: imp.slnx,
          ndd: imp.ndd,
          counterInitial: imp.contador_inicial,
          note: imp.nota
        }));
        localStorage.setItem('printers_cache', JSON.stringify(window.printers));
      }

      // Cargar toners
      const toners = await window.firebaseObtenerToners();
      if (toners && toners.length > 0) {
        window.toners = toners.map(t => ({
          element: t.elemento,
          model: t.modelo,
          printerModel: t.modelo_impresora,
          color: t.color,
          location: t.ubicacion,
          dateReg: t.fecha_registro,
          status: t.estado,
          assignedTo: t.asignado_a,
          assignedDate: t.fecha_asignacion,
          observation: t.observacion
        }));
        localStorage.setItem('toners_cache', JSON.stringify(window.toners));
      }

      // Cargar retirados
      const retirados = await window.firebaseObtenerRetirados();
      if (retirados && retirados.length > 0) {
        window.retired = retirados.map(r => ({
          serial: r.numero_serie,
          model: r.modelo,
          location: r.ubicacion,
          contact: r.contacto,
          rma: r.rma,
          dateRetired: r.fecha_retiro
        }));
        localStorage.setItem('retired_cache', JSON.stringify(window.retired));
      }
      
      // Cargar contadores desde Firebase
      console.log("üìä Cargando contadores desde Firebase...");
      const todosContadores = await window.firebaseObtenerTodosContadores();
      if (todosContadores && todosContadores.length > 0) {
        window.counters = todosContadores.map(c => ({
          serial: c.numero_serie,
          model: c.modelo,
          bn: c.contador_bn,
          color: c.contador_color,
          location: c.ubicacion,
          dateReg: c.fecha_registro?.toDate?.() ? c.fecha_registro.toDate().toISOString().split('T')[0] : c.fecha_registro
        }));
        localStorage.setItem('counters_cache', JSON.stringify(window.counters));
        console.log(`‚úÖ ${window.counters.length} contadores cargados`);
      } else {
        console.log("‚ÑπÔ∏è No hay contadores en Firebase");
      }
      
      console.log("‚úÖ Datos cargados desde Firebase");
      
      // Asegurar que las variables existan antes de mostrar el resumen
      const printersCount = window.printers ? window.printers.length : 0;
      const tonersCount = window.toners ? window.toners.length : 0;
      const retiredCount = window.retired ? window.retired.length : 0;
      console.log(`üìä Resumen: ${printersCount} impresoras, ${tonersCount} t√≥ners, ${retiredCount} retirados`);
      
      // Actualizar las tablas solo si existen datos
      if (window.printers && typeof renderTable === 'function') renderTable(window.printers);
      if (window.toners && typeof renderTonerTable === 'function') renderTonerTable(window.toners);
      if (window.retired && typeof renderRetiredTable === 'function') renderRetiredTable(window.retired);
      if (window.counters && typeof renderCountersTable === 'function') renderCountersTable(window.counters);
      
      // No mostrar toast aqu√≠, ya se muestra en el proceso de autenticaci√≥n
    } catch (error) {
      console.error("‚ùå Error al cargar datos desde Firebase:", error);
      showToast("‚ö†Ô∏è Error al cargar datos. Usando datos locales.", "error");
    }
  };

  // Exponer funciones globalmente para debugging
  window.firebase = {
    crearImpresora: window.firebaseCrearImpresora,
    actualizarImpresora: window.firebaseActualizarImpresora,
    obtenerImpresoras: window.firebaseObtenerImpresoras,
    agregarContador: window.firebaseAgregarContador,
    crearToner: window.firebaseCrearToner,
    obtenerToners: window.firebaseObtenerToners,
    registrarRetiro: window.firebaseRegistrarRetiro,
    agregarTarea: window.firebaseAgregarTarea,
    sincronizarTodo: window.firebaseSincronizarTodo,
    cargarDatos: window.firebaseCargarDatos,
    db: db
  };

  console.log("üî• Firebase API disponible en window.firebase");
</script>

</body>
</html>

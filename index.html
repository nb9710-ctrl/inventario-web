<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>PrinterAdmin - Registro a Google Sheets</title>
    <!-- Google Fonts & Material Symbols -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0d7ff2",
                        "background-light": "#f5f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        
        .view-fade { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .truncate-cell {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid currentColor;
            width: 18px;
            height: 18px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tooltips personalizados */
        .tooltip-wrapper { position: relative; display: inline-block; }
        .custom-tooltip {
            position: fixed;
            z-index: 9999;
            display: none;
            min-width: 200px;
            max-width: min(320px, calc(100vw - 40px));
            background: white;
            border: 2px solid #2563eb;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            pointer-events: none;
            animation: tooltipFadeIn 0.2s ease-out;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            line-height: 1.4;
        }
        .dark .custom-tooltip {
            background: #1e293b;
            border-color: #3b82f6;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(59, 130, 246, 0.2);
        }
        .tooltip-wrapper:hover .custom-tooltip { display: block; }
        .tooltip-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }
        .dark .tooltip-title { color: #94a3b8; }
        .tooltip-value {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 12px;
            word-wrap: break-word;
        }
        .dark .tooltip-value { color: #e2e8f0; }
        .tooltip-value:last-child { margin-bottom: 0; }
        .tooltip-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            margin-right: 6px;
            margin-bottom: 6px;
        }
        .badge-yes { background: #dcfce7; color: #166534; }
        .dark .badge-yes { background: #14532d; color: #86efac; }
        .badge-no { background: #f1f5f9; color: #64748b; }
        .dark .badge-no { background: #334155; color: #94a3b8; }
        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Barra de progreso circular */
        .circular-progress {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: conic-gradient(
                var(--progress-color) calc(var(--progress) * 1%),
                #e5e7eb calc(var(--progress) * 1%)
            );
        }
        .dark .circular-progress {
            background: conic-gradient(
                var(--progress-color) calc(var(--progress) * 1%),
                #374151 calc(var(--progress) * 1%)
            );
        }
        .circular-progress::before {
            content: '';
            position: absolute;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
        }
        .dark .circular-progress::before {
            background: #1a2632;
        }
        .circular-progress-text {
            position: relative;
            z-index: 1;
            font-size: 8px;
            font-weight: 900;
            color: #1e293b;
        }
        .dark .circular-progress-text {
            color: #e2e8f0;
        }
        
        /* Dropdown menu animation */
        #settings-menu, #modules-menu {
            animation: dropdownFadeIn 0.2s ease-out;
        }
        @keyframes dropdownFadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    <script>
        // Aplicar tema antes de que se muestre el contenido para evitar flash
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && true)) { // Por defecto oscuro
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
</head>
<body class="bg-background-light dark:bg-background-dark text-[#111418] dark:text-white font-display antialiased overflow-x-hidden">

<!-- Loader inicial -->
<div id="initial-loader" class="fixed inset-0 bg-white dark:bg-[#1a2632] z-[9999] flex items-center justify-center">
    <div class="flex flex-col items-center gap-4">
        <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
        <p class="text-lg font-bold text-slate-600 dark:text-slate-300">Cargando...</p>
    </div>
</div>

<div class="relative flex min-h-screen flex-col" style="opacity: 0;" id="main-content">
    <!-- Header -->
    <header class="sticky top-0 z-50 flex items-center justify-between border-b border-solid border-slate-200 dark:border-slate-800 bg-white dark:bg-[#1a2632] px-6 py-3 lg:px-10">
        <div class="flex items-center gap-4 cursor-pointer" onclick="goHome()" title="Recargar aplicación">
            <div class="flex size-10 items-center justify-center rounded-lg bg-primary/10 text-primary">
                <span class="material-symbols-outlined text-[28px]">print_connect</span>
            </div>
            <h2 class="text-4xl font-black leading-tight tracking-[-0.015em] text-red-600 dark:text-red-500">RICOH</h2>
        </div>
        
        <div class="flex-1"></div>
        
        <div class="flex items-center gap-4">
            <!-- Botón Gráficas -->
            <button onclick="showChartsModal()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" title="Ver Gráficas">
                <span class="material-symbols-outlined text-[24px]">monitoring</span>
            </button>
            
            <!-- Menú de módulos -->
            <div class="relative">
                <button onclick="toggleModulesMenu()" id="modules-btn" class="flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                    <span class="material-symbols-outlined" id="current-module-icon">inventory_2</span>
                    <span class="font-bold text-sm" id="current-module-name">Inventario</span>
                    <span class="material-symbols-outlined text-[18px]">expand_more</span>
                </button>
                <div id="modules-menu" class="hidden absolute right-0 mt-2 w-56 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-700 py-2 z-50">
                    <button onclick="switchTabFromMenu('inventory')" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-3">
                        <span class="material-symbols-outlined text-[20px] text-primary">inventory_2</span>
                        <span class="font-semibold text-sm">Inventario</span>
                    </button>
                    <button onclick="switchTabFromMenu('retired')" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-3">
                        <span class="material-symbols-outlined text-[20px] text-red-500">delete_sweep</span>
                        <span class="font-semibold text-sm">Retiradas</span>
                    </button>
                    <button onclick="switchTabFromMenu('toner')" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-3">
                        <span class="material-symbols-outlined text-[20px] text-purple-500">local_printshop</span>
                        <span class="font-semibold text-sm">Backup Tóner</span>
                    </button>
                    <button onclick="switchTabFromMenu('counters')" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-3">
                        <span class="material-symbols-outlined text-[20px] text-emerald-500">calculate</span>
                        <span class="font-semibold text-sm">Contadores</span>
                    </button>
                </div>
            </div>
            
            <!-- Menú de configuración -->
            <div class="relative">
                <button onclick="toggleSettingsMenu()" id="settings-btn" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                    <span class="material-symbols-outlined">download</span>
                </button>
                <div id="settings-menu" class="hidden absolute right-0 mt-2 w-64 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-700 py-2 z-50">
                    <div id="settings-menu-content">
                        <!-- Contenido dinámico según módulo activo -->
                    </div>
                </div>
            </div>
            <button onclick="toggleDarkMode()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                <span class="material-symbols-outlined" id="dark-mode-icon">dark_mode</span>
            </button>
        </div>
    </header>

    <!-- Overlay Notificaciones -->
    <div id="toast-container" class="fixed top-20 right-5 z-[100] flex flex-col gap-2"></div>

    <!-- VISTA 1: INVENTARIO -->
    <main id="inventory-view" class="view-fade flex-1 px-4 py-8 md:px-6 lg:px-10">
        <div class="mx-auto w-full">
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 pb-8">
                <div class="flex flex-col gap-2">
                    <h1 class="text-3xl font-black leading-tight tracking-[-0.033em]">Inventario General</h1>
                    <p class="text-slate-500 dark:text-slate-400">Información registrada de impresoras.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="showView('form')" class="flex items-center justify-center rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold shadow-md hover:bg-blue-600 transition-all">
                        <span class="material-symbols-outlined mr-2 text-[20px]">add</span> Nueva Impresora
                    </button>
                </div>
            </div>

            <!-- Gráficas de estadísticas -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pb-6">
                <!-- Gráfica: Estado de Impresora -->
                <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#1a2632] shadow-sm p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">assessment</span>
                        Estado de Impresoras
                    </h3>
                    <div class="grid grid-cols-3 gap-3">
                        <div onclick="togglePrinterStatusFilter('Operativa')" class="cursor-pointer transition-all hover:scale-105 active:scale-95 p-4 rounded-lg bg-emerald-50 dark:bg-emerald-900/20 border-2 border-transparent hover:border-emerald-500" id="chart-operativa">
                            <div class="text-3xl font-black text-emerald-600" id="count-operativa">0</div>
                            <div class="text-xs font-semibold text-emerald-700 dark:text-emerald-400 mt-1">Operativa</div>
                        </div>
                        <div onclick="togglePrinterStatusFilter('Fuera de servicio')" class="cursor-pointer transition-all hover:scale-105 active:scale-95 p-4 rounded-lg bg-red-50 dark:bg-red-900/20 border-2 border-transparent hover:border-red-500" id="chart-fuera">
                            <div class="text-3xl font-black text-red-600" id="count-fuera">0</div>
                            <div class="text-xs font-semibold text-red-700 dark:text-red-400 mt-1">Fuera de servicio</div>
                        </div>
                        <div onclick="togglePrinterStatusFilter('Sin ubicar')" class="cursor-pointer transition-all hover:scale-105 active:scale-95 p-4 rounded-lg bg-amber-50 dark:bg-amber-900/20 border-2 border-transparent hover:border-amber-500" id="chart-sinubicar">
                            <div class="text-3xl font-black text-amber-600" id="count-sinubicar">0</div>
                            <div class="text-xs font-semibold text-amber-700 dark:text-amber-400 mt-1">Sin ubicar</div>
                        </div>
                    </div>
                </div>

                <!-- Gráfica: Estado de Tóner -->
                <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#1a2632] shadow-sm p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">local_printshop</span>
                        Estado de Tóner
                    </h3>
                    <div class="grid grid-cols-4 gap-3">
                        <div onclick="toggleTonerStatusFilter('0-29')" class="cursor-pointer transition-all hover:scale-105 active:scale-95 p-4 rounded-lg bg-emerald-50 dark:bg-emerald-900/20 border-2 border-transparent hover:border-emerald-500" id="chart-toner-0">
                            <div class="text-3xl font-black text-emerald-600" id="count-toner-0">0</div>
                            <div class="text-xs font-semibold text-emerald-700 dark:text-emerald-400 mt-1">0-29%</div>
                        </div>
                        <div onclick="toggleTonerStatusFilter('30-49')" class="cursor-pointer transition-all hover:scale-105 active:scale-95 p-4 rounded-lg bg-yellow-50 dark:bg-yellow-900/20 border-2 border-transparent hover:border-yellow-500" id="chart-toner-30">
                            <div class="text-3xl font-black text-yellow-600" id="count-toner-30">0</div>
                            <div class="text-xs font-semibold text-yellow-700 dark:text-yellow-400 mt-1">30-49%</div>
                        </div>
                        <div onclick="toggleTonerStatusFilter('50-79')" class="cursor-pointer transition-all hover:scale-105 active:scale-95 p-4 rounded-lg bg-orange-50 dark:bg-orange-900/20 border-2 border-transparent hover:border-orange-500" id="chart-toner-50">
                            <div class="text-3xl font-black text-orange-600" id="count-toner-50">0</div>
                            <div class="text-xs font-semibold text-orange-700 dark:text-orange-400 mt-1">50-79%</div>
                        </div>
                        <div onclick="toggleTonerStatusFilter('80-100')" class="cursor-pointer transition-all hover:scale-105 active:scale-95 p-4 rounded-lg bg-red-50 dark:bg-red-900/20 border-2 border-transparent hover:border-red-500" id="chart-toner-80">
                            <div class="text-3xl font-black text-red-600" id="count-toner-80">0</div>
                            <div class="text-xs font-semibold text-red-700 dark:text-red-400 mt-1">80-100%</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#1a2632] shadow-sm overflow-hidden">
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-left text-[11px] whitespace-nowrap">
                        <thead class="bg-slate-50 dark:bg-[#23303d] border-b border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300">
                            <tr>
                                <th class="px-2 py-3 font-bold uppercase text-[10px]" style="min-width: 110px;">Serie</th>
                                <th class="px-2 py-3 font-bold uppercase text-[10px]" style="min-width: 90px;">Modelo</th>
                                <th class="px-2 py-3 font-bold uppercase text-[10px]" style="min-width: 80px;">Ciudad</th>
                                <th class="px-2 py-3 font-bold uppercase text-[10px]" style="min-width: 90px;">Dpto</th>
                                <th class="px-2 py-3 font-bold uppercase text-[10px]" style="min-width: 140px;">Dirección</th>
                                <th class="px-2 py-3 font-bold uppercase text-[10px]" style="min-width: 80px;">Área</th>
                                <th class="px-2 py-3 font-bold uppercase text-[10px]" style="min-width: 90px;">Contacto</th>
                                <th class="px-2 py-3 font-bold uppercase text-[10px]" style="min-width: 110px;">Estado</th>
                                <th class="px-2 py-3 font-bold uppercase text-[10px]" style="min-width: 140px;">Tóner</th>
                                <th class="px-2 py-3 font-bold uppercase text-center text-[10px]" style="min-width: 60px;">Acc</th>
                            </tr>
                            <tr class="bg-white dark:bg-[#1a2632]">
                                <th class="px-3 py-2">
                                    <input type="text" id="filter-serial" oninput="filterTableByColumns()" placeholder="Filtrar..." class="w-full text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary" />
                                </th>
                                <th class="px-3 py-2">
                                    <input type="text" id="filter-model" oninput="filterTableByColumns()" placeholder="Filtrar..." class="w-full text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary" />
                                </th>
                                <th class="px-3 py-2">
                                    <input type="text" id="filter-city" oninput="filterTableByColumns()" placeholder="Filtrar..." class="w-full text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary" />
                                </th>
                                <th class="px-3 py-2">
                                    <input type="text" id="filter-dept" oninput="filterTableByColumns()" placeholder="Filtrar..." class="w-full text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary" />
                                </th>
                                <th class="px-3 py-2">
                                    <input type="text" id="filter-address" oninput="filterTableByColumns()" placeholder="Filtrar..." class="w-full text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary" />
                                </th>
                                <th class="px-3 py-2">
                                    <input type="text" id="filter-area" oninput="filterTableByColumns()" placeholder="Filtrar..." class="w-full text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary" />
                                </th>
                                <th class="px-3 py-2">
                                    <input type="text" id="filter-contact" oninput="filterTableByColumns()" placeholder="Filtrar..." class="w-full text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary" />
                                </th>
                                <th class="px-3 py-2">
                                    <select id="filter-status" onchange="filterTableByColumns()" class="w-full text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary">
                                        <option value="">Todas</option>
                                        <option value="Operativa">Operativa</option>
                                        <option value="Fuera de servicio">Fuera de servicio</option>
                                        <option value="Sin ubicar">Sin ubicar</option>
                                    </select>
                                </th>
                                <th class="px-3 py-2" style="min-width: 170px;">
                                    <select id="filter-toner" onchange="filterTableByColumns()" class="w-full text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary">
                                        <option value="">Todos</option>
                                        <option value="verde">🟢 Buen estado (0-29%)</option>
                                        <option value="amarillo">🟡 Medio (30-49%)</option>
                                        <option value="naranja">🟠 Próx. cambio (50-79%)</option>
                                        <option value="rojo">🔴 Crítico (80-100%)</option>
                                    </select>
                                </th>
                                <th class="px-3 py-2" style="min-width: 80px;">
                                    <!-- Sin filtro para acciones -->
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                    </table>
                </div>
                <div class="px-6 py-4 bg-slate-50/50 dark:bg-slate-900/20 border-t border-slate-200 dark:border-slate-800">
                    <p class="text-xs text-slate-500" id="tableStats"></p>
                </div>
            </div>
        </div>
    </main>

    <!-- VISTA 2: FORMULARIO DE REGISTRO -->
    <main id="form-view" class="view-fade flex-1 hidden px-4 py-8 md:px-10 lg:px-20 xl:px-40">
        <div class="max-w-[1200px] mx-auto w-full">
            <div class="flex items-center gap-2 mb-6">
                <button onclick="showView('inventory')" class="text-primary hover:underline flex items-center gap-1 font-medium">
                    <span class="material-symbols-outlined">arrow_back</span> Volver al Inventario
                </button>
            </div>

            <h1 class="text-3xl font-black mb-8">Formulario Técnico de Registro</h1>

            <form id="printerRegistrationForm" class="space-y-8 pb-20">
                <!-- Secciones de Formulario -->
                <div class="bg-white dark:bg-[#1a202c] p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                    <h3 class="text-lg font-bold mb-6 flex items-center gap-2 border-b pb-2 dark:border-slate-700 text-primary">
                        <span class="material-symbols-outlined">schedule</span> Fechas y Equipo
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Fecha Registro</span>
                            <input required name="dateReg" type="date" readonly class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 cursor-not-allowed"/>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Fecha Instalación</span>
                            <input name="dateInst" type="text" value="Instalación pendiente" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700 text-amber-600 dark:text-amber-400 font-semibold" onfocus="if(this.value === 'Instalación pendiente') { this.value = ''; this.type='date'; this.classList.remove('text-amber-600', 'dark:text-amber-400', 'font-semibold'); }" onblur="if(this.value === '') { this.type='text'; this.value = 'Instalación pendiente'; this.classList.add('text-amber-600', 'dark:text-amber-400', 'font-semibold'); }"/>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Número de Serie</span>
                            <input required name="serial" type="text" placeholder="S/N" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700 uppercase"/>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">MAC Address</span>
                            <input required name="mac" type="text" placeholder="00:00:00..." class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700 uppercase font-mono"/>
                        </label>
                        <label class="flex flex-col md:col-span-2">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Modelo</span>
                            <input required name="model" type="text" placeholder="Ej: HP LaserJet Pro..." class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                        <label class="flex flex-col md:col-span-2">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Estado de Impresora</span>
                            <select name="status" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700">
                                <option>Operativa</option>
                                <option>Fuera de servicio</option>
                                <option>Sin ubicar</option>
                            </select>
                        </label>
                    </div>
                </div>

                <div class="bg-white dark:bg-[#1a202c] p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                    <h3 class="text-lg font-bold mb-6 flex items-center gap-2 border-b pb-2 dark:border-slate-700 text-primary">
                        <span class="material-symbols-outlined">location_on</span> Ubicación y Dirección
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Ciudad</span>
                            <input required name="city" type="text" placeholder="Ciudad" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Departamento</span>
                            <input required name="dept" type="text" placeholder="Departamento" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Área</span>
                            <input required name="area" type="text" placeholder="Ej: Contabilidad" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                        <label class="flex flex-col md:col-span-3">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Dirección del Equipo</span>
                            <input required name="address" type="text" placeholder="Calle, Piso, Oficina..." class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                    </div>
                </div>

                <div class="bg-white dark:bg-[#1a202c] p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                    <h3 class="text-lg font-bold mb-6 flex items-center gap-2 border-b pb-2 dark:border-slate-700 text-primary">
                        <span class="material-symbols-outlined">settings_ethernet</span> Parámetros de Red
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 font-mono text-sm">
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500 font-sans">IP</span>
                            <input required name="ip" type="text" placeholder="192.168.1.50" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500 font-sans">Gateway</span>
                            <input required name="gateway" type="text" placeholder="192.168.1.1" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500 font-sans">Máscara</span>
                            <input required name="mask" type="text" placeholder="255.255.255.0" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                    </div>
                </div>

                <div class="bg-white dark:bg-[#1a202c] p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                    <h3 class="text-lg font-bold mb-6 flex items-center gap-2 border-b pb-2 dark:border-slate-700 text-primary">
                        <span class="material-symbols-outlined">contact_page</span> Contacto y Servicios
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Nombre de Contacto</span>
                            <input required name="contact" type="text" placeholder="Responsable" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Celular</span>
                            <input required name="phone" type="text" placeholder="300 000 0000" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                        <div class="md:col-span-2 flex flex-wrap gap-8 py-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="escaner" class="rounded text-primary focus:ring-primary"/>
                                <span class="font-bold text-sm">Escáner</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="slnx" class="rounded text-primary focus:ring-primary"/>
                                <span class="font-bold text-sm">Slnx</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="ndd" class="rounded text-primary focus:ring-primary"/>
                                <span class="font-bold text-sm">NDD</span>
                            </label>
                        </div>
                        <label class="flex flex-col md:col-span-2">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Nota Adicional</span>
                            <textarea name="note" placeholder="Observaciones..." class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700 h-24"></textarea>
                        </label>
                    </div>
                </div>

                <div class="bg-white dark:bg-[#1a202c] p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                    <h3 class="text-lg font-bold mb-6 flex items-center gap-2 border-b pb-2 dark:border-slate-700 text-primary">
                        <span class="material-symbols-outlined">countertops</span> Contadores
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <label class="flex flex-col">
                            <span class="text-xs font-bold mb-1 uppercase text-slate-500">Contador Inicial</span>
                            <input name="counterInitial" type="number" placeholder="0" class="rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700"/>
                        </label>
                    </div>
                </div>

                <div class="flex justify-end gap-4">
                    <button type="button" onclick="showView('inventory')" class="px-8 h-12 rounded-lg bg-slate-100 dark:bg-slate-800 font-bold transition-all hover:bg-slate-200">Cancelar</button>
                    <button type="submit" id="submitBtn" class="flex items-center justify-center gap-2 px-8 h-12 rounded-lg bg-primary text-white font-bold shadow-lg transition-all hover:bg-blue-600 disabled:opacity-70 disabled:cursor-not-allowed">
                        <span id="btnText">Guardar en Google Sheets</span>
                        <div id="btnSpinner" class="hidden spinner"></div>
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- MODAL DE DETALLES -->
    <div id="details-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-[#1a202c] rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white dark:bg-[#1a202c] border-b border-slate-200 dark:border-slate-700 p-6 flex justify-between items-center">
                <h2 class="text-2xl font-black">Detalles Completos del Equipo</h2>
                <button onclick="closeDetailsModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
            <div id="details-content" class="p-6">
                <!-- Contenido dinámico -->
            </div>
        </div>
    </div>

    <!-- MODAL DE HISTORIAL -->
    <div id="history-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-[#1a202c] rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="sticky top-0 bg-white dark:bg-[#1a202c] border-b border-slate-200 dark:border-slate-700 p-6 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-black">Historial de Tareas</h2>
                    <p class="text-sm text-slate-500 mt-1">Serial: <span id="history-serial" class="font-mono font-bold text-primary"></span></p>
                </div>
                <button onclick="closeHistoryModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div id="history-content" class="space-y-4">
                    <!-- Contenido dinámico -->
                </div>
            </div>
            <div class="border-t border-slate-200 dark:border-slate-700 p-6 bg-slate-50 dark:bg-slate-900/50">
                <form id="add-note-form" class="space-y-3">
                    <textarea id="new-note" placeholder="Escribe una nueva nota o tarea..." class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700 h-20 resize-none" required></textarea>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="closeHistoryModal()" class="px-4 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 font-bold text-sm transition-all hover:bg-slate-200">Cancelar</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-primary text-white font-bold text-sm transition-all hover:bg-blue-600">
                            <span class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-[16px]">add</span>
                                Agregar Nota
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL DE RMA -->
    <div id="rma-modal" class="fixed inset-0 bg-black/50 z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-[#1a202c] rounded-xl shadow-2xl w-full max-w-md">
            <div class="bg-white dark:bg-[#1a202c] border-b border-slate-200 dark:border-slate-700 p-6 flex justify-between items-center">
                <h2 class="text-xl font-black">Retiro Definitivo</h2>
                <button onclick="closeRMAModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
            <form id="rma-form" class="p-6 space-y-4">
                <div>
                    <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                        Por favor introduce número de RMA:
                    </label>
                    <input type="text" id="rma-input" placeholder="Ej: RMA-2024-001" class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700 font-mono" required />
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeRMAModal()" class="px-6 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 font-bold text-sm transition-all hover:bg-slate-200">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-red-500 text-white font-bold text-sm transition-all hover:bg-red-600 flex items-center gap-2">
                        <span class="material-symbols-outlined text-[16px]">check_circle</span>
                        Confirmar Retiro
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- VISTA 3: RETIRADAS -->
    <main id="retired-view" class="view-fade flex-1 hidden px-4 py-8 md:px-6 lg:px-10">
        <div class="mx-auto w-full">
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 pb-8">
                <div class="flex flex-col gap-2">
                    <h1 class="text-3xl font-black leading-tight tracking-[-0.033em]">Equipos Retirados</h1>
                    <p class="text-slate-500 dark:text-slate-400">Registro de equipos dados de baja.</p>
                </div>
            </div>

            <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#1a2632] shadow-sm overflow-hidden">
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-left text-[11px] whitespace-nowrap">
                        <thead class="bg-slate-50 dark:bg-[#23303d] border-b border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300">
                            <tr>
                                <th class="px-3 py-4 font-bold uppercase">Serial</th>
                                <th class="px-3 py-4 font-bold uppercase">Modelo</th>
                                <th class="px-3 py-4 font-bold uppercase">Ubicación</th>
                                <th class="px-3 py-4 font-bold uppercase">Fecha Retiro</th>
                                <th class="px-3 py-4 font-bold uppercase">Contacto</th>
                                <th class="px-3 py-4 font-bold uppercase">RMA</th>
                                <th class="px-3 py-4 font-bold uppercase text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="retiredTableBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                    </table>
                </div>
                <div class="px-6 py-4 bg-slate-50/50 dark:bg-slate-900/20 border-t border-slate-200 dark:border-slate-800">
                    <p class="text-xs text-slate-500" id="retiredStats"></p>
                </div>
            </div>
        </div>
    </main>

    <!-- VISTA 4: BACKUP DE TÓNER -->
    <main id="toner-view" class="view-fade flex-1 hidden px-4 py-8 md:px-6 lg:px-10">
        <div class="mx-auto w-full">
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 pb-8">
                <div class="flex flex-col gap-2">
                    <h1 class="text-3xl font-black leading-tight tracking-[-0.033em]">Backup de Tóner</h1>
                    <p class="text-slate-500 dark:text-slate-400">Inventario de consumibles y tóners.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="showAddTonerModal()" class="flex items-center justify-center rounded-lg h-10 px-4 bg-purple-500 text-white text-sm font-bold shadow-md hover:bg-purple-600 transition-all">
                        <span class="material-symbols-outlined mr-2 text-[20px]">add</span> Agregar Tóner
                    </button>
                </div>
            </div>

            <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#1a2632] shadow-sm overflow-hidden">
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-left text-[11px] whitespace-nowrap">
                        <thead class="bg-slate-50 dark:bg-[#23303d] border-b border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300">
                            <tr>
                                <th class="px-3 py-4 font-bold uppercase">Elemento</th>
                                <th class="px-3 py-4 font-bold uppercase">Modelo</th>
                                <th class="px-3 py-4 font-bold uppercase">Mod. Impresora</th>
                                <th class="px-3 py-4 font-bold uppercase">Color</th>
                                <th class="px-3 py-4 font-bold uppercase">Ubicación</th>
                                <th class="px-3 py-4 font-bold uppercase">Fecha/Registro</th>
                                <th class="px-3 py-4 font-bold uppercase">Estado</th>
                                <th class="px-3 py-4 font-bold uppercase">Observación</th>
                                <th class="px-3 py-4 font-bold uppercase text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tonerTableBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                    </table>
                </div>
                <div class="px-6 py-4 bg-slate-50/50 dark:bg-slate-900/20 border-t border-slate-200 dark:border-slate-800">
                    <p class="text-xs text-slate-500" id="tonerStats"></p>
                </div>
            </div>
        </div>
    </main>

    <!-- VISTA 5: CONTADORES -->
    <main id="counters-view" class="view-fade flex-1 hidden px-4 py-8 md:px-6 lg:px-10">
        <div class="mx-auto w-full">
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 pb-8">
                <div class="flex flex-col gap-2">
                    <h1 class="text-3xl font-black leading-tight tracking-[-0.033em]">Contadores de Impresión</h1>
                    <p class="text-slate-500 dark:text-slate-400">Registro de contadores por equipo.</p>
                </div>
            </div>

            <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#1a2632] shadow-sm overflow-hidden">
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-left text-[11px] whitespace-nowrap">
                        <thead class="bg-slate-50 dark:bg-[#23303d] border-b border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300">
                            <tr>
                                <th class="px-3 py-4 font-bold uppercase">Serie</th>
                                <th class="px-3 py-4 font-bold uppercase">Modelo</th>
                                <th class="px-3 py-4 font-bold uppercase">B/N</th>
                                <th class="px-3 py-4 font-bold uppercase">Color</th>
                                <th class="px-3 py-4 font-bold uppercase">Total</th>
                                <th class="px-3 py-4 font-bold uppercase">Ubicación</th>
                                <th class="px-3 py-4 font-bold uppercase text-center">Acciones</th>
                            </tr>
                            <tr class="bg-white dark:bg-[#1a2632]">
                                <th class="px-3 py-2">
                                    <input type="text" id="filter-counter-serial" oninput="filterCountersTable()" placeholder="Filtrar..." class="w-full text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary font-mono" />
                                </th>
                                <th class="px-3 py-2"></th>
                                <th class="px-3 py-2"></th>
                                <th class="px-3 py-2"></th>
                                <th class="px-3 py-2"></th>
                                <th class="px-3 py-2"></th>
                                <th class="px-3 py-2"></th>
                            </tr>
                        </thead>
                        <tbody id="countersTableBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                    </table>
                </div>
                <div class="px-6 py-4 bg-slate-50/50 dark:bg-slate-900/20 border-t border-slate-200 dark:border-slate-800">
                    <p class="text-xs text-slate-500" id="countersStats"></p>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL DE RMA -->
    <div id="rma-modal" class="fixed inset-0 bg-black/50 z-[70] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-[#1a202c] rounded-xl shadow-2xl w-full max-w-md">
            <div class="bg-white dark:bg-[#1a202c] border-b border-slate-200 dark:border-slate-700 p-6 flex justify-between items-center">
                <h2 class="text-xl font-black">Retiro Definitivo</h2>
                <button onclick="closeRMAModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
            <form id="rma-form" class="p-6 space-y-4">
                <div>
                    <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                        Por favor introduce número de RMA:
                    </label>
                    <input type="text" id="rma-input" placeholder="Ej: RMA-2024-001" class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700 font-mono" required />
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeRMAModal()" class="px-6 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 font-bold text-sm transition-all hover:bg-slate-200">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-red-500 text-white font-bold text-sm transition-all hover:bg-red-600 flex items-center gap-2">
                        <span class="material-symbols-outlined text-[16px]">check_circle</span>
                        Confirmar Retiro
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL AGREGAR TÓNER -->
    <div id="add-toner-modal" class="fixed inset-0 bg-black/50 z-[70] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-[#1a202c] rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white dark:bg-[#1a202c] border-b border-slate-200 dark:border-slate-700 p-6 flex justify-between items-center">
                <h2 class="text-xl font-black">Agregar Tóner</h2>
                <button onclick="closeAddTonerModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
            <form id="add-toner-form" class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                            Elemento
                        </label>
                        <input type="text" id="toner-elemento" placeholder="Ej: Tóner, Tambor, Fusor..." class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" required />
                    </div>
                    <div>
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                            Modelo
                        </label>
                        <input type="text" id="toner-modelo" placeholder="Ej: TK-5230K" class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" required />
                    </div>
                    <div>
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                            Modelo Impresora
                        </label>
                        <input type="text" id="toner-mod-impresora" placeholder="Ej: Kyocera M5521" class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" required />
                    </div>
                    <div>
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                            Color
                        </label>
                        <input type="text" id="toner-color" placeholder="Ej: Negro, Cyan, Magenta..." class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" required />
                    </div>
                    <div>
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                            Ubicación
                        </label>
                        <input type="text" id="toner-ubicacion" placeholder="Almacén, Oficina..." class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" required />
                    </div>
                    <div>
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                            Fecha
                        </label>
                        <input type="date" id="toner-fecha" class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" required />
                    </div>
                    <div>
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                            Estado
                        </label>
                        <select id="toner-estado" class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" required>
                            <option value="">Seleccionar...</option>
                            <option value="Disponible">Disponible</option>
                            <option value="Usado">Usado</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                            Observación
                        </label>
                        <textarea id="toner-observacion" placeholder="Notas adicionales..." class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700 h-20 resize-none"></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeAddTonerModal()" class="px-6 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 font-bold text-sm transition-all hover:bg-slate-200">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-purple-500 text-white font-bold text-sm transition-all hover:bg-purple-600 flex items-center gap-2">
                        <span class="material-symbols-outlined text-[16px]">add_circle</span>
                        Agregar Tóner
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL ASIGNAR TÓNER A IMPRESORA -->
    <div id="assign-toner-modal" class="fixed inset-0 bg-black/50 z-[80] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-[#1a202c] rounded-xl shadow-2xl w-full max-w-md">
            <div class="bg-white dark:bg-[#1a202c] border-b border-slate-200 dark:border-slate-700 p-6 flex justify-between items-center">
                <h2 class="text-xl font-black">Asignar Tóner</h2>
                <button onclick="closeAssignTonerModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
            <form id="assign-toner-form" class="p-6 space-y-4">
                <div>
                    <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                        Número de serie de la impresora:
                    </label>
                    <input type="text" id="assign-printer-serial" placeholder="Número de serie..." class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700 font-mono uppercase" required />
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                            Contador B/N:
                        </label>
                        <input type="number" id="assign-counter-bn" placeholder="0" class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" min="0" required />
                    </div>
                    <div>
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                            Contador Color:
                        </label>
                        <input type="number" id="assign-counter-color" placeholder="0" class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" min="0" />
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeAssignTonerModal()" class="px-6 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 font-bold text-sm transition-all hover:bg-slate-200">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-purple-500 text-white font-bold text-sm transition-all hover:bg-purple-600 flex items-center gap-2">
                        <span class="material-symbols-outlined text-[16px]">check_circle</span>
                        Asignar Tóner
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL CAMBIO DE TÓNER -->
    <div id="change-toner-modal" class="fixed inset-0 bg-black/50 z-[80] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-[#1a202c] rounded-xl shadow-2xl w-full max-w-md">
            <div class="bg-white dark:bg-[#1a202c] border-b border-slate-200 dark:border-slate-700 p-6 flex justify-between items-center">
                <h2 class="text-xl font-black">Cambio de Tóner</h2>
                <button onclick="closeChangeTonerModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
            <form id="change-toner-form" class="p-6 space-y-4">
                <div class="bg-primary/10 dark:bg-primary/20 p-4 rounded-lg border border-primary/30">
                    <div class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-1">Equipo seleccionado:</div>
                    <div class="text-lg font-black text-primary" id="change-toner-serial">-</div>
                    <div class="text-xs text-slate-500" id="change-toner-model">-</div>
                </div>
                <div>
                    <label class="text-sm font-bold text-slate-700 dark:text-slate-300 block mb-2">
                        Contador actual al momento del cambio:
                    </label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-slate-500 block mb-1">B/N</label>
                            <input type="number" id="change-counter-bn" placeholder="0" class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" min="0" required />
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 block mb-1">Color</label>
                            <input type="number" id="change-counter-color" placeholder="0" class="w-full rounded-lg border-slate-200 dark:bg-slate-800 dark:border-slate-700" min="0" />
                        </div>
                    </div>
                </div>
                <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-300 dark:border-amber-700 p-3 rounded-lg">
                    <div class="flex items-start gap-2">
                        <span class="material-symbols-outlined text-amber-600 text-[20px]">info</span>
                        <p class="text-xs text-amber-700 dark:text-amber-400">
                            El contador se ajustará automáticamente al siguiente múltiplo del rendimiento del tóner y se guardará el registro.
                        </p>
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeChangeTonerModal()" class="px-6 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 font-bold text-sm transition-all hover:bg-slate-200">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-primary text-white font-bold text-sm transition-all hover:bg-blue-600 flex items-center gap-2">
                        <span class="material-symbols-outlined text-[16px]">refresh</span>
                        Confirmar Cambio
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // URL DE TU API DE GOOGLE APPS SCRIPT
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwkdAp99cKxyRJjw5gKZ-DYeGV4zAIybnXYwWL-bYtpNH_2cUZb7Vo1nP-m27_X1vRqkw/exec";

    let printers = JSON.parse(localStorage.getItem('printers_cache')) || [];
    let retired = JSON.parse(localStorage.getItem('retired_cache')) || [];
    let toners = JSON.parse(localStorage.getItem('toners_cache')) || [];
    let counters = JSON.parse(localStorage.getItem('counters_cache')) || [];
    let history = JSON.parse(localStorage.getItem('history_cache')) || {}; // {serial: [{date, note}, ...]}
    let currentTab = 'inventory';
    let currentHistorySerial = null;

    // Tabla de rendimientos de tóner por modelo
    const tonerYields = {
        'IM C3500': { type: 'Color', black: 31000, color: 19000 },
        'IM C4500': { type: 'Color', black: 31000, color: 18000 },
        'MP C3004EX': { type: 'Color', black: 29500, color: 18000 },
        'MPC3003SP': { type: 'Color', black: 29500, color: 18000 },
        'MPC4503SP': { type: 'Color', black: 31000, color: 18000 },
        'MPC4504': { type: 'Color', black: 31000, color: 18000 },
        'MPC306': { type: 'Color', black: 17000, color: 10000 },
        'IM C2000': { type: 'Color', black: 15000, color: 9500 },
        'MPC2004': { type: 'Color', black: 15000, color: 9500 },
        'IM 430': { type: 'Monocromo', black: 17400, color: 0 },
        'IM 430F': { type: 'Monocromo', black: 17400, color: 0 },
        'MP 305': { type: 'Monocromo', black: 11000, color: 0 },
        'MP 401SPF': { type: 'Monocromo', black: 10000, color: 0 },
        'MP 402SPF': { type: 'Monocromo', black: 10000, color: 0 },
        'MP 501SPF': { type: 'Monocromo', black: 25000, color: 0 },
        'P 502': { type: 'Monocromo', black: 17400, color: 0 },
        'SP 4510DN': { type: 'Monocromo', black: 10000, color: 0 },
        'SP5200S': { type: 'Monocromo', black: 25000, color: 0 }
    };

    // Función auxiliar para obtener el nombre del día de la semana en español
    function getDayName(date) {
        const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
        return days[date.getDay()];
    }

    // Función auxiliar para formatear fecha con día de la semana
    function formatDateWithDay(dateString) {
        if (!dateString || dateString === 'Instalación pendiente') return 'Fecha no disponible';
        const date = new Date(dateString + 'T00:00:00');
        const dayName = getDayName(date);
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        return `${dayName}, ${day}/${month}/${year}`;
    }

    // Función para calcular el estado del tóner basado en contadores
    // Fórmulas:
    // 1) Tóners usados = Contador global / Rendimiento (parte entera)
    // 2) Porcentaje actual = (Contador/Rendimiento - ENTERO(Contador/Rendimiento)) × 100
    // 3) Páginas restantes = Rendimiento - ((Contador/Rendimiento - ENTERO(Contador/Rendimiento)) × Rendimiento)
    function calculateTonerStatus(serial, model) {
        // Buscar el último registro de contadores para este serial
        const counterRecords = counters.filter(c => c.serial && c.serial.toUpperCase() === serial.toUpperCase());

        if (counterRecords.length === 0) {
            return {
                percentage: '0.0',
                changes: 0,
                remaining: 0,
                currentCopies: 0,
                display: 'Sin datos',
                color: 'slate',
                lastChangeDate: 'Fecha no disponible'
            };
        }

        // Obtener rendimiento del tóner para este modelo
        const yield = tonerYields[model];
        if (!yield) {
            return {
                percentage: '0.0',
                changes: 0,
                remaining: 0,
                currentCopies: 0,
                display: 'Modelo no registrado',
                color: 'slate',
                lastChangeDate: 'Fecha no disponible'
            };
        }

        // Tomar el último registro (más reciente)
        const latest = counterRecords[counterRecords.length - 1];
        const counterBlack = parseFloat(latest.bn) || 0;
        const counterColor = parseFloat(latest.color) || 0;

        // CÁLCULOS PARA TÓNER NEGRO
        let tonerChangesBlack = 0;
        let percentageBlack = 0;
        let remainingBlack = 0;
        
        if (yield.black > 0 && counterBlack > 0) {
            // 1) Tóners usados = ENTERO(Contador / Rendimiento)
            tonerChangesBlack = Math.floor(counterBlack / yield.black);
            
            // 2) Porcentaje actual = (Contador/Rendimiento - ENTERO(Contador/Rendimiento)) × 100
            const fractionBlack = (counterBlack / yield.black) - Math.floor(counterBlack / yield.black);
            percentageBlack = fractionBlack * 100;
            
            // 3) Páginas restantes = Rendimiento - (fracción × Rendimiento)
            remainingBlack = yield.black - (fractionBlack * yield.black);
        }

        // CÁLCULOS PARA TÓNER COLOR (si aplica)
        let tonerChangesColor = 0;
        let percentageColor = 0;
        let remainingColor = 0;
        
        if (yield.color > 0 && counterColor > 0) {
            // 1) Tóners usados = ENTERO(Contador / Rendimiento)
            tonerChangesColor = Math.floor(counterColor / yield.color);
            
            // 2) Porcentaje actual = (Contador/Rendimiento - ENTERO(Contador/Rendimiento)) × 100
            const fractionColor = (counterColor / yield.color) - Math.floor(counterColor / yield.color);
            percentageColor = fractionColor * 100;
            
            // 3) Páginas restantes = Rendimiento - (fracción × Rendimiento)
            remainingColor = yield.color - (fractionColor * yield.color);
        }

        // Determinar el tóner crítico (el que tiene mayor porcentaje)
        let criticalPercentage = Math.max(percentageBlack, percentageColor);
        let criticalChanges = Math.max(tonerChangesBlack, tonerChangesColor);
        let currentCopies = Math.max(counterBlack, counterColor);
        
        // Para páginas restantes, tomar el mínimo entre negro y color (el que se agotará primero)
        let remainingMin;
        if (yield.color > 0 && counterColor > 0) {
            remainingMin = Math.min(remainingBlack, remainingColor);
        } else {
            remainingMin = remainingBlack;
        }

        // Calcular fecha estimada del último cambio de tóner
        let lastChangeDateFormatted = 'Sin cambios registrados';
        
        if (criticalChanges > 0) {
            try {
                // Buscar la impresora para obtener su fecha de instalación
                const printer = typeof printers !== 'undefined' ? printers.find(p => p && p.serial && p.serial.toUpperCase() === serial.toUpperCase()) : null;
                
                let baseDate = null;
                let daysToCalculate = 0;
                
                // Intentar usar fecha de instalación si está disponible
                if (printer && printer.dateInst && printer.dateInst !== 'Instalación pendiente') {
                    const installDate = new Date(printer.dateInst + 'T00:00:00');
                    if (!isNaN(installDate.getTime())) {
                        // Calcular desde la fecha de instalación
                        baseDate = installDate;
                        const copiesAtLastChange = criticalChanges * (yield.color > 0 && counterColor > 0 ? Math.max(yield.black, yield.color) : yield.black);
                        const avgCopiesPerDay = 50;
                        daysToCalculate = Math.floor(copiesAtLastChange / avgCopiesPerDay);
                    }
                }
                
                // Si no hay fecha de instalación, calcular hacia atrás desde hoy
                if (!baseDate) {
                    const today = new Date();
                    const copiesSinceLastChange = criticalPercentage * (yield.color > 0 && counterColor > 0 ? Math.max(yield.black, yield.color) : yield.black) / 100;
                    const avgCopiesPerDay = 50;
                    const daysSinceLastChange = Math.floor(copiesSinceLastChange / avgCopiesPerDay);
                    
                    baseDate = new Date(today);
                    daysToCalculate = -daysSinceLastChange; // Negativo para ir hacia atrás
                }
                
                // Calcular la fecha final
                const lastChangeDate = new Date(baseDate);
                lastChangeDate.setDate(lastChangeDate.getDate() + daysToCalculate);
                
                // Validar que la fecha calculada sea válida
                if (!isNaN(lastChangeDate.getTime())) {
                    lastChangeDateFormatted = formatDateWithDay(lastChangeDate.toISOString().split('T')[0]);
                }
            } catch (error) {
                console.error('Error calculando fecha de cambio de tóner:', error);
                lastChangeDateFormatted = 'Error al calcular';
            }
        }

        return {
            percentage: criticalPercentage.toFixed(1),
            changes: criticalChanges,
            remaining: Math.max(0, Math.floor(remainingMin)),
            currentCopies: Math.floor(currentCopies),
            display: `${criticalPercentage.toFixed(1)}%`,
            color: criticalPercentage >= 80 ? 'red' : criticalPercentage >= 50 ? 'orange' : criticalPercentage >= 30 ? 'yellow' : 'emerald',
            lastChangeDate: lastChangeDateFormatted,
            // Datos separados para B/N y Color
            black: {
                percentage: percentageBlack.toFixed(1),
                changes: tonerChangesBlack,
                remaining: Math.max(0, Math.floor(remainingBlack)),
                currentCopies: Math.floor(counterBlack),
                color: percentageBlack >= 80 ? 'red' : percentageBlack >= 50 ? 'orange' : percentageBlack >= 30 ? 'yellow' : 'emerald'
            },
            colorToner: {
                percentage: percentageColor.toFixed(1),
                changes: tonerChangesColor,
                remaining: Math.max(0, Math.floor(remainingColor)),
                currentCopies: Math.floor(counterColor),
                color: percentageColor >= 80 ? 'red' : percentageColor >= 50 ? 'orange' : percentageColor >= 30 ? 'yellow' : 'emerald',
                hasColor: yield.color > 0 && counterColor > 0
            }
        };
    }

    // Función para cambiar entre pestañas
    function switchTab(tab) {
        currentTab = tab;
        
        // Ocultar todas las vistas
        document.getElementById('inventory-view').classList.add('hidden');
        document.getElementById('form-view').classList.add('hidden');
        document.getElementById('retired-view').classList.add('hidden');
        document.getElementById('toner-view').classList.add('hidden');
        document.getElementById('counters-view').classList.add('hidden');
        
        // Mostrar la vista correspondiente
        if (tab === 'inventory') {
            document.getElementById('inventory-view').classList.remove('hidden');
            renderTable(printers);
        } else if (tab === 'retired') {
            document.getElementById('retired-view').classList.remove('hidden');
            renderRetiredTable(retired);
        } else if (tab === 'toner') {
            document.getElementById('toner-view').classList.remove('hidden');
            renderTonerTable(toners);
        } else if (tab === 'counters') {
            document.getElementById('counters-view').classList.remove('hidden');
            renderCountersTable(counters);
        }
        
        window.scrollTo(0, 0);
    }

    function showView(view) {
        document.getElementById('inventory-view').classList.toggle('hidden', view !== 'inventory');
        document.getElementById('form-view').classList.toggle('hidden', view !== 'form');
        document.getElementById('retired-view').classList.add('hidden');
        document.getElementById('toner-view').classList.add('hidden');
        document.getElementById('counters-view').classList.add('hidden');
        
        if (view === 'inventory') {
            renderTable(printers);
            currentTab = 'inventory';
            // Actualizar el botón del menú
            document.getElementById('current-module-icon').innerText = 'inventory_2';
            document.getElementById('current-module-name').innerText = 'Inventario';
        }
        
        // Establecer fecha de registro actual cuando se muestra el formulario
        if (view === 'form') {
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="dateReg"]').value = today;
        }
        
        window.scrollTo(0, 0);
    }

    // Función para actualizar el estado de una impresora desde la tabla
    function updatePrinterStatus(serial, newStatus) {
        const index = printers.findIndex(p => p.serial === serial);
        if (index === -1) {
            showToast('Impresora no encontrada', 'error');
            return;
        }
        printers[index].status = newStatus;
        localStorage.setItem('printers_cache', JSON.stringify(printers));
        showToast(`Estado actualizado a: ${newStatus}`, 'success');
        // Re-renderizar la tabla para actualizar los colores
        renderTable(printers);
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        data.forEach((p, idx) => {
            // Determinar color según el estado
            let statusColor = 'text-slate-400 bg-slate-50 dark:bg-slate-800/20';
            if (p.status === 'Operativa') {
                statusColor = 'text-emerald-600 bg-emerald-50 dark:bg-emerald-900/20';
            } else if (p.status === 'Fuera de servicio') {
                statusColor = 'text-red-600 bg-red-50 dark:bg-red-900/20';
            } else if (p.status === 'Sin ubicar') {
                statusColor = 'text-amber-600 bg-amber-50 dark:bg-amber-900/20';
            }
            
            // Calcular estado del tóner usando datos de contadores
            const tonerStatus = calculateTonerStatus(p.serial, p.model);
            const tonerPercentage = parseFloat(tonerStatus.percentage) || 0;
            let tonerColor = 'text-emerald-500 bg-emerald-50 dark:bg-emerald-900/20';
            if (tonerPercentage >= 80) tonerColor = 'text-red-500 bg-red-50 dark:bg-red-900/20';
            else if (tonerPercentage >= 50) tonerColor = 'text-orange-500 bg-orange-50 dark:bg-orange-900/20';
            else if (tonerPercentage >= 30) tonerColor = 'text-yellow-500 bg-yellow-50 dark:bg-yellow-900/20';
            
            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800/40 transition-colors border-b dark:border-slate-800";
            tr.innerHTML = `
                <td class="px-2 py-2">
                    <div class="flex items-center gap-1">
                        <div class="tooltip-wrapper">
                            <button onclick="showDetails('${p.serial}')" class="font-mono font-bold text-primary hover:underline cursor-pointer">${p.serial}</button>
                            <div class="custom-tooltip" id="tooltip-serial-${idx}">
                                <div class="tooltip-title">IP</div>
                                <div class="tooltip-value font-mono">${p.ip || 'No asignada'}</div>
                                <div class="tooltip-title">Gateway</div>
                                <div class="tooltip-value font-mono">${p.gateway || 'No configurado'}</div>
                                <div class="tooltip-title">Máscara</div>
                                <div class="tooltip-value font-mono">${p.mask || 'No configurada'}</div>
                                <div class="tooltip-title">Servicios</div>
                                <div class="tooltip-value">
                                    <span class="tooltip-badge ${p.escaner ? 'badge-yes' : 'badge-no'}">ESCÁNER: ${p.escaner ? 'SÍ' : 'NO'}</span>
                                    <span class="tooltip-badge ${p.slnx ? 'badge-yes' : 'badge-no'}">SLNX: ${p.slnx ? 'SÍ' : 'NO'}</span>
                                    <span class="tooltip-badge ${p.ndd ? 'badge-yes' : 'badge-no'}">NDD: ${p.ndd ? 'SÍ' : 'NO'}</span>
                                </div>
                                <div class="tooltip-title">Nota</div>
                                <div class="tooltip-value italic" style="font-size: 12px; color: #64748b;">${p.note || 'Sin notas'}</div>
                            </div>
                        </div>
                        ${p.dateInst === 'Instalación pendiente' ? 
                            `<div class="tooltip-wrapper">
                                <span class="material-symbols-outlined text-[16px] text-amber-500 animate-pulse cursor-help">schedule</span>
                                <div class="custom-tooltip" style="min-width: 200px;">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="material-symbols-outlined text-amber-500">warning</span>
                                        <span class="font-bold text-amber-600 dark:text-amber-400">Instalación Pendiente</span>
                                    </div>
                                    <p class="text-xs text-slate-600 dark:text-slate-400">Esta impresora aún no ha sido instalada.</p>
                                </div>
                            </div>` : 
                            ''}
                    </div>
                </td>
                <td class="px-2 py-2">
                    <div class="font-bold text-slate-700 dark:text-slate-300 text-[11px]">${p.model}</div>
                </td>
                <td class="px-2 py-2 text-[11px]">${p.city}</td>
                <td class="px-2 py-2 text-[11px]">${p.dept}</td>
                <td class="px-2 py-2">
                    <div class="truncate-cell text-[11px]" title="${p.address}" style="max-width: 140px;">${p.address}</div>
                </td>
                <td class="px-2 py-2 text-[11px]">${p.area}</td>
                <td class="px-2 py-2">
                    <div class="tooltip-wrapper">
                        <div class="font-bold cursor-default">${p.contact}</div>
                        <div class="custom-tooltip" id="tooltip-contact-${idx}">
                            <div class="tooltip-title">Celular</div>
                            <div class="tooltip-value font-mono text-lg">${p.phone || 'No registrado'}</div>
                        </div>
                    </div>
                </td>
                <td class="px-3 py-4">
                    <select onchange="updatePrinterStatus('${p.serial}', this.value)" class="text-[10px] font-bold uppercase px-2 py-1 rounded border-0 ${statusColor} cursor-pointer focus:ring-2 focus:ring-primary">
                        <option value="Operativa" ${p.status === 'Operativa' ? 'selected' : ''}>Operativa</option>
                        <option value="Fuera de servicio" ${p.status === 'Fuera de servicio' ? 'selected' : ''}>Fuera de servicio</option>
                        <option value="Sin ubicar" ${p.status === 'Sin ubicar' ? 'selected' : ''}>Sin ubicar</option>
                    </select>
                </td>
                <td class="px-2 py-2">
                    <div class="tooltip-wrapper">
                        <div class="flex items-center gap-1">
                            ${tonerStatus.colorToner.hasColor ? `
                                <!-- Gráfica B/N -->
                                <div class="flex flex-col items-center gap-1">
                                    <div class="circular-progress cursor-pointer hover:scale-110 transition-transform active:scale-95" onclick="showChangeTonerModal('${p.serial}')" style="--progress: ${tonerStatus.black.percentage}; --progress-color: ${parseFloat(tonerStatus.black.percentage) >= 80 ? '#ef4444' : parseFloat(tonerStatus.black.percentage) >= 50 ? '#f97316' : parseFloat(tonerStatus.black.percentage) >= 30 ? '#eab308' : '#10b981'}">
                                        <span class="circular-progress-text">${tonerStatus.black.percentage}%</span>
                                    </div>
                                    <span class="text-[8px] font-bold text-slate-400">B/N</span>
                                </div>
                                <!-- Gráfica Color -->
                                <div class="flex flex-col items-center gap-1">
                                    <div class="circular-progress cursor-pointer hover:scale-110 transition-transform active:scale-95" onclick="showChangeTonerModal('${p.serial}')" style="--progress: ${tonerStatus.colorToner.percentage}; --progress-color: ${parseFloat(tonerStatus.colorToner.percentage) >= 80 ? '#ef4444' : parseFloat(tonerStatus.colorToner.percentage) >= 50 ? '#f97316' : parseFloat(tonerStatus.colorToner.percentage) >= 30 ? '#eab308' : '#10b981'}">
                                        <span class="circular-progress-text">${tonerStatus.colorToner.percentage}%</span>
                                    </div>
                                    <span class="text-[8px] font-bold text-primary">Color</span>
                                </div>
                            ` : `
                                <!-- Solo gráfica B/N para impresoras monocromo -->
                                <div class="circular-progress cursor-pointer hover:scale-110 transition-transform active:scale-95" onclick="showChangeTonerModal('${p.serial}')" style="--progress: ${tonerPercentage}; --progress-color: ${tonerPercentage >= 80 ? '#ef4444' : tonerPercentage >= 50 ? '#f97316' : tonerPercentage >= 30 ? '#eab308' : '#10b981'}">
                                    <span class="circular-progress-text">${tonerPercentage.toFixed(1)}%</span>
                                </div>
                            `}
                            <div class="flex flex-col">
                                <span class="text-[9px] text-slate-400 font-semibold">${tonerStatus.currentCopies.toLocaleString()} copias</span>
                                <span class="text-[8px] text-slate-300 font-medium">Restantes: ${tonerStatus.remaining.toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="custom-tooltip" style="min-width: 250px;">
                            <div class="tooltip-title">Estado del Tóner</div>
                            <div class="tooltip-value">
                                ${tonerStatus.colorToner.hasColor ? `
                                    <!-- Información B/N -->
                                    <div class="mb-3 pb-3 border-b border-slate-200 dark:border-slate-700">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="material-symbols-outlined text-slate-600">print</span>
                                            <span class="font-bold text-lg">B/N: ${tonerStatus.black.percentage}%</span>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <div>
                                                <span class="text-slate-500">Copias actuales:</span>
                                                <div class="font-bold">${tonerStatus.black.currentCopies.toLocaleString()}</div>
                                            </div>
                                            <div>
                                                <span class="text-slate-500">Restantes:</span>
                                                <div class="font-bold text-${tonerStatus.black.color}-600">${tonerStatus.black.remaining.toLocaleString()}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Información Color -->
                                    <div>
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="material-symbols-outlined text-primary">palette</span>
                                            <span class="font-bold text-lg">Color: ${tonerStatus.colorToner.percentage}%</span>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <div>
                                                <span class="text-slate-500">Copias actuales:</span>
                                                <div class="font-bold">${tonerStatus.colorToner.currentCopies.toLocaleString()}</div>
                                            </div>
                                            <div>
                                                <span class="text-slate-500">Restantes:</span>
                                                <div class="font-bold text-${tonerStatus.colorToner.color}-600">${tonerStatus.colorToner.remaining.toLocaleString()}</div>
                                            </div>
                                        </div>
                                        ${tonerStatus.changes > 0 ? `
                                        <div class="col-span-2 pt-2 mt-2 border-t border-slate-200">
                                            <span class="text-slate-500">Último cambio:</span>
                                            <div class="font-bold text-xs">${tonerStatus.lastChangeDate}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                ` : `
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="material-symbols-outlined text-${tonerStatus.color}-500">print</span>
                                        <span class="font-bold text-lg">${tonerPercentage.toFixed(1)}%</span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-xs">
                                        <div>
                                            <span class="text-slate-500">Copias actuales:</span>
                                            <div class="font-bold">${tonerStatus.currentCopies.toLocaleString()}</div>
                                        </div>
                                        <div>
                                            <span class="text-slate-500">Copias restantes:</span>
                                            <div class="font-bold text-${tonerStatus.color}-600">${tonerStatus.remaining.toLocaleString()}</div>
                                        </div>
                                        <div class="col-span-2">
                                            <span class="text-slate-500">Cambios de tóner:</span>
                                            <div class="font-bold">${tonerStatus.changes} ${tonerStatus.changes === 1 ? 'vez' : 'veces'}</div>
                                        </div>
                                        ${tonerStatus.changes > 0 ? `
                                        <div class="col-span-2 pt-1 border-t border-slate-200">
                                            <span class="text-slate-500">Último cambio:</span>
                                            <div class="font-bold text-xs">${tonerStatus.lastChangeDate}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </td>
                <td class="px-2 py-2 text-center">
                    <button onclick="showHistory('${p.serial}')" class="text-slate-300 hover:text-blue-500 transition-colors" title="Ver/Agregar Historial">
                        <span class="material-symbols-outlined text-[16px]">note_add</span>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        document.getElementById('tableStats').innerText = `Total Equipos: ${data.length}`;
        
        // Actualizar gráficas de estadísticas
        updateChartStats();
        
        // Configurar posicionamiento de tooltips
        setTimeout(() => {
            document.querySelectorAll('.tooltip-wrapper').forEach(wrapper => {
                const tooltip = wrapper.querySelector('.custom-tooltip');
                if (tooltip) {
                    wrapper.addEventListener('mouseenter', function(e) {
                        // Mostrar el tooltip temporalmente para obtener sus dimensiones
                        tooltip.style.display = 'block';
                        tooltip.style.visibility = 'hidden';
                        
                        const rect = this.getBoundingClientRect();
                        const tooltipRect = tooltip.getBoundingClientRect();
                        
                        // Posicionar el tooltip a la derecha del elemento
                        let left = rect.right + 10;
                        let top = rect.top;
                        
                        // Ajustar si se sale por la derecha
                        if (left + tooltipRect.width > window.innerWidth - 10) {
                            left = rect.left - tooltipRect.width - 10;
                        }
                        
                        // Si aún se sale por la izquierda, centrarlo sobre el elemento
                        if (left < 10) {
                            left = Math.max(10, rect.left + (rect.width / 2) - (tooltipRect.width / 2));
                        }
                        
                        // Ajustar si se sale por abajo
                        if (top + tooltipRect.height > window.innerHeight - 10) {
                            top = window.innerHeight - tooltipRect.height - 10;
                        }
                        
                        // Ajustar si se sale por arriba
                        if (top < 10) {
                            top = 10;
                        }
                        
                        // Asegurar que no se salga por la derecha después de todos los ajustes
                        if (left + tooltipRect.width > window.innerWidth - 10) {
                            left = window.innerWidth - tooltipRect.width - 10;
                        }
                        
                        tooltip.style.left = left + 'px';
                        tooltip.style.top = top + 'px';
                        tooltip.style.visibility = 'visible';
                    });
                    
                    // Agregar evento para ocultar el tooltip
                    wrapper.addEventListener('mouseleave', function(e) {
                        tooltip.style.display = 'none';
                    });
                }
            });
        }, 100);
    }

    // Variable global para guardar el índice del equipo que se está editando
    let currentEditingIndex = null;

    // Función para mostrar detalles completos (EDITABLE)
    function showDetails(serial) {
        const index = printers.findIndex(p => p.serial === serial);
        if (index === -1) {
            showToast('Impresora no encontrada', 'error');
            return;
        }
        currentEditingIndex = index;
        const p = printers[index];
        const tonerStatus = calculateTonerStatus(p.serial, p.model);
        const tonerPercentage = parseFloat(tonerStatus.percentage);
        
        const detailsContent = document.getElementById('details-content');
        detailsContent.innerHTML = `
            <form id="edit-details-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Fechas -->
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Fecha de Registro</label>
                        <input type="date" value="${p.dateReg || ''}" readonly class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 cursor-not-allowed text-slate-400 dark:text-slate-500" />
                    </div>
                    <div class="${p.dateInst === 'Instalación pendiente' ? 'bg-amber-50 dark:bg-amber-900/20 border-amber-300 dark:border-amber-700' : 'bg-slate-50 dark:bg-slate-800/50'} p-4 rounded-lg border ${p.dateInst === 'Instalación pendiente' ? 'border-amber-300 dark:border-amber-700' : 'border-slate-200 dark:border-slate-700'}">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Fecha de Instalación</label>
                        ${p.dateInst === 'Instalación pendiente' ? 
                            `<input type="date" name="dateInst" class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary" />` :
                            `<input type="date" name="dateInst" value="${p.dateInst || ''}" readonly class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 cursor-not-allowed text-slate-400 dark:text-slate-500" />`
                        }
                        ${p.dateInst === 'Instalación pendiente' ? 
                            `<p class="text-xs text-amber-600 dark:text-amber-400 mt-1 font-semibold">${p.dateInst}</p>` : ''}
                    </div>
                    
                    <!-- Identificación -->
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Número de Serie</label>
                        <input type="text" value="${p.serial || ''}" readonly class="text-sm font-mono font-bold w-full bg-transparent border-none p-0 focus:ring-0 cursor-not-allowed uppercase text-slate-400 dark:text-slate-500" />
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">MAC</label>
                        <input type="text" value="${p.mac || ''}" readonly class="text-sm font-mono font-bold w-full bg-transparent border-none p-0 focus:ring-0 cursor-not-allowed uppercase text-slate-400 dark:text-slate-500" />
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Modelo</label>
                        <input type="text" value="${p.model || ''}" readonly class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 cursor-not-allowed text-slate-400 dark:text-slate-500" />
                    </div>
                    
                    <!-- Ubicación -->
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Ciudad</label>
                        <input type="text" name="city" value="${p.city || ''}" class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary" />
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Departamento</label>
                        <input type="text" name="dept" value="${p.dept || ''}" class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary" />
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700 md:col-span-2 lg:col-span-1">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Dirección del Equipo</label>
                        <input type="text" name="address" value="${p.address || ''}" class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary" />
                    </div>
                    
                    <!-- Red -->
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">IP</label>
                        <input type="text" name="ip" value="${p.ip || ''}" class="text-sm font-mono font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary" />
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Gateway</label>
                        <input type="text" name="gateway" value="${p.gateway || ''}" class="text-sm font-mono font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary" />
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Máscara</label>
                        <input type="text" name="mask" value="${p.mask || ''}" class="text-sm font-mono font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary" />
                    </div>
                    
                    <!-- Contacto -->
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Área</label>
                        <input type="text" name="area" value="${p.area || ''}" class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary" />
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Contacto</label>
                        <input type="text" name="contact" value="${p.contact || ''}" class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary" />
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Celular</label>
                        <input type="text" name="phone" value="${p.phone || ''}" class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary" />
                    </div>
                    
                    <!-- Estado -->
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Estado de Impresora</label>
                        <select name="status" class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary">
                            <option ${p.status === 'Operativa' ? 'selected' : ''}>Operativa</option>
                            <option ${p.status === 'Fuera de servicio' ? 'selected' : ''}>Fuera de servicio</option>
                            <option ${p.status === 'Sin ubicar' ? 'selected' : ''}>Sin ubicar</option>
                            </select>
                    </div>
                    
                    <!-- Servicios -->
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-2">Escáner</label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="escaner" ${p.escaner ? 'checked' : ''} class="rounded text-primary focus:ring-primary" />
                            <span class="text-sm font-bold">Disponible</span>
                        </label>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-2">SLNX</label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="slnx" ${p.slnx ? 'checked' : ''} class="rounded text-primary focus:ring-primary" />
                            <span class="text-sm font-bold">Disponible</span>
                        </label>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-2">NDD</label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="ndd" ${p.ndd ? 'checked' : ''} class="rounded text-primary focus:ring-primary" />
                            <span class="text-sm font-bold">Disponible</span>
                        </label>
                    </div>
                    
                    <!-- Contador Inicial -->
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Contador Inicial</label>
                        <input type="number" value="${p.counterInitial || 0}" readonly class="text-sm font-bold w-full bg-transparent border-none p-0 focus:ring-0 cursor-not-allowed text-slate-400 dark:text-slate-500" />
                    </div>
                    <div class="bg-gradient-to-br from-primary/10 to-primary/5 dark:from-primary/20 dark:to-primary/10 p-4 rounded-lg border-2 border-primary/30">
                        <label class="text-xs font-bold uppercase text-primary block mb-1">Estado del Tóner</label>
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-3xl font-black text-primary">${tonerPercentage.toFixed(1)}%</div>
                            <span class="material-symbols-outlined text-4xl text-primary/30">local_printshop</span>
                        </div>
                        <div class="space-y-1 text-xs text-slate-600 dark:text-slate-400">
                            <div class="flex justify-between">
                                <span>Copias actuales:</span>
                                <span class="font-bold">${tonerStatus.currentCopies.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Copias restantes:</span>
                                <span class="font-bold text-${tonerStatus.color}-600">${tonerStatus.remaining.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Cambios de tóner:</span>
                                <span class="font-bold">${tonerStatus.changes} ${tonerStatus.changes === 1 ? 'vez' : 'veces'}</span>
                            </div>
                            ${tonerStatus.changes > 0 ? `
                            <div class="flex justify-between pt-2 mt-2 border-t border-primary/20">
                                <span>Último cambio:</span>
                                <span class="font-bold text-primary">${tonerStatus.lastChangeDate}</span>
                            </div>
                            ` : ''}
                        </div>
                        <div class="mt-3 h-3 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden shadow-inner">
                            <div class="h-full ${tonerPercentage >= 80 ? 'bg-red-500' : tonerPercentage >= 50 ? 'bg-orange-500' : tonerPercentage >= 30 ? 'bg-yellow-500' : 'bg-emerald-500'} transition-all duration-500" style="width: ${Math.min(tonerPercentage, 100)}%"></div>
                        </div>
                    </div>
                    
                    <!-- Nota (editable) -->
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700 md:col-span-2 lg:col-span-3">
                        <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Nota</label>
                        <textarea name="note" class="text-sm w-full bg-transparent border-none p-0 focus:ring-0 focus:border-primary resize-none" rows="2" placeholder="Observaciones...">${p.note || ''}</textarea>
                    </div>
                </div>
                
                <!-- Botones de acción -->
                <div class="flex justify-between pt-4 border-t border-slate-200 dark:border-slate-700">
                    <div class="flex gap-3">
                        <button type="button" onclick="deletePrinterFromDetails(${index})" class="px-6 py-2 rounded-lg bg-slate-600 text-white font-bold text-sm transition-all hover:bg-slate-700 flex items-center gap-2">
                            <span class="material-symbols-outlined text-[16px]">delete</span>
                            Eliminar
                        </button>
                        <button type="button" onclick="retirePrinter(${index})" class="px-6 py-2 rounded-lg bg-red-500 text-white font-bold text-sm transition-all hover:bg-red-600 flex items-center gap-2">
                            <span class="material-symbols-outlined text-[16px]">delete_forever</span>
                            Retirar
                        </button>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" onclick="closeDetailsModal()" class="px-6 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 font-bold text-sm transition-all hover:bg-slate-200">
                            Cancelar
                        </button>
                        <button type="submit" class="px-6 py-2 rounded-lg bg-primary text-white font-bold text-sm transition-all hover:bg-blue-600 flex items-center gap-2">
                            <span class="material-symbols-outlined text-[16px]">save</span>
                            Guardar Cambios
                        </button>
                    </div>
                </div>
            </form>
        `;
        
        // Agregar evento al formulario
        document.getElementById('edit-details-form').addEventListener('submit', saveDetailsChanges);
        
        document.getElementById('details-modal').classList.remove('hidden');
    }

    function closeDetailsModal() {
        document.getElementById('details-modal').classList.add('hidden');
        currentEditingIndex = null;
    }

    // Función para guardar los cambios del formulario de detalles
    function saveDetailsChanges(e) {
        e.preventDefault();
        
        if (currentEditingIndex === null) return;
        
        const form = e.target;
        const formData = new FormData(form);
        
        // Actualizar solo los campos editables
        const newDateInst = formData.get('dateInst');
        // Solo actualizar dateInst si era "Instalación pendiente" y ahora hay una fecha
        if (printers[currentEditingIndex].dateInst === 'Instalación pendiente' && newDateInst) {
            printers[currentEditingIndex].dateInst = newDateInst;
        } else if (printers[currentEditingIndex].dateInst !== 'Instalación pendiente') {
            // Si ya tiene una fecha, no se puede cambiar
            // No hacer nada, mantener la fecha existente
        } else if (!newDateInst) {
            // Si sigue sin fecha, mantener "Instalación pendiente"
            printers[currentEditingIndex].dateInst = 'Instalación pendiente';
        }
        printers[currentEditingIndex].city = formData.get('city') || '';
        printers[currentEditingIndex].dept = formData.get('dept') || '';
        printers[currentEditingIndex].address = formData.get('address') || '';
        printers[currentEditingIndex].ip = formData.get('ip') || '';
        printers[currentEditingIndex].gateway = formData.get('gateway') || '';
        printers[currentEditingIndex].mask = formData.get('mask') || '';
        printers[currentEditingIndex].area = formData.get('area') || '';
        printers[currentEditingIndex].contact = formData.get('contact') || '';
        printers[currentEditingIndex].phone = formData.get('phone') || '';
        printers[currentEditingIndex].status = formData.get('status') || '';
        printers[currentEditingIndex].escaner = form.querySelector('input[name="escaner"]').checked;
        printers[currentEditingIndex].slnx = form.querySelector('input[name="slnx"]').checked;
        printers[currentEditingIndex].ndd = form.querySelector('input[name="ndd"]').checked;
        printers[currentEditingIndex].note = formData.get('note') || '';
        
        // Guardar en localStorage
        localStorage.setItem('printers_cache', JSON.stringify(printers));
        
        // Actualizar la tabla
        renderTable(printers);
        
        // Cerrar modal y mostrar mensaje
        closeDetailsModal();
        showToast('Cambios guardados correctamente', 'success');
    }

    // Renderizar tabla de equipos retirados
    function renderRetiredTable(data) {
        const tbody = document.getElementById('retiredTableBody');
        tbody.innerHTML = '';
        
        if (data.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                        <span class="material-symbols-outlined text-6xl mb-4 block">inventory_2</span>
                        No hay equipos retirados registrados
                    </td>
                </tr>
            `;
            document.getElementById('retiredStats').innerText = 'Total: 0';
            return;
        }
        
        data.forEach((item, idx) => {
            const hasRMA = item.rma && item.rma !== '';
            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800/40 transition-colors border-b dark:border-slate-800";
            tr.innerHTML = `
                <td class="px-3 py-4 font-mono font-bold">${item.serial || '-'}</td>
                <td class="px-3 py-4">${item.model || '-'}</td>
                <td class="px-3 py-4">${item.location || '-'}</td>
                <td class="px-3 py-4">
                    ${item.dateRetired ? `<span class="text-xs font-semibold">${item.dateRetired}</span>` : '<span class="text-xs text-slate-400 italic">Pendiente</span>'}
                </td>
                <td class="px-3 py-4">${item.contact || '-'}</td>
                <td class="px-3 py-4">
                    ${item.rma ? `<span class="font-mono font-bold text-primary">${item.rma}</span>` : '<span class="text-xs text-slate-400 italic">Pendiente</span>'}
                </td>
                <td class="px-3 py-4 text-center">
                    ${!hasRMA ? `
                        <button onclick="showRMAModal(${idx})" class="text-amber-500 hover:text-amber-600 transition-colors mr-2" title="Completar retiro con RMA">
                            <span class="material-symbols-outlined text-[18px]">assignment_turned_in</span>
                        </button>
                    ` : ''}
                    <button onclick="deleteRetired(${idx})" class="text-slate-300 hover:text-red-500 transition-colors" title="Eliminar registro">
                        <span class="material-symbols-outlined text-[18px]">delete</span>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        document.getElementById('retiredStats').innerText = `Total: ${data.length}`;
    }

    // Renderizar tabla de tóner
    function renderTonerTable(data) {
        const tbody = document.getElementById('tonerTableBody');
        tbody.innerHTML = '';
        
        if (data.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="px-6 py-12 text-center text-gray-500">
                        <span class="material-symbols-outlined text-6xl mb-4 block">local_printshop</span>
                        No hay tóners registrados
                    </td>
                </tr>
            `;
            document.getElementById('tonerStats').innerText = 'Total: 0';
            return;
        }
        
        data.forEach((item, idx) => {
            const statusColor = item.status === 'Disponible' ? 'text-emerald-500 bg-emerald-50' : 
                               item.status === 'En Uso' ? 'text-blue-500 bg-blue-50' : 
                               'text-slate-400 bg-slate-50';
            
            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800/40 transition-colors border-b dark:border-slate-800";
            tr.innerHTML = `
                <td class="px-3 py-4">${item.element || '-'}</td>
                <td class="px-3 py-4 font-bold">${item.model || '-'}</td>
                <td class="px-3 py-4">${item.printerModel || '-'}</td>
                <td class="px-3 py-4">
                    <span class="px-2 py-1 rounded text-[10px] font-bold" style="background: ${item.color === 'Negro' ? '#333' : item.color === 'Cian' ? '#00bcd4' : item.color === 'Magenta' ? '#e91e63' : '#ffeb3b'}; color: ${item.color === 'Negro' || item.color === 'Cian' || item.color === 'Magenta' ? 'white' : 'black'}">${item.color || '-'}</span>
                </td>
                <td class="px-3 py-4">${item.location || '-'}</td>
                <td class="px-3 py-4">${item.dateReg || '-'}</td>
                <td class="px-3 py-4">
                    <div class="flex flex-col gap-1">
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 rounded-full text-[10px] font-black uppercase ${statusColor}">${item.status || '-'}</span>
                            ${item.status === 'Disponible' ? `
                                <button onclick="showAssignTonerModal(${idx})" class="text-purple-500 hover:text-purple-700 transition-colors" title="Asignar a impresora">
                                    <span class="material-symbols-outlined text-[16px]">arrow_forward</span>
                                </button>
                            ` : ''}
                        </div>
                        ${item.status === 'Usado' && item.assignedTo ? `
                            <div class="text-[9px] text-slate-500">
                                <div class="font-mono font-semibold" title="Asignado a">S/N: ${item.assignedTo}</div>
                                <div class="text-slate-400 italic" title="Fecha de asignación">📅 ${item.assignedDate || '-'}</div>
                            </div>
                        ` : ''}
                    </div>
                </td>
                <td class="px-3 py-4">
                    <div class="truncate-cell" style="max-width: 150px;" title="${item.observation || ''}">${item.observation || '-'}</div>
                </td>
                <td class="px-3 py-4 text-center">
                    <button onclick="deleteToner(${idx})" class="text-slate-300 hover:text-red-500 transition-colors">
                        <span class="material-symbols-outlined text-[18px]">delete</span>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        document.getElementById('tonerStats').innerText = `Total: ${data.length}`;
    }

    // Renderizar tabla de contadores con edición inline
    function renderCountersTable(data) {
        const tbody = document.getElementById('countersTableBody');
        tbody.innerHTML = '';
        
        if (data.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                        <span class="material-symbols-outlined text-6xl mb-4 block">calculate</span>
                        No hay contadores registrados
                    </td>
                </tr>
            `;
            document.getElementById('countersStats').innerText = 'Total: 0';
            return;
        }
        
        data.forEach((item, idx) => {
            const total = (parseFloat(item.bn) || 0) + (parseFloat(item.color) || 0);
            
            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800/40 transition-colors border-b dark:border-slate-800";
            tr.innerHTML = `
                <td class="px-3 py-4 font-mono font-bold">${item.serial || '-'}</td>
                <td class="px-3 py-4">${item.model || '-'}</td>
                <td class="px-3 py-4">
                    <input type="number" 
                           value="${item.bn || 0}" 
                           onchange="updateCounterField(${idx}, 'bn', this.value)"
                           class="w-full font-bold text-slate-700 dark:text-slate-300 bg-transparent border border-slate-300 dark:border-slate-600 rounded px-2 py-1 focus:ring-2 focus:ring-primary focus:border-transparent" />
                </td>
                <td class="px-3 py-4">
                    <input type="number" 
                           value="${item.color || 0}" 
                           onchange="updateCounterField(${idx}, 'color', this.value)"
                           class="w-full font-bold text-primary bg-transparent border border-slate-300 dark:border-slate-600 rounded px-2 py-1 focus:ring-2 focus:ring-primary focus:border-transparent" />
                </td>
                <td class="px-3 py-4 font-bold text-emerald-600 dark:text-emerald-400">${total.toLocaleString()}</td>
                <td class="px-3 py-4">
                    <input type="text" 
                           value="${item.location || ''}" 
                           onchange="updateCounterField(${idx}, 'location', this.value)"
                           class="w-full bg-transparent border border-slate-300 dark:border-slate-600 rounded px-2 py-1 focus:ring-2 focus:ring-primary focus:border-transparent" />
                </td>
                <td class="px-3 py-4 text-center">
                    <button onclick="deleteCounter(${idx})" class="text-slate-300 hover:text-red-500 transition-colors">
                        <span class="material-symbols-outlined text-[18px]">delete</span>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        document.getElementById('countersStats').innerText = `Total: ${data.length}`;
    }

    // Filtrar tabla de contadores por serie
    function filterCountersTable() {
        const serialFilter = document.getElementById('filter-counter-serial').value.toLowerCase();
        const filteredCounters = counters.filter(c => {
            const serial = (c.serial || '').toLowerCase();
            return serial.includes(serialFilter);
        });
        renderCountersTable(filteredCounters);
    }

    // Actualizar campo individual de contador
    function updateCounterField(index, field, value) {
        if (index < 0 || index >= counters.length) return;
        
        // Actualizar el valor
        if (field === 'bn' || field === 'color') {
            counters[index][field] = parseFloat(value) || 0;
        } else {
            counters[index][field] = value;
        }
        
        // Guardar en localStorage
        localStorage.setItem('counters_cache', JSON.stringify(counters));
        
        // Re-renderizar la tabla
        renderCountersTable(counters);
        
        // Sincronizar con Google Sheets
        syncCounterToGoogleSheets(counters[index]);
    }

    // Sincronizar contador actualizado con Google Sheets
    async function syncCounterToGoogleSheets(counter) {
        try {
            const response = await fetch('https://script.google.com/macros/s/AKfycbzZLr-aI06X-j-r6F_QUiIDkfg3mEIWQsXvMvl6v3GJqgR2SdJPcxBXnIzGWn4LnBJj/exec', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    action: 'updateCounter',
                    serial: counter.serial,
                    bn: counter.bn || 0,
                    color: counter.color || 0,
                    location: counter.location || ''
                })
            });
            
            const result = await response.json();
            if (!result.success) {
                console.error('Error al sincronizar contador:', result.error);
            }
        } catch (error) {
            console.error('Error en sincronización:', error);
        }
    }

    // Funciones para eliminar registros
    function deleteRetired(index) {
        if (confirm("¿Eliminar este registro?")) {
            retired.splice(index, 1);
            localStorage.setItem('retired_cache', JSON.stringify(retired));
            renderRetiredTable(retired);
        }
    }

    function deleteToner(index) {
        if (confirm("¿Eliminar este registro?")) {
            toners.splice(index, 1);
            localStorage.setItem('toners_cache', JSON.stringify(toners));
            renderTonerTable(toners);
        }
    }

    function deleteCounter(index) {
        if (confirm("¿Eliminar este registro?")) {
            counters.splice(index, 1);
            localStorage.setItem('counters_cache', JSON.stringify(counters));
            renderCountersTable(counters);
        }
    }

    // Funciones para el historial de tareas
    function showHistory(serial) {
        currentHistorySerial = serial;
        document.getElementById('history-serial').textContent = serial;
        document.getElementById('history-modal').classList.remove('hidden');
        renderHistory(serial);
    }

    function closeHistoryModal() {
        document.getElementById('history-modal').classList.add('hidden');
        document.getElementById('new-note').value = '';
        currentHistorySerial = null;
    }

    function renderHistory(serial) {
        const historyContent = document.getElementById('history-content');
        const notes = history[serial] || [];
        
        if (notes.length === 0) {
            historyContent.innerHTML = `
                <div class="text-center py-12 text-slate-400">
                    <span class="material-symbols-outlined text-5xl mb-3 opacity-30">history</span>
                    <p class="font-medium">No hay registros de tareas</p>
                    <p class="text-xs mt-1">Agrega la primera nota abajo</p>
                </div>
            `;
        } else {
            historyContent.innerHTML = notes.map((note, idx) => `
                <div class="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-4 border border-slate-200 dark:border-slate-700 hover:border-primary/30 transition-colors">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary text-[18px]">event_note</span>
                            <span class="text-xs font-bold text-slate-500">${note.date}</span>
                        </div>
                        <button onclick="deleteHistoryNote('${serial}', ${idx})" class="text-slate-300 hover:text-red-500 transition-colors">
                            <span class="material-symbols-outlined text-[16px]">close</span>
                        </button>
                    </div>
                    <p class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed whitespace-pre-wrap">${note.note}</p>
                </div>
            `).reverse().join('');
        }
    }

    function deleteHistoryNote(serial, index) {
        if (confirm("¿Eliminar esta nota?")) {
            history[serial].splice(index, 1);
            if (history[serial].length === 0) {
                delete history[serial];
            }
            localStorage.setItem('history_cache', JSON.stringify(history));
            renderHistory(serial);
        }
    }

    // Manejo del formulario de agregar nota
    document.getElementById('add-note-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const noteText = document.getElementById('new-note').value.trim();
        if (noteText && currentHistorySerial) {
            const newNote = {
                date: new Date().toLocaleString('es-CO', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }),
                note: noteText
            };
            
            if (!history[currentHistorySerial]) {
                history[currentHistorySerial] = [];
            }
            history[currentHistorySerial].push(newNote);
            localStorage.setItem('history_cache', JSON.stringify(history));
            
            document.getElementById('new-note').value = '';
            renderHistory(currentHistorySerial);
        }
    });

    function filterTableByColumns() {
        applyAllFilters();
    }

    // Variables para rastrear filtros activos de gráficas
    let activePrinterStatusFilter = null;
    let activeTonerStatusFilter = null;

    // Actualizar estadísticas de las gráficas
    function updateChartStats() {
        // Contar estados de impresora
        let countOperativa = 0;
        let countFuera = 0;
        let countSinUbicar = 0;
        
        // Contar estados de tóner
        let countToner0 = 0;
        let countToner30 = 0;
        let countToner50 = 0;
        let countToner80 = 0;
        
        printers.forEach(p => {
            // Contar por estado de impresora
            if (p.status === 'Operativa') countOperativa++;
            else if (p.status === 'Fuera de servicio') countFuera++;
            else if (p.status === 'Sin ubicar') countSinUbicar++;
            
            // Contar por estado de tóner
            const tonerStatus = calculateTonerStatus(p.serial, p.model);
            const tonerPercentage = parseFloat(tonerStatus.percentage);
            
            if (tonerPercentage >= 0 && tonerPercentage < 30) countToner0++;
            else if (tonerPercentage >= 30 && tonerPercentage < 50) countToner30++;
            else if (tonerPercentage >= 50 && tonerPercentage < 80) countToner50++;
            else if (tonerPercentage >= 80 && tonerPercentage <= 100) countToner80++;
        });
        
        // Actualizar UI
        document.getElementById('count-operativa').innerText = countOperativa;
        document.getElementById('count-fuera').innerText = countFuera;
        document.getElementById('count-sinubicar').innerText = countSinUbicar;
        
        document.getElementById('count-toner-0').innerText = countToner0;
        document.getElementById('count-toner-30').innerText = countToner30;
        document.getElementById('count-toner-50').innerText = countToner50;
        document.getElementById('count-toner-80').innerText = countToner80;
    }

    // Toggle filtro por estado de impresora desde gráfica
    function togglePrinterStatusFilter(status) {
        const chartElement = document.getElementById('chart-' + (status === 'Operativa' ? 'operativa' : status === 'Fuera de servicio' ? 'fuera' : 'sinubicar'));
        
        // Si ya está activo, desactivar
        if (activePrinterStatusFilter === status) {
            activePrinterStatusFilter = null;
            chartElement.classList.remove('ring-4', 'ring-primary', 'border-primary');
            chartElement.classList.add('border-transparent');
            
            // Aplicar otros filtros activos
            applyAllFilters();
        } else {
            // Desactivar filtro anterior si existe
            if (activePrinterStatusFilter) {
                const prevChart = document.getElementById('chart-' + (activePrinterStatusFilter === 'Operativa' ? 'operativa' : activePrinterStatusFilter === 'Fuera de servicio' ? 'fuera' : 'sinubicar'));
                prevChart.classList.remove('ring-4', 'ring-primary', 'border-primary');
                prevChart.classList.add('border-transparent');
            }
            
            // Activar nuevo filtro
            activePrinterStatusFilter = status;
            chartElement.classList.add('ring-4', 'ring-primary', 'border-primary');
            chartElement.classList.remove('border-transparent');
            
            applyAllFilters();
        }
    }

    // Toggle filtro por estado de tóner desde gráfica
    function toggleTonerStatusFilter(range) {
        const chartElement = document.getElementById('chart-toner-' + range.split('-')[0]);
        
        // Si ya está activo, desactivar
        if (activeTonerStatusFilter === range) {
            activeTonerStatusFilter = null;
            chartElement.classList.remove('ring-4', 'ring-primary', 'border-primary');
            chartElement.classList.add('border-transparent');
            
            // Aplicar otros filtros activos
            applyAllFilters();
        } else {
            // Desactivar filtro anterior si existe
            if (activeTonerStatusFilter) {
                const prevChart = document.getElementById('chart-toner-' + activeTonerStatusFilter.split('-')[0]);
                prevChart.classList.remove('ring-4', 'ring-primary', 'border-primary');
                prevChart.classList.add('border-transparent');
            }
            
            // Activar nuevo filtro
            activeTonerStatusFilter = range;
            chartElement.classList.add('ring-4', 'ring-primary', 'border-primary');
            chartElement.classList.remove('border-transparent');
            
            applyAllFilters();
        }
    }

    // Aplicar todos los filtros activos (inputs + gráficas)
    function applyAllFilters() {
        const filterSerial = document.getElementById('filter-serial').value.toLowerCase();
        const filterModel = document.getElementById('filter-model').value.toLowerCase();
        const filterCity = document.getElementById('filter-city').value.toLowerCase();
        const filterDept = document.getElementById('filter-dept').value.toLowerCase();
        const filterAddress = document.getElementById('filter-address').value.toLowerCase();
        const filterArea = document.getElementById('filter-area').value.toLowerCase();
        const filterContact = document.getElementById('filter-contact').value.toLowerCase();
        const filterStatus = document.getElementById('filter-status').value;
        const filterToner = document.getElementById('filter-toner').value;
        
        const filtered = printers.filter(p => {
            const tonerStatus = calculateTonerStatus(p.serial, p.model);
            const tonerPercentage = parseFloat(tonerStatus.percentage);
            
            const matchSerial = !filterSerial || (p.serial || '').toLowerCase().includes(filterSerial);
            const matchModel = !filterModel || (p.model || '').toLowerCase().includes(filterModel);
            const matchCity = !filterCity || (p.city || '').toLowerCase().includes(filterCity);
            const matchDept = !filterDept || (p.dept || '').toLowerCase().includes(filterDept);
            const matchAddress = !filterAddress || (p.address || '').toLowerCase().includes(filterAddress);
            const matchArea = !filterArea || (p.area || '').toLowerCase().includes(filterArea);
            const matchContact = !filterContact || (p.contact || '').toLowerCase().includes(filterContact);
            const matchStatus = !filterStatus || p.status === filterStatus;
            
            // Filtrar por rango de porcentaje de tóner (inputs)
            let matchToner = true;
            if (filterToner) {
                if (filterToner === 'verde') {
                    matchToner = tonerPercentage >= 0 && tonerPercentage < 30;
                } else if (filterToner === 'amarillo') {
                    matchToner = tonerPercentage >= 30 && tonerPercentage < 50;
                } else if (filterToner === 'naranja') {
                    matchToner = tonerPercentage >= 50 && tonerPercentage < 80;
                } else if (filterToner === 'rojo') {
                    matchToner = tonerPercentage >= 80 && tonerPercentage <= 100;
                }
            }
            
            // Filtrar por estado de impresora desde gráfica
            const matchChartStatus = !activePrinterStatusFilter || p.status === activePrinterStatusFilter;
            
            // Filtrar por estado de tóner desde gráfica
            let matchChartToner = true;
            if (activeTonerStatusFilter) {
                const [min, max] = activeTonerStatusFilter.split('-').map(Number);
                matchChartToner = tonerPercentage >= min && tonerPercentage <= max;
            }
            
            return matchSerial && matchModel && matchCity && matchDept && matchAddress && 
                   matchArea && matchContact && matchStatus && matchToner && 
                   matchChartStatus && matchChartToner;
        });
        
        renderTable(filtered);
    }

    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-emerald-500' : 'bg-red-500';
        toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-xl text-sm font-bold flex items-center gap-2 transform translate-x-10 opacity-0 transition-all duration-300`;
        toast.innerHTML = `<span class="material-symbols-outlined">${type === 'success' ? 'check_circle' : 'error'}</span> ${message}`;
        
        container.appendChild(toast);
        setTimeout(() => { toast.classList.remove('translate-x-10', 'opacity-0'); }, 10);
        setTimeout(() => {
            toast.classList.add('translate-x-10', 'opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }

    document.getElementById('printerRegistrationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const btn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnSpinner = document.getElementById('btnSpinner');
        
        const fd = new FormData(this);
        
        // Objeto con los datos en el formato correcto para Apps Script
        const data = {
            dateReg: fd.get('dateReg') || '',           // Fecha de registro
            dateInst: fd.get('dateInst') || 'Instalación pendiente',         // Fecha de instalacion
            serial: fd.get('serial') || '',             // Numero de serie
            mac: fd.get('mac') || '',                   // MAC
            model: fd.get('model') || '',               // Modelo
            city: fd.get('city') || '',                 // Cuidad
            dept: fd.get('dept') || '',                 // Departamento
            ip: fd.get('ip') || '',                     // IP
            gateway: fd.get('gateway') || '',           // Getway
            mask: fd.get('mask') || '',                 // Mascara
            address: fd.get('address') || '',           // Direccion del equipo
            area: fd.get('area') || '',                 // Area
            contact: fd.get('contact') || '',           // Contacto
            phone: fd.get('phone') || '',               // Celular
            status: fd.get('status') || '',             // Estado de impresora
            escaner: fd.get('escaner') === 'on' ? 'SÍ' : 'NO',  // Escaner (Checkbox)
            slnx: fd.get('slnx') === 'on' ? 'SÍ' : 'NO',        // Slnx (Checkbox)
            ndd: fd.get('ndd') === 'on' ? 'SÍ' : 'NO',          // NDD (Checkbox)
            note: fd.get('note') || '',                 // Nota
            countInit: fd.get('counterInitial') || 0    // Contador Inicial
        };
        
        // Guardar localmente con formato booleano para la tabla
        const localData = {
            dateReg: fd.get('dateReg') || '',
            dateInst: fd.get('dateInst') || 'Instalación pendiente',
            serial: fd.get('serial') || '',
            mac: fd.get('mac') || '',
            model: fd.get('model') || '',
            city: fd.get('city') || '',
            dept: fd.get('dept') || '',
            ip: fd.get('ip') || '',
            gateway: fd.get('gateway') || '',
            mask: fd.get('mask') || '',
            address: fd.get('address') || '',
            area: fd.get('area') || '',
            contact: fd.get('contact') || '',
            phone: fd.get('phone') || '',
            status: fd.get('status') || '',
            escaner: fd.get('escaner') === 'on',
            slnx: fd.get('slnx') === 'on',
            ndd: fd.get('ndd') === 'on',
            note: fd.get('note') || '',
            counterInitial: fd.get('counterInitial') || 0
        };

        // Bloquear UI
        btn.disabled = true;
        btnText.innerText = "Enviando...";
        btnSpinner.classList.remove('hidden');

        try {
            // Envío a Google Apps Script usando no-cors para evitar problemas pre-flight si no está configurado el script
            // Nota: Con no-cors no podemos leer la respuesta pero el envío es más robusto si el script es sencillo.
            // Para poder leer la respuesta, el script debe manejar OPTIONS y CORS.
            const response = await fetch(WEB_APP_URL, {
                method: "POST",
                mode: "no-cors", 
                cache: "no-cache",
                headers: { 
                    "Content-Type": "application/json; charset=UTF-8"
                },
                body: JSON.stringify(data)
            });

            // Guardar localmente
            printers.unshift(localData);
            localStorage.setItem('printers_cache', JSON.stringify(printers));
            
            showToast("Registro guardado exitosamente");
            this.reset();
            showView('inventory');

        } catch (error) {
            console.error("Error:", error);
            showToast("Error de conexión con el servidor", "error");
        } finally {
            btn.disabled = false;
            btnText.innerText = "Guardar en Google Sheets";
            btnSpinner.classList.add('hidden');
        }
    });

    function deletePrinter(index) {
        if (confirm("¿Eliminar este registro de la vista local? (No se borrará de Google Sheets)")) {
            printers.splice(index, 1);
            localStorage.setItem('printers_cache', JSON.stringify(printers));
            renderTable(printers);
        }
    }

    function deletePrinterFromDetails(index) {
        if (confirm("¿Eliminar este equipo del inventario? Esta acción solo lo eliminará de la vista local.")) {
            printers.splice(index, 1);
            localStorage.setItem('printers_cache', JSON.stringify(printers));
            closeDetailsModal();
            renderTable(printers);
            showToast('Equipo eliminado del inventario', 'success');
        }
    }

    function toggleDarkMode() {
        document.documentElement.classList.toggle('dark');
        const isDark = document.documentElement.classList.contains('dark');
        document.getElementById('dark-mode-icon').innerText = isDark ? 'light_mode' : 'dark_mode';
        // Guardar preferencia en localStorage
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    // Función para ir al inicio (refrescar y volver a Inventario)
    function goHome() {
        location.reload();
    }

    // Variables globales para las gráficas
    let chartInstances = {};

    // Función para mostrar el modal de gráficas
    function showChartsModal() {
        const modal = document.getElementById('charts-modal');
        modal.classList.remove('hidden');
        
        // Generar las gráficas
        setTimeout(() => {
            generateCharts();
        }, 100);
    }

    // Función para cerrar el modal de gráficas
    function closeChartsModal() {
        const modal = document.getElementById('charts-modal');
        modal.classList.add('hidden');
        
        // Destruir las gráficas para liberar memoria
        Object.values(chartInstances).forEach(chart => {
            if (chart) chart.destroy();
        });
        chartInstances = {};
    }

    // Función para generar todas las gráficas
    function generateCharts() {
        // Registrar el plugin de datalabels globalmente
        Chart.register(ChartDataLabels);
        
        const isDark = document.documentElement.classList.contains('dark');
        const textColor = isDark ? '#e2e8f0' : '#1e293b';
        const gridColor = isDark ? '#334155' : '#e2e8f0';
        
        // 1. Estado de Impresoras
        const statusCounts = {
            'Operativa': printers.filter(p => p.status === 'Operativa').length,
            'Fuera de servicio': printers.filter(p => p.status === 'Fuera de servicio').length,
            'Sin ubicar': printers.filter(p => p.status === 'Sin ubicar').length
        };
        
        if (chartInstances['printerStatus']) chartInstances['printerStatus'].destroy();
        chartInstances['printerStatus'] = new Chart(document.getElementById('chart-printer-status'), {
            type: 'bar',
            data: {
                labels: Object.keys(statusCounts),
                datasets: [{
                    label: 'Cantidad',
                    data: Object.values(statusCounts),
                    backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 30
                    }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: textColor,
                        font: { weight: 'bold', size: 12 },
                        formatter: (value) => value
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: textColor, stepSize: 1 },
                        grid: { color: gridColor }
                    },
                    x: {
                        ticks: { color: textColor },
                        grid: { display: false }
                    }
                }
            }
        });
        
        // 2. Distribución por Área
        const areaCounts = {};
        printers.forEach(p => {
            areaCounts[p.area] = (areaCounts[p.area] || 0) + 1;
        });
        
        if (chartInstances['byArea']) chartInstances['byArea'].destroy();
        chartInstances['byArea'] = new Chart(document.getElementById('chart-by-area'), {
            type: 'bar',
            data: {
                labels: Object.keys(areaCounts),
                datasets: [{
                    label: 'Cantidad',
                    data: Object.values(areaCounts),
                    backgroundColor: '#0d7ff2',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 30
                    }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: textColor,
                        font: { weight: 'bold', size: 12 },
                        formatter: (value) => value
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: textColor, stepSize: 1 },
                        grid: { color: gridColor }
                    },
                    x: {
                        ticks: { color: textColor },
                        grid: { display: false }
                    }
                }
            }
        });
        
        // 3. Distribución por Departamento
        const deptCounts = {};
        printers.forEach(p => {
            deptCounts[p.dept] = (deptCounts[p.dept] || 0) + 1;
        });
        
        if (chartInstances['byDept']) chartInstances['byDept'].destroy();
        chartInstances['byDept'] = new Chart(document.getElementById('chart-by-dept'), {
            type: 'bar',
            data: {
                labels: Object.keys(deptCounts),
                datasets: [{
                    label: 'Cantidad',
                    data: Object.values(deptCounts),
                    backgroundColor: '#8b5cf6',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 30
                    }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: textColor,
                        font: { weight: 'bold', size: 12 },
                        formatter: (value) => value
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: textColor, stepSize: 1 },
                        grid: { color: gridColor }
                    },
                    x: {
                        ticks: { color: textColor },
                        grid: { display: false }
                    }
                }
            }
        });
        
        // 4. Estado de Escáner
        const scannerCounts = {
            'Con Escáner': printers.filter(p => p.escaner === true || p.escaner === 'true').length,
            'Sin Escáner': printers.filter(p => !p.escaner || p.escaner === 'false' || p.escaner === false).length
        };
        
        if (chartInstances['scanner']) chartInstances['scanner'].destroy();
        chartInstances['scanner'] = new Chart(document.getElementById('chart-scanner-status'), {
            type: 'bar',
            data: {
                labels: Object.keys(scannerCounts),
                datasets: [{
                    label: 'Cantidad',
                    data: Object.values(scannerCounts),
                    backgroundColor: ['#10b981', '#94a3b8'],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 30
                    }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: textColor,
                        font: { weight: 'bold', size: 12 },
                        formatter: (value) => value
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: textColor, stepSize: 1 },
                        grid: { color: gridColor }
                    },
                    x: {
                        ticks: { color: textColor },
                        grid: { display: false }
                    }
                }
            }
        });
        
        // 5. Estado de SLNX
        const slnxCounts = {
            'Con SLNX': printers.filter(p => p.slnx === true || p.slnx === 'true').length,
            'Sin SLNX': printers.filter(p => !p.slnx || p.slnx === 'false' || p.slnx === false).length
        };
        
        if (chartInstances['slnx']) chartInstances['slnx'].destroy();
        chartInstances['slnx'] = new Chart(document.getElementById('chart-slnx-status'), {
            type: 'bar',
            data: {
                labels: Object.keys(slnxCounts),
                datasets: [{
                    label: 'Cantidad',
                    data: Object.values(slnxCounts),
                    backgroundColor: ['#3b82f6', '#94a3b8'],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 30
                    }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: textColor,
                        font: { weight: 'bold', size: 12 },
                        formatter: (value) => value
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: textColor, stepSize: 1 },
                        grid: { color: gridColor }
                    },
                    x: {
                        ticks: { color: textColor },
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // Función para hacer scroll a las estadísticas
    function scrollToStatistics() {
        const statsSection = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-7');
        if (statsSection) {
            statsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    // Función para toggle del menú de configuración
    function toggleSettingsMenu() {
        const menu = document.getElementById('settings-menu');
        const isHidden = menu.classList.contains('hidden');
        
        if (isHidden) {
            // Actualizar contenido según el módulo activo antes de mostrar
            updateSettingsMenuContent();
        }
        
        menu.classList.toggle('hidden');
        // Cerrar el menú de módulos si está abierto
        document.getElementById('modules-menu').classList.add('hidden');
    }

    // Función para actualizar el contenido del menú según el módulo activo
    function updateSettingsMenuContent() {
        const menuContent = document.getElementById('settings-menu-content');
        
        if (currentTab === 'retired') {
            // Solo Exportar CSV para Retiradas
            menuContent.innerHTML = `
                <button onclick="exportModuleToCSV()" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-3">
                    <span class="material-symbols-outlined text-[20px] text-primary">download</span>
                    <span class="font-semibold text-sm">Exportar CSV</span>
                </button>
            `;
        } else {
            // Exportar CSV, Exportar CSV en blanco, Importar CSV para otros módulos
            menuContent.innerHTML = `
                <button onclick="exportModuleToCSV()" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-3">
                    <span class="material-symbols-outlined text-[20px] text-primary">download</span>
                    <span class="font-semibold text-sm">Exportar CSV</span>
                </button>
                <button onclick="exportModuleBlankCSV()" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-3">
                    <span class="material-symbols-outlined text-[20px] text-emerald-500">description</span>
                    <span class="font-semibold text-sm">Exportar CSV en blanco</span>
                </button>
                <div class="border-t border-slate-200 dark:border-slate-700 my-2"></div>
                <label class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-3 cursor-pointer">
                    <span class="material-symbols-outlined text-[20px] text-amber-500">upload_file</span>
                    <span class="font-semibold text-sm">Importar CSV</span>
                    <input type="file" id="csv-import-${currentTab}" accept=".csv" class="hidden" onchange="importModuleCSV(event)">
                </label>
                <div class="px-4 py-2 text-xs text-slate-500 dark:text-slate-400">
                    <p class="font-semibold mb-1">Formato soportado:</p>
                    <p>• Separador: coma (,) o punto y coma (;)</p>
                </div>
            `;
        }
    }

    // Función para toggle del menú de módulos
    function toggleModulesMenu() {
        const menu = document.getElementById('modules-menu');
        menu.classList.toggle('hidden');
        // Cerrar el menú de configuración si está abierto
        document.getElementById('settings-menu').classList.add('hidden');
    }

    // Función para cambiar de pestaña desde el menú
    function switchTabFromMenu(tab) {
        switchTab(tab);
        // Cerrar el menú después de seleccionar
        document.getElementById('modules-menu').classList.add('hidden');
        
        // Actualizar el botón del menú con el módulo actual
        const moduleData = {
            'inventory': { icon: 'inventory_2', name: 'Inventario' },
            'retired': { icon: 'delete_sweep', name: 'Retiradas' },
            'toner': { icon: 'local_printshop', name: 'Backup Tóner' },
            'counters': { icon: 'calculate', name: 'Contadores' }
        };
        
        document.getElementById('current-module-icon').innerText = moduleData[tab].icon;
        document.getElementById('current-module-name').innerText = moduleData[tab].name;
    }

    // Cerrar los menús si se hace clic fuera
    document.addEventListener('click', function(event) {
        const settingsMenu = document.getElementById('settings-menu');
        const settingsBtn = document.getElementById('settings-btn');
        const modulesMenu = document.getElementById('modules-menu');
        const modulesBtn = document.getElementById('modules-btn');
        const chartsModal = document.getElementById('charts-modal');
        
        // Cerrar menú de configuración
        if (settingsMenu && settingsBtn && !settingsMenu.contains(event.target) && !settingsBtn.contains(event.target)) {
            settingsMenu.classList.add('hidden');
        }
        
        // Cerrar menú de módulos
        if (modulesMenu && modulesBtn && !modulesMenu.contains(event.target) && !modulesBtn.contains(event.target)) {
            modulesMenu.classList.add('hidden');
        }
        
        // Cerrar modal de gráficas al hacer clic fuera
        if (chartsModal && event.target === chartsModal) {
            closeChartsModal();
        }
    });

    // Funciones de exportación/importación genéricas para todos los módulos
    function exportModuleToCSV() {
        let headers, rows, filename, data;
        
        switch(currentTab) {
            case 'inventory':
                headers = ["Fecha Reg", "Fecha Inst", "S/N", "MAC", "Modelo", "Ciudad", "Depto", "IP", "Gateway", "Mask", "Direccion", "Area", "Contacto", "Celular", "Estado", "Escaner", "Slnx", "NDD", "Nota", "Contador Inicial"];
                rows = printers.map(p => [
                    p.dateReg, p.dateInst, p.serial, p.mac, p.model, p.city, p.dept, p.ip, p.gateway, p.mask, p.address, p.area, p.contact, p.phone, p.status, p.escaner ? "SI":"NO", p.slnx ? "SI":"NO", p.ndd ? "SI":"NO", p.note, p.counterInitial
                ]);
                filename = `inventario_${new Date().toISOString().split('T')[0]}.csv`;
                break;
                
            case 'retired':
                headers = ["Serial", "Modelo", "Ubicación", "Fecha Retiro", "Contacto", "RMA"];
                rows = retired.map(r => [
                    r.serial, r.model, r.location, r.dateRetired || '', r.contact, r.rma || ''
                ]);
                filename = `retiradas_${new Date().toISOString().split('T')[0]}.csv`;
                break;
                
            case 'toner':
                headers = ["Elemento", "Modelo", "Mod.Impresora", "Color", "Ubicación", "Fecha", "Estado", "Serial Asignado", "Fecha Asignación", "Observación"];
                rows = toners.map(t => [
                    t.element, t.model, t.printerModel, t.color, t.location, t.dateReg, t.status, t.assignedTo || '', t.assignedDate || '', t.observation || ''
                ]);
                filename = `backup_toner_${new Date().toISOString().split('T')[0]}.csv`;
                break;
                
            case 'counters':
                headers = ["Serie", "Modelo", "B/N", "Color", "Total", "Ubicación"];
                rows = counters.map(c => {
                    const total = (parseFloat(c.bn) || 0) + (parseFloat(c.color) || 0);
                    return [c.serial, c.model, c.bn || 0, c.color || 0, total, c.location || ''];
                });
                filename = `contadores_${new Date().toISOString().split('T')[0]}.csv`;
                break;
                
            default:
                showToast("Módulo no reconocido", "error");
                return;
        }
        
        // Agregar BOM UTF-8 para que Excel lea correctamente los acentos
        const BOM = '\uFEFF';
        const csvContent = [headers, ...rows].map(e => e.map(cell => {
            // Escapar comillas y comas en los valores
            const cellStr = String(cell || '');
            if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                return '"' + cellStr.replace(/"/g, '""') + '"';
            }
            return cellStr;
        }).join(",")).join("\n");
        
        let content = "data:text/csv;charset=utf-8," + encodeURIComponent(BOM + csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", content);
        link.setAttribute("download", filename);
        link.click();
        
        document.getElementById('settings-menu').classList.add('hidden');
        showToast("CSV exportado correctamente", "success");
    }

    function exportModuleBlankCSV() {
        let headers, filename;
        
        switch(currentTab) {
            case 'inventory':
                headers = ["Fecha Reg", "Fecha Inst", "S/N", "MAC", "Modelo", "Ciudad", "Depto", "IP", "Gateway", "Mask", "Direccion", "Area", "Contacto", "Celular", "Estado", "Escaner", "Slnx", "NDD", "Nota", "Contador Inicial"];
                filename = `plantilla_inventario_${new Date().toISOString().split('T')[0]}.csv`;
                break;
                
            case 'toner':
                headers = ["Elemento", "Modelo", "Mod.Impresora", "Color", "Ubicación", "Fecha", "Estado", "Observación"];
                filename = `plantilla_toner_${new Date().toISOString().split('T')[0]}.csv`;
                break;
                
            case 'counters':
                headers = ["Serie", "Modelo", "B/N", "Color", "Ubicación"];
                filename = `plantilla_contadores_${new Date().toISOString().split('T')[0]}.csv`;
                break;
                
            default:
                showToast("Módulo no reconocido", "error");
                return;
        }
        
        // Agregar BOM UTF-8 para Excel
        const BOM = '\uFEFF';
        let content = "data:text/csv;charset=utf-8," + encodeURIComponent(BOM + headers.join(",") + "\n");
        const link = document.createElement("a");
        link.setAttribute("href", content);
        link.setAttribute("download", filename);
        link.click();
        
        document.getElementById('settings-menu').classList.add('hidden');
        showToast("Plantilla CSV descargada correctamente", "success");
    }

    // Función para sincronizar CSV importado con Google Sheets
    async function syncCSVToGoogleSheets(data, module, totalRecords) {
        if (data.length === 0) return;
        
        // Mostrar progreso
        showToast(`Sincronizando ${totalRecords} registros con Google Sheets...`, "success");
        
        try {
            // Preparar datos según el módulo
            let payload = {
                action: 'bulkInsert',
                module: module,
                records: []
            };
            
            // Convertir datos al formato esperado por Google Apps Script
            if (module === 'inventory') {
                payload.records = data.map(p => ({
                    dateReg: p.dateReg || '',
                    dateInst: p.dateInst || 'Instalación pendiente',
                    serial: p.serial || '',
                    mac: p.mac || '',
                    model: p.model || '',
                    city: p.city || '',
                    dept: p.dept || '',
                    ip: p.ip || '',
                    gateway: p.gateway || '',
                    mask: p.mask || '',
                    address: p.address || '',
                    area: p.area || '',
                    contact: p.contact || '',
                    phone: p.phone || '',
                    status: p.status || '',
                    escaner: p.escaner ? 'SÍ' : 'NO',
                    slnx: p.slnx ? 'SÍ' : 'NO',
                    ndd: p.ndd ? 'SÍ' : 'NO',
                    note: p.note || '',
                    countInit: p.counterInitial || 0
                }));
            } else if (module === 'toner') {
                payload.records = data.map(t => ({
                    element: t.element || '',
                    model: t.model || '',
                    printerModel: t.printerModel || '',
                    color: t.color || '',
                    location: t.location || '',
                    dateReg: t.dateReg || '',
                    status: t.status || '',
                    observation: t.observation || ''
                }));
            } else if (module === 'counters') {
                payload.records = data.map(c => ({
                    serial: c.serial || '',
                    model: c.model || '',
                    bn: c.bn || 0,
                    color: c.color || 0,
                    location: c.location || ''
                }));
            }
            
            // Enviar a Google Apps Script
            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/json; charset=UTF-8'
                },
                body: JSON.stringify(payload)
            });
            
            // Con no-cors no podemos leer la respuesta, pero el envío se realiza
            showToast(`${totalRecords} registros sincronizados con Google Sheets`, "success");
            
        } catch (error) {
            console.error('Error al sincronizar con Google Sheets:', error);
            showToast("Los datos se guardaron localmente, pero hubo un error al sincronizar con Google Sheets", "error");
        }
    }

    function importModuleCSV(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                let text = e.target.result;
                // Eliminar BOM si existe
                if (text.charCodeAt(0) === 0xFEFF) {
                    text = text.slice(1);
                }
                
                // Detectar el separador (coma o punto y coma)
                const firstLine = text.split('\n')[0];
                const separator = firstLine.includes(';') ? ';' : ',';
                
                // Parsear CSV
                const lines = text.split('\n').filter(line => line.trim() !== '');
                const headers = lines[0].split(separator).map(h => h.trim());
                
                let newData = [];
                let moduleData, storageKey, renderFunction;
                
                // Procesar según el módulo activo
                switch(currentTab) {
                    case 'inventory':
                        // Validar headers de inventario
                        const requiredInventoryHeaders = ["S/N", "Modelo", "Ciudad"];
                        if (!requiredInventoryHeaders.every(h => headers.some(header => header.includes(h)))) {
                            showToast("El archivo CSV no tiene el formato correcto para Inventario", "error");
                            return;
                        }
                        
                        // Procesar filas
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(separator).map(v => v.trim());
                            if (values.length < 5) continue;
                            
                            const printer = {
                                dateReg: values[0] || '',
                                dateInst: values[1] || 'Instalación pendiente',
                                serial: values[2] || '',
                                mac: values[3] || '',
                                model: values[4] || '',
                                city: values[5] || '',
                                dept: values[6] || '',
                                ip: values[7] || '',
                                gateway: values[8] || '',
                                mask: values[9] || '',
                                address: values[10] || '',
                                area: values[11] || '',
                                contact: values[12] || '',
                                phone: values[13] || '',
                                status: values[14] || 'Operativa',
                                escaner: values[15] === 'SI' || values[15] === 'SÍ' || values[15] === 'si' || values[15] === 'sí',
                                slnx: values[16] === 'SI' || values[16] === 'SÍ' || values[16] === 'si' || values[16] === 'sí',
                                ndd: values[17] === 'SI' || values[17] === 'SÍ' || values[17] === 'si' || values[17] === 'sí',
                                note: values[18] || '',
                                counterInitial: values[19] || 0
                            };
                            newData.push(printer);
                        }
                        
                        moduleData = printers;
                        storageKey = 'printers_cache';
                        renderFunction = renderTable;
                        break;
                        
                    case 'toner':
                        // Validar headers de tóner
                        const requiredTonerHeaders = ["Elemento", "Modelo", "Color"];
                        if (!requiredTonerHeaders.every(h => headers.some(header => header.includes(h)))) {
                            showToast("El archivo CSV no tiene el formato correcto para Backup de Tóner", "error");
                            return;
                        }
                        
                        // Procesar filas
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(separator).map(v => v.trim());
                            if (values.length < 6) continue;
                            
                            const toner = {
                                element: values[0] || '',
                                model: values[1] || '',
                                printerModel: values[2] || '',
                                color: values[3] || '',
                                location: values[4] || '',
                                dateReg: values[5] || new Date().toLocaleDateString('es-ES'),
                                status: values[6] || 'Disponible',
                                observation: values[7] || ''
                            };
                            newData.push(toner);
                        }
                        
                        moduleData = toners;
                        storageKey = 'toners_cache';
                        renderFunction = renderTonerTable;
                        break;
                        
                    case 'counters':
                        // Validar headers de contadores
                        const requiredCountersHeaders = ["Serie", "Modelo"];
                        if (!requiredCountersHeaders.every(h => headers.some(header => header.includes(h)))) {
                            showToast("El archivo CSV no tiene el formato correcto para Contadores", "error");
                            return;
                        }
                        
                        // Procesar filas
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(separator).map(v => v.trim());
                            if (values.length < 2) continue;
                            
                            const counter = {
                                serial: values[0] || '',
                                model: values[1] || '',
                                bn: values[2] || 0,
                                color: values[3] || 0,
                                location: values[4] || ''
                            };
                            newData.push(counter);
                        }
                        
                        moduleData = counters;
                        storageKey = 'counters_cache';
                        renderFunction = renderCountersTable;
                        break;
                        
                    default:
                        showToast("Módulo no soportado para importación", "error");
                        return;
                }
                
                if (newData.length === 0) {
                    showToast("No se encontraron registros válidos en el CSV", "error");
                    return;
                }
                
                // Preguntar si desea reemplazar o agregar
                const replace = confirm(`Se encontraron ${newData.length} registros.\\n\\n¿Desea REEMPLAZAR los datos actuales?\\n\\nSí = Reemplazar todo\\nNo = Agregar a los datos existentes`);
                
                let finalData;
                if (replace) {
                    finalData = newData;
                } else {
                    finalData = [...moduleData, ...newData];
                }
                
                // Actualizar según el módulo
                if (currentTab === 'inventory') {
                    printers = finalData;
                } else if (currentTab === 'toner') {
                    toners = finalData;
                } else if (currentTab === 'counters') {
                    counters = finalData;
                }
                
                localStorage.setItem(storageKey, JSON.stringify(finalData));
                renderFunction(finalData);
                
                // Cerrar menú
                document.getElementById('settings-menu').classList.add('hidden');
                
                // Sincronizar con Google Sheets
                syncCSVToGoogleSheets(newData, currentTab, newData.length);
                
            } catch (error) {
                console.error('Error al importar CSV:', error);
                showToast("Error al procesar el archivo CSV", "error");
            }
            
            // Limpiar input
            event.target.value = '';
        };
        
        // Leer el archivo como UTF-8
        reader.readAsText(file, 'UTF-8');
    }

    // FUNCIONES DE RETIRO
    let currentRetiredIndex = null;

    function retirePrinter(index) {
        if (!confirm('¿Estás seguro de retirar esta impresora del inventario?')) {
            return;
        }

        const printer = printers[index];
        
        // Crear objeto de retiro con campos vacíos para RMA y fecha
        const retiredPrinter = {
            serial: printer.serial,
            model: printer.model,
            location: `${printer.address || ''} ${printer.city || ''} ${printer.dept || ''}`.trim() || 'Sin ubicación',
            contact: printer.contact || '-',
            rma: '',
            dateRetired: ''
        };

        // Agregar a retirados
        retired.push(retiredPrinter);
        
        // Eliminar del inventario
        printers.splice(index, 1);
        
        // Guardar en localStorage
        localStorage.setItem('printers_cache', JSON.stringify(printers));
        localStorage.setItem('retired_cache', JSON.stringify(retired));
        
        // Cerrar modal y actualizar
        closeDetailsModal();
        renderTable(printers);
        
        // Mostrar mensaje y cambiar a vista de retiradas
        showToast('Impresora retirada del inventario. Completa el retiro con el número de RMA.', 'success');
        switchTab('retired');
    }

    function showRMAModal(index) {
        currentRetiredIndex = index;
        document.getElementById('rma-input').value = '';
        const modal = document.getElementById('rma-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeRMAModal() {
        currentRetiredIndex = null;
        const modal = document.getElementById('rma-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // Manejar envío del formulario RMA
    document.getElementById('rma-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (currentRetiredIndex === null) return;
        
        const rmaNumber = document.getElementById('rma-input').value.trim();
        
        if (!rmaNumber) {
            showToast('Por favor introduce un número de RMA válido', 'error');
            return;
        }
        
        // Actualizar el registro retirado con RMA y fecha actual
        retired[currentRetiredIndex].rma = rmaNumber;
        retired[currentRetiredIndex].dateRetired = new Date().toLocaleDateString('es-ES');
        
        // Guardar en localStorage
        localStorage.setItem('retired_cache', JSON.stringify(retired));
        
        // Actualizar tabla
        renderRetiredTable(retired);
        
        // Cerrar modal y mostrar mensaje
        closeRMAModal();
        showToast('Retiro completado con éxito', 'success');
    });

    // Funciones para el modal de agregar tóner
    function showAddTonerModal() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('toner-fecha').value = today;
        const modal = document.getElementById('add-toner-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeAddTonerModal() {
        const modal = document.getElementById('add-toner-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.getElementById('add-toner-form').reset();
    }

    // Manejar envío del formulario de agregar tóner
    document.getElementById('add-toner-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const newToner = {
            element: document.getElementById('toner-elemento').value,
            model: document.getElementById('toner-modelo').value,
            printerModel: document.getElementById('toner-mod-impresora').value,
            color: document.getElementById('toner-color').value,
            location: document.getElementById('toner-ubicacion').value,
            dateReg: document.getElementById('toner-fecha').value,
            status: document.getElementById('toner-estado').value,
            observation: document.getElementById('toner-observacion').value
        };
        
        toners.push(newToner);
        localStorage.setItem('toners_cache', JSON.stringify(toners));
        
        renderTonerTable(toners);
        closeAddTonerModal();
        showToast('Tóner agregado correctamente', 'success');
    });

    // Variables y funciones para el modal de asignar tóner
    let currentTonerIndex = null;
    let currentChangingPrinterIndex = null;

    function showAssignTonerModal(index) {
        currentTonerIndex = index;
        document.getElementById('assign-printer-serial').value = '';
        document.getElementById('assign-counter-bn').value = '';
        document.getElementById('assign-counter-color').value = '';
        const modal = document.getElementById('assign-toner-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeAssignTonerModal() {
        currentTonerIndex = null;
        const modal = document.getElementById('assign-toner-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // Manejar envío del formulario de asignar tóner
    document.getElementById('assign-toner-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (currentTonerIndex === null) return;
        
        const printerSerial = document.getElementById('assign-printer-serial').value.trim().toUpperCase();
        const counterBN = parseFloat(document.getElementById('assign-counter-bn').value) || 0;
        const counterColor = parseFloat(document.getElementById('assign-counter-color').value) || 0;
        
        if (!printerSerial) {
            showToast('Por favor introduce un número de serie válido', 'error');
            return;
        }
        
        // Validar que el serial exista en el módulo de Inventario
        const printerExists = printers.find(p => p.serial.toUpperCase() === printerSerial);
        if (!printerExists) {
            showToast('El número de serie no está registrado en el inventario', 'error');
            return;
        }
        
        // Obtener el modelo de la impresora y su rendimiento
        const model = printerExists.model;
        const yield = tonerYields[model];
        
        if (!yield) {
            showToast('El modelo de impresora no tiene rendimiento de tóner configurado', 'error');
            return;
        }
        
        // Buscar o crear el contador para esta impresora
        let counterIndex = counters.findIndex(c => c.serial.toUpperCase() === printerSerial);
        
        if (counterIndex === -1) {
            // Crear nuevo registro de contador si no existe
            counters.push({
                serial: printerSerial,
                model: model,
                bn: counterBN,
                color: counterColor,
                location: printerExists.city || ''
            });
            counterIndex = counters.length - 1;
        } else {
            // Actualizar contador existente
            counters[counterIndex].bn = counterBN;
            counters[counterIndex].color = counterColor;
        }
        
        // Guardar los cambios en el contador
        localStorage.setItem('counters_cache', JSON.stringify(counters));
        
        // Sincronizar con Google Sheets
        syncCounterToGoogleSheets(counters[counterIndex]);
        
        // Actualizar el tóner con el serial y cambiar estado a "Usado"
        toners[currentTonerIndex].status = 'Usado';
        toners[currentTonerIndex].assignedTo = printerSerial;
        toners[currentTonerIndex].assignedDate = new Date().toLocaleDateString('es-ES');
        
        // Guardar en localStorage
        localStorage.setItem('toners_cache', JSON.stringify(toners));
        
        // Actualizar tablas
        renderTonerTable(toners);
        renderCountersTable(counters);
        renderTable(printers);
        
        // Cerrar modal y mostrar mensaje
        closeAssignTonerModal();
        showToast(`Tóner asignado a impresora ${printerSerial}. Contador actualizado: B/N=${counterBN.toLocaleString()}, Color=${counterColor.toLocaleString()}`, 'success');
    });

    // Funciones para el modal de cambio de tóner
    function showChangeTonerModal(serial) {
        const printerIndex = printers.findIndex(p => p.serial === serial);
        if (printerIndex === -1) {
            showToast('Impresora no encontrada', 'error');
            return;
        }
        currentChangingPrinterIndex = printerIndex;
        const printer = printers[printerIndex];
        
        // Mostrar información del equipo
        document.getElementById('change-toner-serial').textContent = printer.serial;
        document.getElementById('change-toner-model').textContent = printer.model;
        
        // Obtener último contador registrado
        const counterRecords = counters.filter(c => c.serial && c.serial.toUpperCase() === printer.serial.toUpperCase());
        if (counterRecords.length > 0) {
            const latest = counterRecords[counterRecords.length - 1];
            document.getElementById('change-counter-bn').value = latest.bn || 0;
            document.getElementById('change-counter-color').value = latest.color || 0;
        } else {
            document.getElementById('change-counter-bn').value = '';
            document.getElementById('change-counter-color').value = '';
        }
        
        const modal = document.getElementById('change-toner-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeChangeTonerModal() {
        currentChangingPrinterIndex = null;
        const modal = document.getElementById('change-toner-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // Manejar envío del formulario de cambio de tóner
    document.getElementById('change-toner-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (currentChangingPrinterIndex === null) return;
        
        const printer = printers[currentChangingPrinterIndex];
        const counterBN = parseFloat(document.getElementById('change-counter-bn').value) || 0;
        const counterColor = parseFloat(document.getElementById('change-counter-color').value) || 0;
        
        // Obtener el modelo y su rendimiento
        const model = printer.model;
        const yield = tonerYields[model];
        
        if (!yield) {
            showToast('El modelo de impresora no tiene rendimiento de tóner configurado', 'error');
            return;
        }
        
        // Calcular el nuevo contador (ajustar al siguiente múltiplo del rendimiento)
        let newCounterBN = counterBN;
        let newCounterColor = counterColor;
        
        if (yield.black > 0 && counterBN > 0) {
            const tonerChanges = Math.floor(counterBN / yield.black);
            newCounterBN = (tonerChanges + 1) * yield.black;
        }
        
        if (yield.color > 0 && counterColor > 0) {
            const tonerChanges = Math.floor(counterColor / yield.color);
            newCounterColor = (tonerChanges + 1) * yield.color;
        }
        
        // Buscar o crear el contador para esta impresora
        let counterIndex = counters.findIndex(c => c.serial && c.serial.toUpperCase() === printer.serial.toUpperCase());
        
        if (counterIndex === -1) {
            // Crear nuevo registro de contador
            counters.push({
                serial: printer.serial,
                model: model,
                bn: newCounterBN,
                color: newCounterColor,
                location: printer.city || ''
            });
            counterIndex = counters.length - 1;
        } else {
            // Actualizar contador existente con el nuevo valor ajustado
            counters[counterIndex].bn = newCounterBN;
            counters[counterIndex].color = newCounterColor;
        }
        
        // Guardar los cambios en el contador
        localStorage.setItem('counters_cache', JSON.stringify(counters));
        
        // Sincronizar con Google Sheets
        syncCounterToGoogleSheets(counters[counterIndex]);
        
        // Actualizar tablas
        renderCountersTable(counters);
        renderTable(printers);
        
        // Cerrar modal y mostrar mensaje
        closeChangeTonerModal();
        showToast(`Tóner cambiado. Contador ajustado: B/N=${newCounterBN.toLocaleString()}, Color=${newCounterColor.toLocaleString()}. Porcentaje restablecido al 0%`, 'success');
    });

    window.onload = () => {
        // Verificar tema guardado y actualizar icono
        const savedTheme = localStorage.getItem('theme');
        const isDark = savedTheme === 'dark' || (!savedTheme && true); // Por defecto oscuro
        
        if (isDark) {
            document.documentElement.classList.add('dark');
            document.getElementById('dark-mode-icon').innerText = 'light_mode';
        } else {
            document.documentElement.classList.remove('dark');
            document.getElementById('dark-mode-icon').innerText = 'dark_mode';
        }
        
        renderTable(printers);
        // Establecer fecha de registro actual al cargar
        const today = new Date().toISOString().split('T')[0];
        document.querySelector('input[name="dateReg"]').value = today;
        
        // Ocultar loader y mostrar contenido
        setTimeout(() => {
            const loader = document.getElementById('initial-loader');
            const mainContent = document.getElementById('main-content');
            
            loader.style.opacity = '0';
            loader.style.transition = 'opacity 0.3s ease-out';
            
            setTimeout(() => {
                loader.style.display = 'none';
                mainContent.style.opacity = '1';
                mainContent.style.transition = 'opacity 0.3s ease-in';
            }, 300);
        }, 500);
    };
</script>
<!-- Modal de Gráficas -->
<div id="charts-modal" class="hidden fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-7xl max-h-[90vh] overflow-hidden flex flex-col">
        <!-- Header del modal -->
        <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700">
            <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-[32px] text-primary">monitoring</span>
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Gráficas del Inventario</h2>
            </div>
            <button onclick="closeChartsModal()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                <span class="material-symbols-outlined text-[28px]">close</span>
            </button>
        </div>
        
        <!-- Contenido del modal -->
        <div class="flex-1 overflow-y-auto p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Gráfica: Estado de Impresoras -->
                <div class="bg-slate-50 dark:bg-slate-900 rounded-xl p-6">
                    <h3 class="text-lg font-bold mb-4 text-slate-700 dark:text-slate-200">Estado de Impresoras</h3>
                    <div style="height: 250px;">
                        <canvas id="chart-printer-status"></canvas>
                    </div>
                </div>
                
                <!-- Gráfica: Distribución por Área -->
                <div class="bg-slate-50 dark:bg-slate-900 rounded-xl p-6">
                    <h3 class="text-lg font-bold mb-4 text-slate-700 dark:text-slate-200">Distribución por Área</h3>
                    <div style="height: 250px;">
                        <canvas id="chart-by-area"></canvas>
                    </div>
                </div>
                
                <!-- Gráfica: Distribución por Departamento -->
                <div class="bg-slate-50 dark:bg-slate-900 rounded-xl p-6">
                    <h3 class="text-lg font-bold mb-4 text-slate-700 dark:text-slate-200">Distribución por Departamento</h3>
                    <div style="height: 250px;">
                        <canvas id="chart-by-dept"></canvas>
                    </div>
                </div>
                
                <!-- Gráfica: Estado de Escáner -->
                <div class="bg-slate-50 dark:bg-slate-900 rounded-xl p-6">
                    <h3 class="text-lg font-bold mb-4 text-slate-700 dark:text-slate-200">Estado de Escáner</h3>
                    <div style="height: 250px;">
                        <canvas id="chart-scanner-status"></canvas>
                    </div>
                </div>
                
                <!-- Gráfica: Estado de SLNX -->
                <div class="bg-slate-50 dark:bg-slate-900 rounded-xl p-6">
                    <h3 class="text-lg font-bold mb-4 text-slate-700 dark:text-slate-200">Estado de SLNX</h3>
                    <div style="height: 250px;">
                        <canvas id="chart-slnx-status"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html>
